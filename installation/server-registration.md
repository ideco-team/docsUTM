# Регистрация сервера 

{% hint style="info" %}
Для активации лицензии необходима обязательная регистрация сервера в [личном кабинете](https://my.ideco.ru/#/login/?next=/utm/license/).
{% endhint %}

## Онлайн-регистрация

{% hint style="warning" %}
Для привязки лицензии сервер должен иметь выход в интернет.
{% endhint %}

Шаги онлайн-регистрации сервера и привязки лицензии:

1\. Перейдите в веб-интерфейс Ideco NGFW в раздел **Управление сервером -> Лицензия** и нажмите **Зарегистрировать**:

![](/.gitbook/assets/initial-setup10.png)

2\. В открывшемся окне перейдите по ссылке **Зарегистрировать новый сервер**, выберите компанию и нажмите **Добавить**. После добавления нажмите **Обновить информацию о лицензии** для проверки состояния лицензии:

![](/.gitbook/assets/initial-setup11.gif)

## Оффлайн регистрация

Шаги оффлайн регистрации сервера и привязки лицензии:

1\. Привяжите сервер к личному кабинету в [MY.IDECO](https://my.ideco.ru/):
* Перейдите в веб-интерфейс Ideco NGFW в раздел **Управление сервером -> Терминал**;
* Выполните команду `cat /usr/share/ideco/license-backend/hwid`;
* Скопируйте hwid сервера. Пример: `t7m7H137w-pQXYjXuHmYbLnJw3YyxJAg5wl9FfARlh`;

2\. Обратитесь к вашему менеджеру для предоставления лицензии. 

3\. Перейдите в личный кабинет [MY.IDECO](https://my.ideco.ru/) в раздел **NGFW -> Оффлайн** и заполните поле **HWID** скопированными на шаге 1 данными.

4\. Перейдите в раздел **NGFW -> Лицензирование** и нажмите **Привязать лицензию** рядом с нужным сервером. Пример наименования сервера для оффлайн-регистрации: `UTM (UTM Unknown)`.  

Если была выбрана лицензия, не подходящая для оффлайн регистрации сервера, то появится ошибка:

![](/.gitbook/assets/initial-setup13.png)

5\. Перейдите в раздел **NGFW -> Оффлайн** и введите в соответствующие поля цифрами мажорный номер версии и номер лицензии:

![](/.gitbook/assets/initial-setup12.png)

6\. Нажмите **Получить ссылки** и сохраните файлы конфигураций, нажав на появившиеся ссылки:
* `license.json` - информация о лицензии;
* `geoip-<timestamp>.mmdb` - база для работы модуля **Предотвращение вторжений**;
* `iplist-<timestamp>.tar.gz` - база соответствия подсетей и стран, в которые они входят;
* `simple.tgz` - правила фильтрации для модуля **Предотвращение вторжений**;
* `sky-from-0-to-<timestamp>.sst` - база для работы модуля **Контент-фильтр**.

7\. Добавьте конфигурационный файл c информацией о лицензии в Ideco NGFW:
* Перейдите в раздел **Управление сервером -> Терминал**;
* Загрузите полученный файл `license.json` на сервер Ideco UTM в директорию `/var/cache/ideco/license-backend/`;
* Перезапустите сервис лицензий командой `systemctl restart ideco-license-backend.service`;
* Перейдите в раздел **Управление сервером - Лицензия** и убедитесь, что лицензия установлена.

## Оффлайн-обновление баз модулей безопасности

Для обновления баз модулей безопасности при оффлайн-регистрации сервера выполните действия:

1\. Сохраните скрипты запуска обновления баз модулей безопасности в папку с файлами, скачанными на шаге 6:

{% file src="/scripts/content_filter.py";base64,Cg==" name="content_filter.py" %}
{% file src="/scripts/geoip.py";base64,Cg==" name="geoip.py" %}
{% file src="/scripts/iplist.py";base64,Cg==" name="iplist.py" %}
{% file src="/scripts/suricata.py";base64,Cg==" name="suricata.py" %}

2\. Обновите базы модулей безопасности:

* Перейдите в директорию `scp -r <путь до папки со скачанными файлами> administrator@<IP-адрес NGFW>:~/`;
* Подключитесь к серверу по SSH `ssh administrator@<IP-адрес NGFW>`;
* Перед обновлением модулей перейдите в директорию `cd ~/<название папки со скачанными файлами>`;
* Обновите базы модулей безопасности, выполнив команды:
  * Базы модуля **Предотвращения вторжений** - `python3 geoip.py <geoip-<timestamp>.mmdb>`;
  * Базы соответствия подсетей и стран - `python3 iplist.py <iplist-<timestamp>.tar.gz>`;
  * Правила фильтрации модуля **Предотвращение вторжений** - `python3 suricata.py simple.tgz`;
  * Базы модуля **Контент-фильтр** - `python3 content_filter.py <sky-from-0-to-<timestamp>.sst>`.
