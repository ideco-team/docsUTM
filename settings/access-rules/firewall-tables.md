# Таблицы файрвола (FORWARD, DNAT, INPUT и SNAT)

{% hint style="success" %}
Правила в таблицах имеют приоритет сверху вниз (т. е. верхнее правило приоритетнее нижнего). \
По умолчанию используется политика **РАЗРЕШИТЬ**. Если не будут созданы запрещающие правила, все порты и протоколы для пользователей будут разрешены.
{% endhint %}

{% hint style="warning" %}
Не рекомендуем создавать FORWARD- и INPUT-правила, запрещающие весь трафик, без предварительного создания разрешающих правил. Это может привести к блокировке доступа к серверу и его функциям.

Для предотвращения блокировки клиентского HTTP/HTTPS-трафика необходимо:

* Создать правило, разрешающее трафик от пользователя;
* Создать правило, разрешающее трафик для специальной зоны источника **Исходящий трафик устройства**.

{% endhint %}

Для удобства управления правилами в интерфейсе они разбиты на четыре таблицы: FORWARD, DNAT, INPUT и SNAT.

{% hint style="info" %}
Не рекомендуется при создании правил файрвола с протоколом TCP или UDP указывать порт источника. Это связано с тем, что:

* Порт источника выбирается случайно, и лишь некоторые приложения работают с фиксированным портом;
* Порт источника может подмениться другим при прохождении пакета через NAT.
{% endhint %}

При создании правил **Файрвола** в качестве **зоны источника** или **зоны назначения** можно выбрать **Специальные** типы:

* **Внешние интерфейсы** - все интерфейсы, используемые для подключения к интернету;  
* **Внешние Ethernet-интерфейсы** - все Ethernet-интерфейсы, используемые для подключения к интернету;
* **Внешние VPN-интерфейсы** - все туннельные интерфейсы для подключения к интернету (Ethernet+PPPoE, Ethernet+PPTP, Ethernet+L2TP);
* **IPsec-интерфейсы** - все IPsec-интерфейсы, используемые для site-to-site-подключений к удаленным офисам;
* **Локальные интерфейсы** - все интерфейсы, используемые для подключения к клиентам в локальной сети;
* **Исходящий трафик устройства** - используется для фильтрации исходящего трафика самого устройства Ideco NGFW; 
* **Клиентский VPN-трафик** - используется для фильтрации трафика, идущего от клиентов, подключившихся к NGFW по VPN;
* **Любой** - не фильтровать трафик по какому-либо типу интерфейса или зоны.

При наличии большого количества правил в таблицах **Файрвола** воспользуйтесь кнопкой **Фильтры**.

## FORWARD

Правила в данной таблице действуют на трафик, проходящий между зонами сервера, т. е. сетью интернет и локальной сетью, а также между локальными сетями. Это основная таблица, в которую могут быть добавлены правила, ограничивающие трафик пользователей.

## DNAT (перенаправление портов)

Правила этой таблицы используются для прямого перенаправления портов с внешней зоны на определенные ресурсы во внутренней зоне. Такие правила часто называются правилами проброса портов (port forwarding, port-mapping).

## INPUT

Таблица для правил входящего трафика на зоны сервера. Как правило, это трафик для служб сервера (например, почтового сервера).

## SNAT

Таблица пользовательских правил для управления трансляцией сетевых адресов.

Чтобы активировать автоматический SNAT для локальных сетей, переведите соответствующую опцию в положение **Включен**. Автоматический SNAT подменяет адреса источников только для следующих диапазонов: `192.168.0.0/16`, `172.16.0.0/12` и `10.0.0.0/8`. 

Чтобы подменять адреса источников для других диапазонов или допустить устройства в сеть без сетевой трансляции адресов (правилом "не SNAT"), создайте правило SNAT, нажав на кнопку **Добавить**. Пользовательские правила SNAT имеют приоритет над автоматическим SNAT для локальных сетей.

## Создание правил

Для создания правила в нужной таблице нажмите кнопку **Добавить** в левом верхнем углу экрана.

Укажите необходимые параметры и действия правила и нажмите кнопку **Добавить**. Правило будет добавлено в конец списка. Если необходимо, измените его приоритет кнопками ![up-down.png](/.gitbook/assets/icon-up-down.png).

{% hint style="info" %}
Если в строке **Протокол** выбрать из списка параметр **Любой**, то правило будет действовать на весь трафик.
{% endhint %}

{% hint style="danger" %}

Важные моменты при создании правил:

* При создании правил для фильтрации веб-трафика из локальных сетей (80, 443 TCP-порты) для полноценной работы правила в поле **Зона источника** должен указываться объект **Любой**. Если будет указан иной объект, то правило не будет обрабатывать веб-трафик;
* Не используйте зону, указанную в разделе **VPN-подключения -> Основное**, для блокировки TCP. В противном случае HTTP- и HTTPS-трафик через эту зону не будет заблокирован.
{% endhint %}

<details>

<summary>Создание FORWARD-правила</summary>

![](/.gitbook/assets/firewall19.png)

* **Протокол** - протокол передачи данных (UDP/TCP/ICMP/GRE/ESP/AH, либо **Любой**).

**Источник**

* **Зона источника** - интерфейс или группа интерфейсов, из которых приходит трафик. Можно выбрать отдельные **Сетевые интерфейсы**, [созданные пользователем зоны](/settings/access-rules/aliases.md) или **Специальные** типы;
* **Инвертировать источник** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
* **Адрес** - IP-адрес источника трафика (src), проходящего через шлюз. В этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов файрвол автоматически это учтет);
* **Порты источника** - указываются при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md). **Указывать не рекомендуем**;
* **HIP-профили** - профиль, соответствующий устройству, от которого исходит трафик.

**Назначение**

* **Зона назначения** - интерфейс или группа интерфейсов, в которые входит трафик. Можно выбрать отдельные **Сетевые интерфейсы**, созданные пользователем зоны или **Специальные типы**;
* **Инвертировать назначение** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
* **Адрес** - в этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов, файрвол автоматически это учтет);
* **Порты назначения** - указываются при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md).

**Действия**

* **Запретить** - запрещает трафик;
* **Разрешить** - разрешает трафик или направляет его в модули фильтрации трафика.

**Профили фильтрации трафика**

* **Контроль приложений** - выберите профиль [Контроля приложений](/settings/security-profiles/application-control/README.md), которым требуется фильтровать трафик;
* **Предотвращение вторжений** - выберите профиль системы [Предотвращения вторжений](/settings/security-profiles/README.md), которым требуется фильтровать трафик.

**Дополнительно**

* **Включить правило** - опция позволяет выбрать, будет ли правило включено или выключено при создании. По умолчанию правило выключено;
* **Время действия** - время действия правила. Указываются временные промежутки (например, **рабочее время**), которые определяются в [Объектах](aliases.md);
* **Комментарий** - произвольный текст, поясняющий цель действия правила. Значение не должно быть длиннее 255 символов.

</details>

<details>

<summary>Создание DNAT-правила</summary>

![](/.gitbook/assets/firewall20.png)

* **Протокол** - протокол передачи данных (UDP/TCP/ICMP/GRE/ESP/AH, либо **Любой**).

**Источник**

* **Зона источника** - интерфейс или группа интерфейсов, из которых приходит трафик. Можно выбрать отдельные **Сетевые интерфейсы**, [созданные пользователем зоны](/settings/access-rules/aliases.md) или **Специальные** типы:
    * **Внешние интерфейсы** - все интерфейсы, используемые для подключения к интернету;  
    * **Внешние Ethernet-интерфейсы** - все Ethernet-интерфейсы, используемые для подключения к интернету;
    * **Внешние VPN-интерфейсы** - все туннельные интерфейсы для подключения к интернету (Ethernet+PPPoE, Ethernet+PPTP, Ethernet+L2TP);
    * **IPsec-интерфейсы** - все IPsec-интерфейсы, используемые для site-to-site-подключений к удаленным офисам;
    * **Локальные интерфейсы** - все интерфейсы, используемые для подключения к клиентам в локальной сети;
    * **Исходящий трафик устройства** - используется для фильтрации исходящего трафика самого устройства Ideco NGFW; 
    * **Клиентский VPN-трафик** - используется для фильтрации трафика, идущего от клиентов, подключившихся к NGFW по VPN;
    * **Любой** - не фильтровать трафик по какому-либо типу интерфейса или зоны.
* **Инвертировать источник** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
* **Адрес** - IP-адрес источника трафика (src), проходящего через шлюз. В этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов файрвол автоматически это учтет);
* **Порты источника** - указываются при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md). **Указывать не рекомендуем**.

**Назначение**

* **Инвертировать назначение** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
* **Адрес** - в этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов, файрвол автоматически это учтет);
* **Порты назначения** - указываются при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md);
* **Сменить IP-адрес назначения** - при указании диапазона адресов пакет будет перенаправлен на любой из них;
* **Сменить порт назначения** - при указании диапазона портов пакет будет перенаправлен в порт с тем же номером, на который он пришел, если этот порт попадает в указанный диапазон.

**Действия**

* **DNAT** - транслирует адреса назначения, тем самым позволяет перенаправить входящий трафик. Ниже в поле **Изменить IP-адрес назначения** можно указать один IP-адрес или диапазон (при указании диапазона IP-адресов пакет будет перенаправлен на любой из них). Аналогично, если при создании правила были указаны протоколы TCP или UDP, то появится поле **Сменить порт назначения**. С помощью этой возможности можно прозрачно переадресовать входящий трафик на другой адрес или порт;
* **Не производить DNAT** - отменяет действие DNAT для трафика, удовлетворяющего критериям правила.

**Дополнительно**

* **Включить правило** - опция позволяет выбрать, будет ли правило включено или выключено при создании. По умолчанию правило выключено;
* **Время действия** - время действия правила. Указываются временные промежутки (например, **рабочее время**), которые определяются в [Объектах](aliases.md);
* **Комментарий** - произвольный текст, поясняющий цель действия правила. Значение не должно быть длиннее 255 символов.

</details>

<details>

<summary>Создание INPUT-правила</summary>

![](/.gitbook/assets/firewall21.png)

* **Протокол** - протокол передачи данных (UDP/TCP/ICMP/GRE/ESP/AH, либо **Любой**).

**Источник**

* **Зона источника** - интерфейс или группа интерфейсов, из которых приходит трафик. Можно выбрать отдельные **Сетевые интерфейсы**, [созданные пользователем зоны](/settings/access-rules/aliases.md) или **Специальные** типы:
    * **Внешние интерфейсы** - все интерфейсы, используемые для подключения к интернету;  
    * **Внешние Ethernet-интерфейсы** - все Ethernet-интерфейсы, используемые для подключения к интернету;
    * **Внешние VPN-интерфейсы** - все внешние VPN-интерфейсы (PPPoE, PPTP, L2TP), используемые для подключения к интернету;
    * **IPsec-интерфейсы** - все IPsec-интерфейсы, используемые для site-to-site-подключений к удаленным офисам;
    * **Локальные интерфейсы** - все интерфейсы, используемые для подключения к клиентам в локальной сети;
    * **Исходящий трафик устройства** - используется для фильтрации исходящего трафика самого устройства Ideco NGFW; 
    * **Клиентский VPN-трафик** - используется для фильтрации трафика, идущего от клиентов, подключившихся к NGFW по VPN;
    * **Любой** - не фильтровать трафик по какому-либо типу интерфейса или зоны.
* **Инвертировать источник** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
* **Адрес** - IP-адрес источника трафика (src), проходящего через шлюз. В этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов файрвол автоматически это учтет);
* **Порты источника** - указываются при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md). **Указывать не рекомендуем**.

**Назначение**

* **Инвертировать назначение** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
* **Адрес** - в этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов, файрвол автоматически это учтет);
* **Порт назначения** - указывается при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md).

**Действия**

* **Запретить** - запрещает трафик;
* **Разрешить** - разрешает трафик или направляет его в модули фильтрации трафика.

**Профили фильтрации трафика**

* **Контроль приложений** - выберите профиль [Контроля приложений](/settings/security-profiles/application-control/README.md), которым требуется фильтровать трафик;
* **Предотвращение вторжений** - выберите профиль системы [Предотвращения вторжений](/settings/security-profiles/README.md), которым требуется фильтровать трафик.

**Дополнительно**

* **Включить правило** - опция позволяет выбрать, будет ли правило включено или выключено при создании. По умолчанию правило выключено;
* **Время действия** - время действия правила. Указываются временные промежутки (например, **рабочее время**), которые определяются в [Объектах](aliases.md);
* **Комментарий** - произвольный текст, поясняющий цель действия правила. Значение не должно быть длиннее 255 символов.

</details>

<details>

<summary>Создание SNAT-правила</summary>

![](/.gitbook/assets/firewall22.png)

* **Протокол** - протокол передачи данных (UDP/TCP/ICMP/GRE/ESP/AH, либо **Любой**).

**Источник**

* **Инвертировать источник** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Источник**;
* **Адрес** - IP-адрес источника трафика (src), проходящего через шлюз. В этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов файрвол автоматически это учтет);
* **Порты источника** - указываются при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md). **Указывать не рекомендуем**;
* **Сменить IP-адрес источника** - заполняется, только если на сетевом интерфейсе несколько IP-адресов и необходим SNAT от конкретного IP-адреса.

**Назначение**

* **Зона назначения** - интерфейс или группа интерфейсов, в которые входит трафик. Можно выбрать отдельные **Сетевые интерфейсы**, [созданные пользователем зоны](/settings/access-rules/aliases.md) или **Специальные** типы:
    * **Внешние интерфейсы** - все интерфейсы, используемые для подключения к интернету;  
    * **Внешние Ethernet-интерфейсы** - все Ethernet-интерфейсы, используемые для подключения к интернету;
    * **Внешние VPN-интерфейсы** - все внешние VPN-интерфейсы (PPPoE, PPTP, L2TP), используемые для подключения к интернету;
    * **IPsec-интерфейсы** - все IPsec-интерфейсы, используемые для site-to-site-подключений к удаленным офисам;
    * **Локальные интерфейсы** - все интерфейсы, используемые для подключения к клиентам в локальной сети;
    * **Исходящий трафик устройства** - используется для фильтрации исходящего трафика самого устройства Ideco NGFW; 
    * **Клиентский VPN-трафик** - используется для фильтрации трафика, идущего от клиентов, подключившихся к NGFW по VPN;
    * **Любой** - не фильтровать трафик по какому-либо типу интерфейса или зоны.
* **Инвертировать назначение** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
* **Адрес** - в этом поле могут быть указаны IP-адреса, диапазоны IP-адресов, сети, домены (раздел [Объекты](aliases.md)), страны или пользователи и группы (при смене их IP-адресов, файрвол автоматически это учтет);
* **Порты назначения** - указываются при создании правила с протоколами TCP/UDP. Это может быть отдельный порт, список портов или диапазон портов, определенных в [Объектах](aliases.md).

**Действия**

* **SNAT** - транслирует адреса источника;
* **Не производить SNAT** - отменяет действие SNAT для трафика, удовлетворяющего критериям правила.

**Дополнительно**

* **Включить правило** - опция позволяет выбрать, будет ли правило включено или выключено при создании. По умолчанию правило выключено;
* **Время действия** - время действия правила. Указываются временные промежутки (например, **рабочее время**), которые определяются в [Объектах](aliases.md);
* **Комментарий** - произвольный текст, поясняющий цель действия правила. Значение не должно быть длиннее 255 символов.

</details>

{% hint style="danger" %}
С 18 версии NGFW правила Файрвола, которые блокировали трафик за счет перехвата DNS в предыдущих версиях, не смогут его блокировать. Чтобы это исправить, создайте и включите правила с профилями IPS и DPI в разделе **Правила трафика -> Файрвол -> INPUT**.
{% endhint %}
