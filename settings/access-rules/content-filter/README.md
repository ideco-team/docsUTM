---
description: Контентная фильтрация реализована на основе данных о веб-трафике, получаемых от модуля проксирования веб-трафика. Позволяет блокировать доступ к различным интернет-ресурсам.
---

# Контент-фильтр

{% hint style="success" %}
Название службы раздела _Контент-фильтра_: `ideco-content-filter-backend.service`. \
Список имен служб для других разделов доступен по [ссылке](/settings/server-management/terminal.md).

Для записи логов поставьте флаг строке **Включить журналирование** в разделе **Сервисы -> Прокси -> Основное**.
{% endhint %}

**Контент-фильтр** проверяет наличие сайта, который хочет открыть пользователь, в списках ресурсов Ideco NGFW. Если адрес находится в этих списках, то применяются настроенные правила фильтрации.

{% hint style="info" %}
HTTPS-сайты без расшифровки трафика фильтруются только по домену (а не по полному URL), правила категории **Файлы** на них также применить невозможно. Для полной фильтрации HTTPS создайте правила расшифровки HTTPS-трафика нужных категорий.
{% endhint %}

{% hint style="warning" %}
Для фильтрации по IP-адресам используйте [Файрвол](/settings/access-rules/firewall.md).

Фильтрация по IP-адресам в **Контент-фильтре** будет работать:

* Для HTTP-запросов к IP-адресам напрямую;
* Для расшифрованных HTTPS-запросов к IP-адресам;
* Для HTTPS-запросов к ресурсам, сертификат которых содержит IP-адрес в поле Common Name сертификата.

**Файрвол** анализирует пакет на сетевом уровне (L3), а **Контент-фильтр** - на прикладном уровне (L7). Информация об IP-адресах на прикладном уровне (L7) неточная, поэтому для блокировки IP-адресов нужно использовать **Файрвол**.

{% endhint %}

Контент-фильтр состоит из четырех вкладок: правила, пользовательские категории, морфологические словари и настройки.

## Правила

Для добавления правила **Контент-фильтра** перейдите в раздел **Правила трафика -> Контент-фильтр -> Правила**, нажмите **Добавить** и заполните поля:

![](/.gitbook/assets/content-filter26.png)

* **Название** - название добавляемого правила.

* **Применяется для** - пользователь или группа пользователей, IP-адреса или список IP-объектов, для которых применяется правило.

* **Категории сайтов** - поле для выбора предустановленной или пользовательской категории, перечень ресурсов, на которые распространяется действие правила.

{% hint style="info" %}
Для расшифрованного трафика при создании и редактировании правила **Контент-фильтра** доступны более детальные настройки доступа к ресурсам с помощью HTTP-методов запроса и MIME-типов. Если поля остаются пустыми, проверка по ним не осуществляется.
{% endhint %}

* **HTTP-методы** - методы запроса, которые будут применяться для всего HTTP- или HTTPS-трафика. Доступные методы:
  * GET - извлечение данных ресурса, содержащих тело ответа;
  * HEAD - извлечение данных ресурса, не содержащих тело ответа;
  * POST - отправка данных на определенный ресурс;
  * PUT - замена текущих значений ресурса;
  * DELETE - удаление ресурса;
  * OPTIONS - описание параметров соединения с ресурсом;
  * PATCH - частичное изменение ресурса;
  * TRACE - вызов возвращаемого тестового сообщения с ресурса;
  * CONNECT - установка соединения с ресурсом.

* **MIME-типы** - форматы содержимого, к которым будет применяться правило. Форматы объединены в группы в зависимости от типа контента. Например, Audio (mp4, wav, wave и др.), Video (jpeg, mpeg, jmp и др.), Image (bmp, gif, png и др.). Настройки можно применить как к группе форматов, так и каждому формату отдельно.

* **Действия**:
  * **Запретить** - запрещает трафик;
  * **Разрешить** - разрешает трафик или направляет его в модули фильтрации трафика;
  * **Перенаправить на** - позволяет указать URL, на который будет перенаправлен расшифрованный трафик;
  * **Расшифровать** - расшифровывает трафик с HTTPS сайтов.

{% hint style="info" %}
Если выбрать действие **Перенаправить на**, то нужно создать аналогичное правило с действием **Расшифровать** и поместить его выше перенаправляющего правила.
{% endhint %}

* **Дополнительно**:
  * **Время действия** - время действия правила. Указываются временные промежутки (например, **Рабочее время**), которые определяются в [Объектах](aliases.md). По умолчанию установлено значение **Любой**;
  * **Комментарий** - произвольный текст, поясняющий цель действия правила. Значение не должно быть длиннее 255 символов.

Для подтверждения создания правила нажмите **Добавить**.

Помимо возможности добавления правил Контент-фильтра, вкладка содержит:

* **Строку поиска категории URL для категоризации**. Позволяет по URL найти категорию, в которой этот URL состоит, для дальнейшего создания правила; 
* **Таблицу созданных правил**. Правила в таблице действуют сверху вниз. То есть, если вверху расположено правило, разрешающее контент, а внизу - запрещающее этот контент, будет работать только верхнее правило. Для перемещения правил используйте стрелки ![](/.gitbook/assets/icon-up.png) и ![](/.gitbook/assets/icon-down.png):

![](/.gitbook/assets/content-filter7.png)

## Пользовательские категории

Категории сайтов делятся на четыре вида:

1\. **Пользовательские**. Включают категории, созданные на вкладке **Пользовательские категории**;

2\. **Специальные**. Включает 4 категории: все запросы, все категоризированные запросы, все некатегоризированные запросы и запросы с прямыми обращениями по IP-адресам;

3\. **Расширенные**. Правила, включающие расширенные категории, работают только с включенной опцией **Расширенная база категорий** на вкладке **Настройки**;

4\. **Файлы**. Восемь сформированных категорий файлов, блокируемых по расширениям и MIME-type. Предустановленные группы файлов (Исполняемые файлы, Архивы, Видеофайлы, Аудиофайлы, Flash-видео, Active-X, Torrent-файлы, Документы) нельзя редактировать. Работа по фильтрации HTTPS-трафика по этому типу категорий возможна только при его расшифровке.

На одноименной вкладке создаются собственные категории правил.

![](/.gitbook/assets/content-filter8.png)

Подробное описание **расширенных** и **специальных** категорий читайте в статье [Описание категорий контент фильтра](custom-categories.md).

При создании пользовательской категории потребуется ввести URL (одно или несколько значений через пробел). Используйте следующие маски:
* `test.ru`;
* `www.test.ru`;
* `http://www.test.ru/` или `https://www.test.ru/`;
* `https://www.test.ru:8080 `;
* `https://xn--41a.xn-p1acf/` - punycode;
* `*.test.ru` - для всех доменов третьего и выше уровней. Важно: такая маска не включает домен второго уровня test.ru, чтобы его включить достаточно указать домен test.ru (все его поддомены также попадут под это правило);
* `1.1.1.1` - любой IP-адрес.

{% hint style="danger" %}
При создании пользовательских категорий обратите внимание на алгоритм работы **Контент-фильтра**.

Если создать пользовательскую категорию с доменом domain.ru, которая используется в правиле **Контент-фильтра**, то это правило будет корректно работать для domain.ru, www.domain.ru и *.domain.ru.

Однако если создать еще одну пользовательскую категорию с таким же доменом (например, www.domain.ru или *.domain.ru), то правило с пользовательской категорией domain.ru перестанет работать для доменов www.domain.ru и *.domain.ru, **даже если эта созданная категория не используется ни в одном правиле**.

{% endhint %}

{% hint style="info" %}
Если URL или домен содержит специальные символы (。или •), оставьте их в исходном виде. Адрес будут автоматически закодирован в формат punycode.
{% endhint %}

## Морфологические словари

На вкладке **Морфологические словари** создаются правила для проведения морфологического анализа сайтов. Если в тексте анализируемого сайта содержится достаточное для блокировки количество предварительно заданных слов и словосочетаний, доступ к ресурсу блокируется.

Опция **Морфологический анализ** включается в левом верхнем углу вкладки **Морфологические словари**:

![](/.gitbook/assets/content-filter20.png)

При этом морфологический анализ проводится только с использованием включенных словарей. Если ни один словарь не включен, морфологический анализ не проводится.

{% hint style="info" %}
Проверка морфологическими словарями распространяется на весь расшифрованный трафик, поэтому для работы морфологического анализа необходимо создать в **Контент-фильтре** правило расшифровки трафика.
{% endhint %}

По умолчанию в таблицу добавлены четыре словаря, которые нельзя отредактировать или удалить:
* Нецензурная лексика;
* Порнография;
* Список материалов, запрещенных Минюст РФ;
* Терроризм, экстремизм.

По умолчанию предустановленные словари отключены.

Для создания морфологического словаря выполните действия:

1\. Перейдите в раздел **Правила трафика -> Контент-фильтр -> Морфологические словари** и нажмите **Добавить**.

2\. На вкладке **Описание** введите название словаря и комментарий:

![](/.gitbook/assets/content-filter21.png)

3\. На вкладке **Слова** добавьте слова для блокировки трафика вручную или загрузите из файла:

![](/.gitbook/assets/content-filter22.png)

При добавлении слов вручную:
* Введите значение в поле **Пороговый вес**.

{% hint style="info" %}
**Пороговый вес** - общий вес указанных в настройках словаря слов (целое число от 0 до 2 147 483 648). Если при проверке сайта общий вес найденных на нем слов превысит пороговый, доступ к сайту будет заблокирован. 
{% endhint %}

* Нажмите **Добавить слова**. 
* Заполните поля **Слово/словосочетание** и **Вес** при добавлении каждого слова:

![](/.gitbook/assets/content-filter23.png)

При загрузке слов из файла нажмите **Добавить из файла** и выберите загружаемый файл. В один словарь можно загружать несколько файлов. В этом случае дублирующиеся слова будут удалены, останется только одно вхождение с установленным весом. Значение в поле **Пороговый вес** указывается автоматически.

Требования к загрузке из файла:
* Формат файла - CSV, кодировка - UTF-8;
* В одной строке должно быть одно слово или словосочетание и вес, разделенные точкой с запятой:

<details>

<summary>Пример</summary>

```
слово;20
словосочетание;20
```

</details>

Если вес слов не указан, по умолчанию применяется значение 20.
В случае неудачной загрузки файла появится окно с уведомлением **Файл не соответствует требованиям**.

При **Пороговом значении** = 100 доступ к сайту будет заблокирован, если на сайте 5 и более раз упоминается "слово" и/или "словосочетание".

4\. Для сохранения настроек нажмите **Добавить словарь**.

Результат морфологического анализа представлен в разделе **Отчеты и журналы -> Журнал веб-доступа**. В журнале также отображаются дата и время, причина запрета, название правила, название морфологического словаря, IP источника и имя пользователя:

![](/.gitbook/assets/content-filter25.png)

## Настройки

Если включить опцию **Расширенная база категорий**, то будет включена работа более 140 категорий, автоматически обновляемых сервером. Эти категории работают только при активной подписке на обновления в коммерческих редакциях:

![](/.gitbook/assets/content-filter17.png)

{% hint style="info" %}
Если отключить опцию **Расширенная база категорий**, то все правила, включающие в себя расширенные категории, перестанут срабатывать.
{% endhint %}

На вкладке **Настройки** можно настроить дополнительные параметры фильтрации:

* **Блокировать протоколы QUIC и HTTP/3.** Протокол, используемый современными браузерами для доступа к некоторым ресурсам (например, Google, YouTube). Рекомендуется блокировать его, т. к. иначе фильтрация ресурсов, работающих по этому протоколу, будет невозможна;
* **Безопасный поиск.** Принудительно включает безопасный поиск в поисковых системах (Google, Yandex, YouTube, Yahoo, Bing, Rambler). **Для работы этой функции нужно включить HTTPS-фильтрацию методом подмены сертификата для данных ресурсов**.

![](/.gitbook/assets/content-filter9.png)

Если для повторного шифрования требуется использовать сертификат, отличный от корневого в NGFW, загрузите нужный сертификат в разделе **Сервисы -> Сертификаты -> Загруженные сертификаты** и выберите его для повторного шифрования:

![](/.gitbook/assets/content-filter10.png)

## Применение правил

{% hint style="info" %}
Процесс блокировки ресурсов, взаимодействующих с чат-ботами, описан в [статье](/recipes/popular-recipes/block-chat-bot.md).
{% endhint %}

<details>

<summary>Пример настройки HTTP-метода</summary>

**Пример**. Необходимо запретить всем пользователям отправлять данные на запрещенные сайты. 

Перейдите в раздел **Правила трафика -> Контент-фильтр -> Правила** и нажмите **Добавить**. Заполните поля, как на скриншоте:

![](/.gitbook/assets/content-filter27.png)

В поле **Категории сайтов** укажите предварительно созданную пользовательскую категорию **Запрещенные сайты**. При сохранении правила сайты откроются, если трафик не заблокирован другим правилом, но пользователь не сможет отправить данные (например, форму обратной связи).

</details>

<details>

<summary>Пример настройки MIME-типов</summary>

**Пример**. Необходимо запретить конкретному пользователю (например, User1) воспроизводить видеоконтент на запрещенных сайтах. 

Перейдите в раздел **Правила трафика -> Контент-фильтр -> Правила** и нажмите **Добавить**. Заполните поля, как на скриншоте:

![](/.gitbook/assets/content-filter28.png)

В поле **Категории сайтов** укажите предварительно созданную пользовательскую категорию **Запрещенные сайты**. В поле **MIME-типы** выберите все форматы группы **Video**. Примените действие правила **Запретить**. При сохранении правила сайт откроется, если трафик не заблокирован другим правилом, но видеоконтент не воспроизведется.

</details>

<details>

<summary>Применение правил фильтрации для пользователей</summary>

Правила применяются сверху вниз в порядке следования в таблице до первого совпадения. Таким образом, если вышестоящим правилом будет разрешен какой-то ресурс для определенной группы пользователей, то правила ниже применяться не будут. Так можно создавать гибкие настройки фильтрации, исключая нужных пользователей вышестоящими правилами из правил блокировки. Аналогичным образом действуют правила расшифровки HTTPS.

В столбце **Управление** можно активировать или деактивировать правило, менять его приоритет, редактировать и удалять. Правила контентной фильтрации применяются сразу после их создания или включения.

![](/.gitbook/assets/content-filter1.gif)

Чтобы создать новое правило, нажмите **Добавить** в левом верхнем углу над таблицей.

Заполните следующие поля:

![](/.gitbook/assets/content-filter11.png)

* **Название** - наименование правила в списке. Значение не должно быть длиннее 42 символов;
* **Применяется для** - можно выбрать объекты типа: пользователь, группа пользователей, IP-адрес, диапазон IP-адресов, подсеть, список IP-адресов или специальный объект **Превышена квота** (в этот объект попадают пользователи, превысившие квоту по трафику).
* **Категории сайтов** - пользовательские, специальные и расширенные категории веб-ресурсов;
* **Действие** - действие данного правила на веб-запросы. Можно запретить, разрешить или расшифровать HTTPS-трафик.
* Также можно дополнительно указать **Время действия** правила.

</details>

<details>

<summary>Диагностика</summary>

Если правила контентной фильтрации не действуют, проверьте следующие параметры в настройках:

1\. IP-адрес компьютера пользователя должен соответствовать его адресу в авторизации (раздел **Мониторинг - Авторизованные пользователи**), пользователь должен находиться в нужной группе, на которую назначено правило.

2\. IP-адрес пользователя и ресурса, к которому он обращается, не должен входить в исключения прокси-сервера.

3\. Проверьте правильность категоризации ресурса, к которому обращаетесь, в поле **URL для категоризации** на вкладке **Правила**:

![](/.gitbook/assets/content-filter2.gif)

<!-- Для этого вставьте в поле ссылку на ресурс, который требуется категоризировать, и нажмите **Найти категории**. Категории, в которые входит URL, отобразатся ниже. -->

**Если сайт неправильно категоризирован, воспользуйтесь формой обратной связи [SkyDNS](https://www.skydns.ru/feedback/).**

4\. В браузере и на компьютере пользователя не используются функции или плагины VPN, не прописаны сторонние прокси-серверы.

5\. Проверить настройки контентной фильтрации по блокировке опасных и потенциально опасных файлов можно с помощью сервиса [security.ideco.ru](https://security.ideco.ru).

</details>

<details>

<summary>Блокировка загрузки файлов в файлообменники</summary>

Блокирование этой категории требует особой настройки правил Контент-фильтра. В случае с файлообменниками (Google Drive, Яндекс.Диск, облако Mail.ru, Dropbox.com) расшифровки трафика категорий *Файлообменники*, *Файловые хранилища*, *Файловые архивы* и *Загрузка файлов в файлообменники* может быть недостаточно.

Чтобы заблокировать загрузку файлов в облака через браузер, выполните действия:

1\. Включите **Блокировку протоколов Quic/HTTP3** на вкладке **Контент-фильтр -> Настройки**:

  ![](/.gitbook/assets/content-filter.png)

2\. Создайте пользовательскую категорию для расшифровки трафика, указав домены нужных файлообменников:

  ![](/.gitbook/assets/content-filter1.png)

  Для указания доменов используйте маски: `*.cloud.mail.ru`, `cloud.mail.ru/home`, `*.mail.ru`, `cloud.mail.ru`. 

3\. Создайте правило, расшифровывающее трафик созданной в п. 2 категории:

  ![](/.gitbook/assets/content-filter2.png)

4\. Ниже создайте правило, запрещающее загрузку файлов в файлообменники:

  ![](/.gitbook/assets/content-filter3.png)

5\. Проверьте, работает ли блокировка: с устройства пользователя, для которого она настроена, зайдите на сайты нужных файлообменников и попробуйте загрузить файлы.\
Если загрузка проходит, создайте в **Контент-фильтре** правило, расшифровывающее весь трафик пользователя, а ниже - правило, запрещающее загрузку файлов в файлообменники:

![](/.gitbook/assets/content-filter4.png)

</details>
