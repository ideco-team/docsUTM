---
description: В статье рассказывается о настройке и применении правил Контент-фильтра.
---

# Правила

Правила создаются на вкладке **Правила трафика -> Контент-фильтр -> Правила**. Помимо возможности добавления правил **Контент-фильтра**, вкладка содержит:

* **Строку поиска категории URL для категоризации**. Позволяет найти, к какой категории относится URL для создания правила;
* **Таблицу созданных правил**. Правила применяются сверху вниз в порядке следования в таблице до первого совпадения. Если стоящее выше правило разрешает ресурс для определенной группы пользователей, то правила ниже применяться не будут. Так можно создавать гибкие настройки фильтрации, исключая нужных пользователей вышестоящими правилами из правил блокировки. Аналогичным образом действуют правила расшифровки HTTPS.

В столбце **Управление** можно включать или выключать правило, менять его приоритет, редактировать и удалять. Правила контентной фильтрации применяются сразу после их создания или включения:

![](/.gitbook/assets/content-filter1.gif)

При наличии большого количества правил **Контент-фильтра** в таблице воспользуйтесь кнопкой **Фильтры**.

Для добавления правила нажмите **Добавить** и заполните поля:

![](/.gitbook/assets/content-filter26.png)

<details>

<summary>Расшифровка полей</summary>

* **Название** - название правила. Значение не должно быть длиннее 42 символов;
* **Источник**:
  * **Инвертировать источник** - позволяет использовать в правиле все объекты, кроме выбранных в строке **Адрес**;
  * **Адрес** - IP-адрес источника трафика (src), для которых применяется правило. Доступные [объекты](/settings/access-rules/aliases.md): IP-адреса, диапазоны IP-адресов, сети, домены, страны или пользователи и группы;
  * **Оператор `И`** - позволяет выбрать второе условие для источника трафика. При выборе второго условия правило срабатывает только в случае, если оба условия соответствуют **Источнику**.
* **Условия фильтрации**:
  * **Инвертировать категории сайтов** - позволяет использовать в правиле все категории, кроме выбранных в строке **Категории сайтов**;
  * **Категории сайтов** - поле для выбора [предустановленной или пользовательской категории](/settings/access-rules/content-filter/custom-categories.md), перечень ресурсов, на которые распространяется действие правила;

{% hint style="warning" %}
Если поле **Категории сайтов** пустое, правило работать не будет.
{% endhint %}

  * **Размер сообщения** - объем HTTP/HTTPS-сообщений в МБ, только целое число:
    *  `>=` - фильтрация сообщений, размер которых больше или равен указанному числу;
    *  `<=` - фильтрация сообщений, размер которых меньше или равен указанному числу.
  * **HTTP-методы** - методы запроса, которые будут применяться для всего HTTP- или HTTPS-трафика. Доступные методы:
    * GET - извлечение данных ресурса, содержащих тело ответа;
    * HEAD - извлечение данных ресурса, не содержащих тело ответа;
    * POST - отправка данных на определенный ресурс;
    * PUT - замена текущих значений ресурса;
    * DELETE - удаление ресурса;
    * OPTIONS - описание параметров соединения с ресурсом;
    * PATCH - частичное изменение ресурса;
    * TRACE - вызов возвращаемого тестового сообщения с ресурса;
    * CONNECT - установка соединения с ресурсом.
  * **MIME-типы** - форматы содержимого, к которым будет применяться правило. Форматы объединены в группы в зависимости от типа контента. Например, Audio (mp4, wav, wave и др.), Video (jpeg, mpeg, jmp и др.), Image (bmp, gif, png и др.). Настройки можно применить как к группе форматов, так и каждому формату отдельно;
  * **Направление данных**:
    * В обе стороны - фильтрация как входящего, так и исходящего трафика;
    * Входящее направление - фильтрация трафика на Ideco NGFW от внешних источников;
    * Исходящее направление - фильтрация трафика от Ideco NGFW к внешним ресурсам.
* **Проверка URL по маскам**:
  * **Маска** - шаблон URL. Значение не должно быть длиннее 255 символов. Максимальное количество URL - 100;
  * **Поиск** - поиск по введеным значениям **Маски**.
* **Действия**:
  * **Запретить** - запрещает трафик;
  * **Разрешить** - разрешает трафик и направляет его в модули **Морфологический апализ** и **Антивирус**;
  * **Перенаправить на** - перенаправляет расшифрованный трафик на указанный URL;
  * **Расшифровать** - расшифровывает трафик с HTTPS сайтов.
* **Профили антивируса** - выбор профиля **Антивируса**, которым требуется фильтровать трафик;

{% hint style="info" %}
Если выбрать действие **Перенаправить на**, то нужно создать аналогичное правило с действием **Расшифровать** и поместить его выше перенаправляющего правила.

Для расшифрованного трафика при создании и редактировании правила **Контент-фильтра** доступны более детальные настройки доступа к ресурсам с помощью HTTP-методов запроса и MIME-типов. Если поля остаются пустыми, проверка по ним не осуществляется.
{% endhint %}

* **Дополнительно**:
  * **Время действия** - время действия правила. Указываются временные промежутки (например, **Рабочее время**), которые определяются в [Объектах](/settings/access-rules/aliases.md). По умолчанию установлено значение **Любой**;
  * **Комментарий** - произвольный текст, поясняющий цель действия правила. Значение не должно быть длиннее 255 символов.

</details>

Для подтверждения создания правила нажмите **Добавить**.

## Особенности настройки правил

* При включении оператора `И` значения, выбранные в первом поле **Адрес**, нельзя указать во втором поле **Адрес**;
* Если хотя бы одно из условий **Источника** не выполняется, правило не применяется;
* Для расшифрованного трафика при создании и редактировании правила **Контент-фильтра** доступны более детальные настройки доступа к ресурсам с помощью HTTP-методов запроса, MIME-типов и проверки URL по маскам. Если поля остаются пустыми, проверка по ним не осуществляется;
* При создании шаблона **Маски** для проверки URL необходимо указывать протокол или использовать символ `*`. Варианты указания:
  * `*//example.com`;
  * `http*://example.com`;
  * `*example.com`.
* Если выбрать действие **Перенаправить на**, то необходимо создать аналогичное правило с действием **Расшифровать** и поместить его выше перенаправляющего правила.

<details>

<summary>Пример настройки HTTP-метода</summary>

**Пример**. Необходимо запретить всем пользователям отправлять данные на запрещенные сайты. 

Перейдите в раздел **Правила трафика -> Контент-фильтр -> Правила** и нажмите **Добавить**. Заполните поля, как на скриншоте:

![](/.gitbook/assets/content-filter27.png)

В поле **Категории сайтов** укажите предварительно созданную пользовательскую категорию **Запрещенные сайты**. При сохранении правила сайты откроются, если трафик не заблокирован другим правилом, но пользователь не сможет отправить данные (например, форму обратной связи).

</details>

<details>

<summary>Пример настройки MIME-типов</summary>

**Пример**. Необходимо запретить конкретному пользователю (например, User1) воспроизводить видеоконтент на запрещенных сайтах. 

Перейдите в раздел **Правила трафика -> Контент-фильтр -> Правила** и нажмите **Добавить**. Заполните поля, как на скриншоте:

![](/.gitbook/assets/content-filter28.png)

В поле **Категории сайтов** укажите предварительно созданную пользовательскую категорию **Запрещенные сайты**. В поле **MIME-типы** выберите все форматы группы **Video**. Примените действие правила **Запретить**. При сохранении правила сайт откроется, если трафик не заблокирован другим правилом, но видеоконтент не воспроизведется.

</details>

<details>

<summary>Диагностика</summary>

Если правила контентной фильтрации не действуют, проверьте следующие параметры в настройках:

* IP-адрес компьютера пользователя должен соответствовать его адресу в авторизации (раздел **Мониторинг -> Сессии пользователей**), пользователь должен находиться в нужной группе, на которую назначено правило;
* IP-адрес пользователя и ресурса, к которому он обращается, не должен входить в исключения прокси-сервера;
* В браузере и на компьютере пользователя не должны использоваться функции или плагины VPN, не прописаны сторонние прокси-серверы.

Дополнительно проверьте:

* Правильность категоризации ресурса, к которому обращаетесь, в поле **URL для категоризации** на вкладке **Правила**:

![](/.gitbook/assets/content-filter2.gif)

<!-- Для этого вставьте в поле ссылку на ресурс, который требуется категоризировать, и нажмите **Найти категории**. Категории, в которые входит URL, отобразится ниже. -->

  **Если сайт неправильно категоризирован, воспользуйтесь формой обратной связи [SkyDNS](https://www.skydns.ru/contact-us).**
* Настройки контентной фильтрации по блокировке опасных и потенциально опасных файлов можно с помощью сервиса [security.ideco.ru](https://security.ideco.ru).

</details>

<details>

<summary>Блокировка загрузки файлов в файлообменники</summary>

Блокирование этой категории требует особой настройки правил **Контент-фильтра**. В случае с файлообменниками расшифровки трафика может быть недостаточно у категорий: **Файлообменники, Файловые хранилища, Файловые архивы** и **Загрузка файлов в файлообменники**.

Чтобы заблокировать загрузку файлов в облака через браузер, выполните действия:

1\. Включите **Блокировку протоколов Quic/HTTP3** на вкладке **Контент-фильтр -> Настройки**:

  ![](/.gitbook/assets/content-filter.png)

2\. Создайте пользовательскую категорию для расшифровки трафика и укажите домены нужных файлообменников, используя маску `example.com`:

  ![](/.gitbook/assets/content-filter1.png)

  3\. Создайте правило, расшифровывающее трафик созданной в п. 2 категории:

  ![](/.gitbook/assets/content-filter2.png)

4\. Ниже создайте запрещающее правило для категории **Загрузка файлов в файлообменник**:

  ![](/.gitbook/assets/content-filter3.png)

5\. Проверьте, работает ли блокировка: с устройства пользователя, для которого она настроена, зайдите на сайты нужных файлообменников и попробуйте загрузить файлы.\
Если загрузка проходит, то:

* Добавьте в пользовательскую категорию домены файлообменников, используя любые варианты масок: `subdomain.example.com`, `*.subdomain.example.com`, `subdomain.example.com/home`, `*.example.com`.
* Создайте в **Контент-фильтре** правило, расшифровывающее весь трафик пользователя, а ниже - правило, запрещающее загрузку файлов в файлообменники:

![](/.gitbook/assets/content-filter4.png)

{% hint style="info" %}
Если не удалось выполнить настройку, то обратитесь в [службу технической поддержки](/general/technical-support.md).
{% endhint %}

</details>