---
description: >-
  Как настроить VPN-подключение для доступа пользователей к локальной сети компании.
---

# VPN-подключения

{% hint style="success" %}
Название службы раздела **VPN-подключения**: `ideco-accel-l2tp`; `ideco-accel-pptp`; `ideco-accel-sstp`; `ideco-vpn-servers-backend`; `ideco-vpn-authd`; `ideco-vpn-dhcp-backend`.\
Список служб для других разделов доступен по [ссылке](/settings/server-management/terminal/README.md).
{% endhint %}

Для настройки VPN-подключения к Ideco NGFW можно использовать VPN-клиент, который уже есть в операционной системе, или установить отдельный. Как настроить подключение в разных ОС описано в [Инструкции по созданию VPN-подключений](/recipes/popular-recipes/vpn).

Настройка VPN-сервера Ideco NGFW происходит в несколько этапов:

* Настройка протоколов, маршрутов и адресации;
* Настройка политик доступа из внешних сетей;
* Настройка двухфакторной аутентификации (опционально).

Поддерживаемые протоколы:

* [IKEv2](/settings/users/authorization/vpn-connection/ipsec-ikev2.md) - рекомендуемый протокол с точки зрения скорости и безопасности;
* [SSTP](/settings/users/authorization/vpn-connection/sstp.md) - подходит для использования в средах с ограничениями на порты;
* [L2TP/IPsec](/settings/users/authorization/vpn-connection/l2tp-ipsec.md) - обеспечивает баланс между безопасностью и совместимостью;
* [PPTP](/settings/users/authorization/vpn-connection/pptp.md) - не рекомендуется. **Небезопасен** и оставлен исключительно для совместимости со старыми решениями.

## Настройка VPN-подключения

Чтобы VPN-подключение работало на устройствах пользователей, необходимо загрузить **[корневой сертификат](/settings/services/certificates/README.md)**:

* Корневые сертификаты Ideco NGFW действительны в течение 10 лет;
* Если используется сертификат Let's Encrypt, обновление будет происходить автоматически.

Для настройки VPN-подключения перейдите в раздел **Пользователи -> VPN-подключения** и создайте правило.

{% tabs %}

{% tab title="Основное" %}

На вкладке **Основное** настраиваются протоколы и адресация VPN-подключений. Для настройки заполните поля:

![](/.gitbook/assets/vpn-authorization24.png)

<details>

<summary>Расшифрока полей</summary>

* **Сеть для VPN-подключений** - укажите подсеть, в рамках которой будут динамически назначаться IP-адреса. Маска подсети должна быть в диапазоне от 16 до 30 бит;
* **Зона** - добавьте сетевые интерфейсы для подключения по VPN (опционально);
Если требуется настроить VPN-подключение к [Loopback-интерфейсу](/settings/services/connection-to-provider/loopback.md), оставьте поле **Зона** пустым;
* **Индекс интерфейса для Netflow** - введите индекс для идентификации интерфейса (целое число от 0 до 65535), если используете Netflow;
* **DNS-суффикс** - укажите DNS-суффикс, если для подключения по VPN используется [Ideco Client](/settings/users/ideco-client/README.md) (опционально);
* Выберите, какой протокол подключения будет использоваться.

</details>

{% hint style="success" %}
Начиная с версии 16.0, для каждого протокола VPN-подключения отображается статус использования. Статусы отображаются в виде подсказок под названиями протоколов:

**<mark style="color:green;">Зеленый статус</mark>**: протокол включен и используется.

**<mark style="color:orange;">Оранжевый статус</mark>**: протокол отключен, но используется в правилах доступа по VPN.
{% endhint %}

{% endtab %}

{% tab title="Доступ по VPN" %}

На вкладке **Доступ по VPN** настраиваются правила доступа для пользователей и групп. NGFW проверяет таблицу правил сверху вниз до первого совпадения пользователя. При совпадении условий (**Источники подключения**, **Пользователи и группы**, **Протоколы подключения**) выполняется действие, выбранное при создании правил.

В правилах можно использовать как группы пользователей Ideco NGFW, так и группы безопасности AD. Чтобы указать группу безопасности AD в правиле доступа по VPN, не требуется импорт в дерево пользователей. Введите Ideco NGFW в домен и при создании правила **Доступ по VPN** в поле **Пользователи и группы** выберите необходимую группу безопасности.

Для настройки правил доступа нажмите **Добавить**:

![](/.gitbook/assets/vpn-authorization25.png)

<details>

<summary>Расшифрока полей</summary>

* **Название** - укажите название правила;
* **Источники подключения** - выберите, откуда будет производиться подключение по VPN (IP-адреса, подсети, страны);
* **Пользователи и группы** - выберите, для каких пользовалетей будет применяться правило;
* **Протоколы подключения** - выберите протокол (настраивается на вкладке **Основное**);
* **Доступ по VPN** - разрешите или запретите доступ по созданному правилу;
* **Способ 2FA** - выберите способ [двухфакторной аутентификации](/settings/users/two-factor-authentication.md). Для разных групп пользователей можно указать разные типы двухфакторной аутентификации (опционально);
* **Комментарий** - добавьте комментарий (опционально).

</details>

{% endtab %}

{% tab title="Выдача IP-адресов" %}

На вкладке **Выдача IP-адресов** можно создать правила для выдачи IP-адресов пользователям, подключающимся по VPN.

NGFW проверяет таблицу правил сверху вниз до первого совпадения пользователя. Если пользователь не попал под условия правил, IP-адрес назначается автоматически из пула адресов VPN, настраиваемого в разделе **Пользователи -> VPN-подключения** (например, 10.128.0.0/16). Из пула исключаются все подсети и одиночные адреса, указанные во всех правилах таблицы выдачи IP-адресов и используемые в текущих сессиях. Если адресов не осталось, соединение разрывается.

{% hint style="warning" %}
**Важно:**

* Подсеть, указанная в правиле, должна полностью входить в сеть для VPN-подключений. В противном случае правило считается невалидным, адрес выдать невозможно, соединение разрывается.
* В двух разных правилах нельзя указать одну и ту же сеть.
* Если в разных правилах указаны пересекающиеся сети (например, сеть `10.128.1.0/24` является подсетью cети `10.128.0.0/20`), то:
  * адреса из cети `10.128.1.0/24` никогда не будут выдаваться;
  * при выдаче адресов сети `10.128.0.0/20` из нее будут исключаться адреса подcети `10.128.1.0/24`.
* Если указать в правилах сеть, совпадающую с сетью для VPN-подключений, то все пользователи VPN, для которых не совпадет ни одно правило таблицы, не смогут получить адрес и подключиться.
* Количество одновременных VPN-подключений от одного пользователя в том числе будет ограничиваться размером сети, указанной для него в правилах.
* Если в правиле указан один IP-адрес и он уже используется в текущей сессии, то указанный в правиле пользователь не сможет установить второе VPN-подключение - оно не сможет получить адрес;
* Если в правиле указана сеть с префиксом /30 (или маской 255.255.255.252) и более широкие сети (например, `10.128.2.0/24`), то при выдаче адреса из таких сетей адрес самой сети и широковещательный адрес (`10.128.2.0` и `10.128.2.255`) использоваться не будут.
{% endhint %}

Для создания правила нажмите **Добавить**:

![](/.gitbook/assets/vpn-authorization26.png)

<details>

<summary>Расшифрока полей</summary>

* **Название** - укажите название правила;
* **Пользователи и группы** - выберите, для каких пользовалетей будет применяться правило;
* **Выдаваемые адреса** - укажите IP-адрес или подсеть, IP-адреса которой будут выдаваться пользователям;
* **Комментарий** - укажите комментарий к правилу (опционально).

</details>

При наличии большого количества правил выдачи IP-адресов в таблице воспользуйтесь кнопкой **Фильтры**.

Чтобы отключить правило, нажмите на ![](/.gitbook/assets/icon-on.png) в столбце управления. Чтобы удалить правило, нажмите ![](/.gitbook/assets/icon-delete1.png).

**Cтатическая привязка IP-адресов**

IP-адрес назначается пользователю автоматически из пула адресов для VPN, настраиваемого в разделе **Пользователи -> VPN-подключения** (например 10.128.0.0/16).

Чтобы настроить **статическую** привязку адресов, выдаваемых определенным пользователям, нужно перейти на вкладку **Пользователи -> VPN-подключения -> Выдача IP-адресов**, нажать **Добавить** и указать нужного пользователя и IP-адрес. Пример настройки фиксированного IP-адреса VPN представлен ниже:

![](/.gitbook/assets/vpn-authorization28.png)

{% endtab %}

{% tab title="Передача маршрутов" %}

На вкладке **Передача маршрутов** можно настроить правила передачи маршрутов клиентам.

{% hint style="info" %}
Маршруты, переданные Ideco NGFW для VPN-клиента, имеют меньшую метрику (т. е. высокий приоритет).
{% endhint %}

Для настройки правил нажмите **Добавить**:

![](/.gitbook/assets/vpn-authorization27.png)

<details>

<summary>Расшифрока полей</summary>

* **Название** - укажите название правила;
* **Пользователи и группы** - выберите, для каких пользовалетей будет применяться правило;
* **Отправка маршрутов** - выберите, как будут передаваться маршруты:
  * **Не отправлять** - маршруты не передаются клиенту, трафик не будет проходить через NGFW;
  * **Отправлять весь трафик на Ideco NGFW** - передается маршрут 0.0.0.0/0, весь трафик направляется через NGFW;
  * **Отправлять маршруты до всех локальных сетей** - передаются маршруты до всех локальных сетей NGFW, в том числе подключенных через IPsec и маршрутизируемых;
  * **Отправлять маршруты до локальных сетей Ideco NGFW** - передаются маршруты до локальных сетей NGFW, без учета IPsec и маршрутизируемых;
  * **Отправлять только указанные** - выберите сети, до которых будут передаваться маршруты;
* **Исключение адресов из маршрута** - выберите сети, исключенные из маршрута;
* **Комментарий** - укажите комментарий к правилу (опционально).

</details>

{% hint style="info" %}
Если маршруты VPN-клиентов пересекаются с маршрутами, передаваемыми Ideco NGFW, то выберите **Не отправлять** или **Отправлять только указанные**.
{% endhint %}

{% hint style="warning" %}
Если при подключении по VPN (SSTP, IKEv2, PPTP, L2TP) не удается получить маршруты до сетей Ideco NGFW, указанное число маршрутов не вмещается в опции DHCP-пакета.

При исключении подсети, IP-адреса, домена из передаваемого маршрута может возникнуть разбиение на несколько маршрутов. Это может привести к тому, что все маршруты не вместятся в опции DHCP-пакета.

Если количество байт в опции маршрутов превышает 255, то маршруты не передаются службой **ideco-vpn-dhcp-server**.

Если пакет DHCP превышает 576 байт, то он может быть проигнорирован клиентом DHCP и применение маршрутов не произойдет (зависит от реализации клиента).
{% endhint %}

{% endtab %}

{% endtabs %}

## Полезные ссылки

{% content-ref url="/recipes/popular-recipes/vpn/README.md" %}
[/recipes/popular-recipes/vpn/README.md](/recipes/popular-recipes/vpn/README.md)
{% endcontent-ref %}

{% content-ref url="/settings/users/two-factor-authentication.md" %}
[/settings/users/two-factor-authentication.md](/settings/users/two-factor-authentication.md)
{% endcontent-ref %}

{% content-ref url="/settings/services/README.md" %}
[/settings/services/README.md](/settings/services/README.md)
{% endcontent-ref %}