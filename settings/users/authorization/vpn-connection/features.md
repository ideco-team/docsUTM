# Особенности маршрутизации и организации доступа

## Организация доступа по VPN только к ресурсам локальной сети

Для организации доступа выполните действия:

1\. На вкладке **Сеть -> IP версии 4 -> Дополнительно -> Параметры IP** уберите флаг **Использовать основной шлюз в удаленной сети**:

![](/.gitbook/assets/features3.png)

<details>

<summary>Особенности VPN-соединения с доступом только к ресурсам локальной сети</summary>

При выборе типа передачи маршрутов **Отправлять только указанные сети** маршрут до VPN-сервера и DNS-сервера построен не будет.

Если в NGFW добавить передачу IP-адреса VPN-сервера NGFW (DNS), то маршрут восстановится, а домен будет преобразовываться со следующими особенностями:

* Таблица с включенным шлюзом:

![](/.gitbook/assets/features4.png)

* Таблица с отключенным шлюзом:

![](/.gitbook/assets/features5.png)

* Таблица с отключенным шлюзом и добавленной публикацией IP NGFW:

![](/.gitbook/assets/features6.png)

Маршрут до сервера (в примере - 10.200.0.1) добавляется, но имеет более низкий приоритет, чем маршрут по-умолчанию. Соответственно запросы обрабатываются с задержкой и не обрабатываются при перехвате маршрутом по-умолчанию.

Рекомендуем вручную указать маршрут до DNS NGFW либо добавить его в список публикуемых маршрутов на стороне NGFW. Также можно использовать сторонний DNS-сервер.

</details>

2\. Пропишите маршрут до корпоративной сети. В Windows 8, 8.1, 10 автоматически будет создан маршрут, основанный на классе, в зависимости от адреса, который получит подключение по VPN. Например, маршрут будет добавлен для сети 10.0.0.0/8, если по VPN сервер получит адрес из сети 10.128.0.0/16. Для IPsec-IKEv2 можно настроить автоматическое получение маршрута.

{% hint style="info" %}
Пример маршрута, если корпоративная сеть - `172.16.0.0/16`, а сеть для VPN-подключений, настроенная на Ideco NGFW, - `10.128.0.0/16`.

Маршрут будет таким: ```route -p add 172.16.0.0 mask 255.255.0.0 10.128.0.1```.
{% endhint %}

{% hint style="warning" %}

В некоторых случаях маршрут может не работать, тогда есть пинг до интерфейса (`10.128.0.1`), но нет пинга до хостов в локальной сети. В этом случае при создании маршрута нужно указать номер интерфейса VPN-подключения. Итоговый маршрут будет таким:

`route -p add 172.16.0.0 mask 255.255.0.0 10.128.0.1 if nn`

где `nn` - номер интерфейса VPN-подключения, посмотреть который можно при активном VPN-подключении в выводе в консоли команды `route print` раздел "Список интерфейсов".

{% endhint %}

## Не удается получить доступ к компьютерам в локальной сети Ideco NGFW

Для получения доступа к компьютерам в локальной сети Ideco NGFW убедитесь, что:

1\. Локальная сеть (или адрес на сетевой карте) на удаленной машине не пересекается с локальной сетью организации. Если пересекается, то доступа к сети организации не будет (трафик по таблице маршрутизации пойдет в физический интерфейс, а не в VPN);

2\. На компьютерах локальной сети в качестве основного шлюза прописан Ideco NGFW. Если это не так, то необходимо прописать соответствующий маршрут на устройствах вручную, чтобы сетевые пакеты шли на Ideco NGFW для VPN-сети;

{% hint style="info" %}

Например: `route -p add 10.128.0.0 mask 255.255.0.0 10.1.1.1`\
где: `10.128.0.0/16` - адрес VPN-сети Ideco NGFW (настраивается в разделе **Пользователи -> VPN-подключения**), а `10.1.1.1` - IP-адрес локального интерфейса Ideco NGFW.

{% endhint %}

3\. На Ideco NGFW (раздел Файрвол -> FORWARD) нет запрещающих правил;

4\. Компьютеры и серверы на ОС Windows не ограничивают доступ к сетевым папкам с помощью правил настроек профилей сети (как на стороне подключающегося по VPN компьютера, так и на стороне компьютеров и серверов локальной сети):

![](/.gitbook/assets/features.png)

## Получение доступа к файлам и принтерам для профиля "Все сети" и "Частные сети"

Для получения доступа выполните действия:

1\. Перейдите в PowerShell (запустите его с повышением прав до администратора).

2\. Выполните команду: `Enable-NetFirewallRule -Group "@FirewallAPI.dll,-28502"`.

{% hint style="info" %}
* Брандмауэр Защитника Windows может блокировать доступ определенных программ или сервисов (включая RDP) до внешних сетей;

    Проверьте это в настройках входящих и исходящих подключений (необходимо разрешить доступ из частых и локальных сетей):

![](/.gitbook/assets/features1.png)
{% endhint %}

{% hint style="info" %}
* Антивирусное ПО на компьютере может блокировать доступ к нему из нелокальных сетей. Либо блокировать доступ конкретных программ.

    Например, для **Kaspersky Endpoint Security** нужно добавить сеть для VPN-подключений (по умолчанию `10.128.0.0/16`) в исключения:

![](/.gitbook/assets/features2.png)

{% endhint %}

## Получение доступа к локальной сети Филиала

Для получения доступа выполните действия:

1\. Убедитесь, что VPN-сети двух NGFW не пересекаются.

2\. Проверьте настройки основного NGFW, обратившись к [статье](/settings/services/ipsec/site-to-site/ipsec-utm-to-utm-tunnel.md).

## Получение доступа до хостов локальной сети, если за NGFW есть маршрутизатор, выступающий в качестве ядра локальной сети

Чтобы обеспечить доступ, нужно настроить на роутере маршрут от нужной локальной сети до VPN-сети. Для настройки маршрута на роутере укажите в качестве назначения VPN-сеть (`10.128.0.0/16`), в качестве шлюза - NGFW (`172.16.0.1`).

{% hint style="info" %}
Если настроить на роутере маршрут невозможно, можно создать на NGFW SNAT-правило вида:

![](/.gitbook/assets/firewall13.png)

Для этого:

1\. Перейдите в раздел **Правила трафика -> Файрвол -> SNAT** и нажмите **Добавить**.

2\. Укажите следующие параметры:

* Источник - VPN-сеть (`10.128.0.0/16`);
* Назначение - сеть за роутером, к которой требуется получить доступ из VPN-сети (`192.168.0.0/24`).

3\. Нажмите **Добавить**.

В этом случае при отправке пакетов на роутер NGFW подменит IP-адрес источника своим. За счет этого роутер направит ответ от хоста в локальной сети на NGFW, который затем перенаправит его в VPN-сеть. 

У хостов из локальной сети `192.168.0.0/24` не будет доступа к VPN-сети `10.128.0.0/16`.

{% endhint %}
