---
description: >-
  Используйте загруженные с сервера готовые скрипты для создания VPN-подключения
  в ОС Windows версий 8.1 и 10.
---

# Инструкция по запуску PowerShell скриптов

## Какой протокол VPN выбрать?

При нескольких вариантах подключений по VPN выбирайте протоколы по следующим критериям:

1. **IKEv2/IPsec** - самый лучший в плане производительности и надежности подключения протокол;
2. **SSTP** - протокол основанный на TCP и SSL. Выберите его, если подключение по IKEv2 не проходит через провайдера;
3. **L2TP/IPsec** - надежный в плане шифрования, но не самый оптимальный в плане скорости и производительности протокол.

## Как запустить PowerShell скрипт?

1\. Скачайте скрипт одним из вариантов:

**Из Ideco UTM:**

* Перейдите в раздел **Пользователи -> VPN-подключение -> Основное**;
* Установите флаг у требуемого протокола подключения, если требуется, заполните поля и нажмите **Сохранить**;
* Кликните по ссылке **PowerShell - скрипт для настройки подключений**: ![](/.gitbook/assets/powershell5.png)
* Перенесите скачанный файл на устройство, на котором требуется создать VPN-подключение.

**В личном кабинете пользователя:**

* Скачайте скрипт, кликнув по ссылке **Скачать скрипт для создания подключения**: ![](/.gitbook/assets/powershell1.png)
* Перейдите к выполнению пункта 2.

{% hint style="warning" %}
Для подключения по VPN к Ideco UTM с белым IP адресом достаточно действий, указанных ниже. Если Ideco UTM выходит в интернет через маршрутизатор, воспользуйтесь пунктом [Подключение по VPN к Ideco UTM с доступом в интернет через маршрутизатор](running-powershell-scripts.md#podklyuchenie-po-vpn-k-ideco-utm-s-dostupom-v-internet-cherez-marshrutizator).
{% endhint %}

2\. Щелкните правой кнопкой мыши по скаченному файлу и в контекстном меню выберите **Свойства**.

![](/.gitbook/assets/powershell1.png)

3\. Поставьте галочку **Разблокировать** справа в нижнем углу свойств файла (по умолчанию ОС блокирует выполнение скаченных из интернета файлов):

![](/.gitbook/assets/powershell2.png)

4\. Нажмите правой кнопкой мыши на файл и выберите **Выполнить в PowerShell** в контекстном меню:

![](/.gitbook/assets/powershell3.png)

{% hint style="info" %}
При появлении ошибки "Выполнение сценариев отключено в этой системе" нужно включить выполнение сценариев, выполнив команду в PowerShell (вызовите его через меню "Пуск"): `Set-ExecutionPolicy Unrestricted`.
{% endhint %}

5\. Ответьте **Да** на вопрос о внесении изменений в компьютер;

6\. Подключение создано. Нажмите **Подключиться** в списке сетей.

![](/.gitbook/assets/powershell4.png)

## DNS-суффиксы для VPN-подключений

Powershell-скрипты прописывают основной DNS-суффикс для создаваемого VPN-подключения. Он соответствует домену, в который введен Ideco UTM. Это позволяет обращаться к устройствам за VPN по короткому имени. 

{% hint style="warning" %}
Если Ideco UTM введен в несколько доменов, то DNS-суффиксы в Powershell-скриптах не прописываются, их необходимо настраивать вручную на подключенном по VPN устройстве.
{% endhint %}

Чтобы настроить DNS-суффиксы для созданного VPN-подключения в Windows, выполните действия:

1\. Перейдите в **Сетевые подключения**, нажмите правой кнопкой мыши по нужному VPN-подключению и выберите **Свойства**:

![](/.gitbook/assets/powershell9.png)

2\. В открывшемся окне перейдите на вкладку **Сеть**, выберите компонент **IP версии 4 (TCP/IPv4)** и нажмите кнопку **Свойства**:

![](/.gitbook/assets/powershell10.png)

3\. В открывшемся окне нажмите на кнопку **Дополнительно**:

![](/.gitbook/assets/powershell11.png)

4\. Перейдите на вкладку **DNS** и включите опцию **Дописывать следующие DNS-суффиксы (по порядку)**:

![](/.gitbook/assets/powershell12.png)

5\. Нажмите **Добавить** и введите необходимые DNS-суффиксы:

![](/.gitbook/assets/powershell13.png)

{% hint style="info" %}
При обращении к компьютеру по короткому имени DNS-суффиксы будут перебираться в порядке расположения. Этот порядок можно менять стрелками.
{% endhint %} 

## Подключение по VPN к Ideco UTM с доступом в интернет через маршрутизатор

Для работы скрипта выполните действия:

1\. Сделайте проброс портов 4500 и 500 в IP-адрес Ideco UTM в локальной сети маршрутизатора.

2\. Загрузите скрипт на компьютер, воспользовавшись 1 пунктом инструкции [Как запустить Powershell скрипт](running-powershell-scripts.md#kak-zapustit-powershell-skript).

3\. Поменяйте в загруженном скрипте IP-адрес Ideco UTM на внешний IP-адрес маршрутизатора:

![](/.gitbook/assets/powershell7.gif)

**46.36.23.99** - IP-адрес Ideco UTM в локальной сети маршрутизатора.\
**5.189.21.1** - внешний IP-адрес маршрутизатора.

4\. После выполнения действий следуйте инструкции [Как запустить Powershell скрипт](running-powershell-scripts.md#kak-zapustit-powershell-skript) с 4 пункта.

### Что делать, если запустить скрипт не получается?

Возможно не хватает прав на запуск скриптов или PowerShell не установлен в системе.

Воспользуйтесь инструкцией для создания подключения в [Windows 10](/recipes/popular-recipes/vpn/connection-for-windows10.md) вручную.
