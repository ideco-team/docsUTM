
# События безопасности

{% hint style="info" %}
Все графики формируются в часовом поясе сервера.
{% endhint %}

Раздел **События безопасности** содержит информацию, представленную в разделе [Предотвращение вторжений](/settings/access-rules/ips/README.md).

## Выбор периода

Все отображаемые данные фильтруются по дате и времени. Например, выберите определенный временной период (по кнопке ![](/.gitbook/assets/icon-calendar.png)) или воспользуйтесь одним из предустановленных фильтров:

![](/.gitbook/assets/security-events.gif)

<!-- Доступные варианты: сегодня, вчера, текущая неделя, прошлая неделя, текущий месяц, прошлый месяц. -->

Если не выбран ни один фильтр по дате и времени, то по умолчанию устанавливается интервал **Сегодня** в часовом поясе сервера.

## Графики IPS

В этом разделе представлены графики, содержащие краткую информацию раздела **Предотвращение вторжений**. Подробные сведения обо всех срабатываниях правил **Предотвращение вторжений** можно найти во вкладке **Журнал IDS/IPS** в виде таблицы.  

### График Количество атак по уровню угрозы

Информация представлена в виде графика с пятью значениями угрозы безопасности:
* **Критично** - уровень угрозы 1;
* **Важно** - уровень угрозы 2;
* **Предупреждение** - уровень угрозы 3;
* **Не классифицировано** - уровень угрозы 4;
* **Не распознано** - уровень угрозы 255.
  
Если нажать на уровень угрозы в правом списке, все графики будут отфильтрованы в соответствии с этим уровнем. Чтобы отменить фильтрацию, нажмите еще раз на выбранный уровень.

Пример графика *Количество атак по уровню угрозы*:

![](/.gitbook/assets/security-events1.png)

### Описание дополнительных графков

<details>

<summary>Топ атакованных адресов</summary>

В топ атакованных попадают как внешние, так и внутренние адреса. Один из примеров, когда атакованный адрес является внешним, - работа трояна изнутри защищаемой сети.

</details>

<details>

<summary>Топ заблокированных типов атак</summary>

График подсчитывает статистику типов атак (например, типы атак *Черный список IP-адресов* или *Попытки получения привилегий администратора*) по количеству срабатываний с этим типом атаки.

</details>

<details>

<summary>Топ внешних узлов по количеству блокировок</summary>

График содержит информацию о внешних адресах и количестве блокировок по ним.

</details>

<details>

<summary>Топ атакующих стран</summary>

Топ атакующих стран строится по IP-адресам, полученным при срабатывании правил в разделе **Предотвращение вторжений**. Если IP-адрес не геокодируется в наименование страны, такой адрес не отображается в виджете. \
По этой причине локальные IP-адреса не отображаются в виджете.

</details>

<details>

<summary>Топ подозрительных локальных узлов</summary>

В топ попадают как авторизованные, так и не авторизованные пользователи, запросы которых блокировались.

</details>

## Журнал IPS

В журнале IPS можно просмотреть логи системы **Предотвращения вторжений**:

![](/.gitbook/assets/security-events3.png)

* Поле **Результат анализа** отображает действие системы: 
  * `Blocked` - пакет блокирован; 
  * Любая другая информация в этом поле - `Allowed`, информирование;
* В поле **Уровень угрозы** могут отображаться следующие значения:
  * <mark style="color:red;">Критично</mark>;
  * <mark style="color:orange;">Опасно</mark>;
  * Предупреждение;
  * <mark style="color:blue;">Не распознано</mark>;
  * Не классифицировано

IP-адреса в столбцах **Источник** и **Назначение** кликабельны и при нажатии ведут на сервис [Whois](https://www.nic.ru/whois/?searchWord) для получения информации о регистрации домена.

<details>

<summary>Для корректного отображения информации из CSV-файла выполните действия:</summary>

1\. Скачайте CSV-файл с логами системы **Предотвращения вторжений** за определенный период по соответствующей кнопке;

2\. Откройте CSV-файл в MS Excel и выделите весь первый столбец;

3\. Перейдите во вкладку **Данные** и нажмите кнопку **Текст по столбцам**; 

4\. В открывшемся окне выберите **с разделителями** и нажмите **Далее**:

![](/.gitbook/assets/log.png)

5\. В блоке **Символом-разделителем является:**  выберите **запятая** и нажмите **Далее**:

![](/.gitbook/assets/log1.png)

6\. В блоке **Формат данных столбца** выберите **Текстовый** и нажмите **Готово**:

![](/.gitbook/assets/log2.png)

</details>

<details>

<summary>Пример анализа логов</summary>

Предупреждение системы **Предотвращения вторжений**:

![](/.gitbook/assets/ips1.png)

На вкладке **Правила** откройте найденную группу по **Событию безопасности**, нажмите на ![](/.gitbook/assets/icon-eye.png) и в ней найдите сработавшее правило по его ID:

`alert http $EXTERNAL_NET any -> any any (msg:"ET SCAN Zmap User-Agent (Inbound)"; flow:established,to_server; http.user_agent; content:"Mozilla/5.0 zgrab/0.x"; depth:21; endswith; classtype:network-scan; sid:2029054; rev:2; metadata:created_at 2019_11_26, former_category SCAN, updated_at 2020_10_23;)`

Проанализируйте IP-адрес, с которым была попытка подозрительного соединения, через [whois](https://www.nic.ru/whois/).

</details>


## Web Application Firewall

Содержит информацию о срабатывании правил Web Application Firewall в виде таблицы:

![](/.gitbook/assets/security-events2.png)

IP-адреса в столбцах **Адрес источника** и **Адрес назначения** кликабельны и при нажатии ведут на сервис [Whois](https://www.nic.ru/whois/?searchWord) для получения информации о регистрации домена.

{% hint style="info" %}
Во вкладке **Web Application Firewall** отображается профиль WAF, параметры которого вызвали блокировку доступа к ресурсу.
{% endhint %}

<details>

<summary>Добавление правила Web Application Firewall в исключения</summary>

Чтобы добавить сработавшее правило WAF в исключения, выполните действия:

1\. Перейдите в раздел **Управление сервером -> Терминал**;

2\. В терминале перейдите в директорию `/var/opt/ideco/reverse-backend`, введя команду `cd /var/opt/ideco/reverse-backend`:

  * Если директория есть, она отобразится в терминале:

    ![](/.gitbook/assets/web-terminal.png)

  * Если такой директории нет, создайте ее, выполнив команды:
    ```
    mkdir /var/opt/ideco/reverse-backend
    chown ideco-reverse-backend:ideco-reverse-backend /var/opt/ideco/reverse-backend
    ```

3\. Проверьте наличие в директории `/var/opt/ideco/reverse-backend` файла `custom-waf.conf`. Для этого введите команду: `ls /var/opt/ideco/reverse-backend`;

  * Если файл есть, он отобразится в выводе терминала:

    ![](/.gitbook/assets/web-terminal1.png)

  * Если файла нет, создайте его командами:
    ```
    touch /var/opt/ideco/reverse-backend/custom-waf.conf
    chown ideco-reverse-backend:ideco-reverse-backend /var/opt/ideco/reverse-backend/custom-waf.conf
    ```

4\. Откройте файл `custom-waf.conf` в режиме редактирования, введя команду `nano custom-waf.conf`;

5\. В открывшемся файле введите `SecRuleRemoveById 930130 949110`, где `930130` и `949110` - ID сработавших правил WAF:

  ![](/.gitbook/assets/web-terminal2.png)

6\. Сохраните файл, нажав комбинацию клавиш **Ctrl + X**, и подтвердите нажав **Y**. После этого откроется окно, в котором можно изменить имя файла, нажмите **Enter**;

7\. Введите команду `sync --file-system /var/opt/ideco/reverse-backend/custom-waf.conf`, чтобы данные записались на диск;

8\. Перезапустите службу, введя в терминале команду `systemctl restart ideco-reverse-backend.service`;

9\. Введите команду `ls /run/ideco-reverse-backend/dynamic_configs`.\ После введения команды откроется набор директорий. Скопируйте название директории с максимальным числом:

  ![](/.gitbook/assets/web-terminal5.png)

10\. Введите команду `cat /run/ideco-reverse-backend/dynamic_configs/74961615282781/modsec/main.conf`, где `74961615282781` название директории, скопированное в пункте 9:

  ![](/.gitbook/assets/web-terminal3.png)

---

Внесенные в файл `custom-waf.conf` исключения из правил WAF сохранятся при обновлении сервера Ideco NGFW. Создавать директорию и файл необходимо только один раз, новые исключения следует просто в него добавлять.

</details>
