---
description: >-
  В разделе описывается настройка кластера, состоящего из двух устройств Ideco
  UTM.
---

# Кластеризация

Каждое из двух устройств Ideco UTM называется нодой.

Кластер работает в режиме active-passive. Активной является нода, обрабатывающая трафик в данный момент времени. В свою очередь резервная нода осуществляет непрерывный мониторинг состояния активной ноды и переводит текущие задачи обработки трафика на себя при отсутствии связи с активной нодой. **В любой момент времени заниматься обработкой трафика может только одна из нод.**

Сетевое взаимодействие между нодами осуществляется по отдельному физическому каналу, под который на каждой из нод резервируется по одной физической сетевой карте. Данный канал связи называется *Кластерной сетью*. Для поддержания связи между нодами используется механизм [keep-alive](https://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%BD%D0%BE%D0%B5_HTTP-%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5).

Переключение нод происходит в случае отказа (полного зависания или перезагрузки) активной ноды, а также при потере связи между нодами по кластерной сети.\
Кластер имеет один общий IP на внутреннем интерфейсе и другой общий IP на внешнем интерфейсе. Так как MAC-адреса у обеих нод разные, используется механизм [Gratuitous ARP](https://ru.wikipedia.org/wiki/ARP).

{% hint style="info" %}
Для корректной работы кластера необходимо постоянное наличие связи между нодами.
{% endhint %}

{% hint style="warning" %}
**Особенности работы кластера:**

* **Почта будет доступна для работы только в режиме почтового релея. Хранение почтовых ящиков отключено.**
* **Данные отчетности, логов и мониторинга не синхронизируются между нодами. У каждой ноды хранятся свои данные.**
* **Невозможно восстановление из бэкапов.**
* **Запрещено менять название серверов.**
* **Запрещено удалять и добавлять сетевые интерфейсы, но разрешено отключать и редактировать.**
* **Если у провайдера имеется привязка по MAC-адресу, то при переключении нод будет отсутствовать доступ в Интернет.**
* **Для настройки кластеризации нужна только одна лицензия на Ideco UTM.**
{% endhint %}

## Требования

Для создания кластера необходимо выполнение следующих требований:

* В кластере может быть только 2 устройства Ideco UTM.
* Оба устройства должны иметь одну версию системы идентичную вплоть до номера сборки.
* Интерфейсы на каждом устройстве Ideco UTM должны быть подключены к одному коммутатору или сегменту локальной сети.
* Количество используемых физических сетевых карт на обоих устройствах должно совпадать. В случае нарушения этого условия создать кластер нельзя.
* Наличие доступа к веб-интерфейсу одного из устройств Ideco UTM.

## Настройка кластера

### Конфигурация резервной ноды

#### Если вы только установили сервер Ideco UTM:

1\. При входе в локальное меню резервной ноды увидите следующее сообщение:

![](../.gitbook/assets/cluster8.png)

2\. Введите **y** и нажмите Enter.

3\. Выберите сетевую карту:

![](../.gitbook/assets/cluster9.png)

4\. Подтвердите создание кластера введя **y** и нажав Enter:

![](../.gitbook/assets/cluster10.png)

5\. UTM предложит изменить название сервера. Если вы ответите положительно на вопрос **"Изменить название сервера?"**, то появится надпись с предложением ввести новое название сервера.\
Минимальное количество символов в названии - 2.\
Максимальное количество символов в названии - 42.

![](../.gitbook/assets/cluster11.png)

6\. Появится сообщение о том, что процесс создания кластера запущен:

![](../.gitbook/assets/cluster12.png)

Необходимо зайти в веб-интерфейс активной ноды и выполнить настройки (см. пункт *Конфигурация активной ноды*). Для этого выделяется 3600 секунд.
#### Если вы создаете резервную ноду из уже установленного сервера Ideco UTM с лицензией и доступом в интернет:

1\. Перейдите в локальное меню;

2\. Выберите пункт **Создание кластера**:

![](../.gitbook/assets/cluster4.png)

3\. Выберите свободную физическую сетевую карту для создания кластерной сети и подтвердите выбор:

![](../.gitbook/assets/cluster5.png)

4\. Подтвердите создание кластера введя **y** и нажав Enter:

![](../.gitbook/assets/cluster6.png)

5\. UTM предложит изменить название сервера. Если вы ответите положительно на вопрос **"Изменить название сервера?"**, то появится надпись с предложением ввести новое название сервера.\
Минимальное количество символов в названии - 2.\
Максимальное количество символов в названии - 42.\

![](../.gitbook/assets/cluster7.png)

После ввода нового названия, нажмите **Enter** для продолжения диалога.

6\.  Появится сообщение о том, что процесс создания кластера запущен. 

![](../.gitbook/assets/cluster-create-pocess.png)

Необходимо зайти в веб-интерфейс активной ноды и выполнить настройки (см. пункт [Конфигурация активной ноды](cluster.md#konfiguraciya-aktivnoi-nody)). Для этого выделяется 3600 секунд.
### Конфигурация активной ноды

Для конфигурации активной ноды в веб-интерфейсе Ideco UTM выполните следующие действия:

1\. Перейдите в раздел **Управление сервером -> Кластеризация** и нажмите кнопку **Настроить кластер отказоустойчивости**.

2\. Подтвердите, что топология вашей сети соответствует схеме на рисунке ниже:

![](../.gitbook/assets/cluster-topology.png)

3\. Выберите сетевую карту для соединения между нодами:

![](../.gitbook/assets/cluster1.png)

4\. Сопоставьте сетевые карты. Для этого выберите в каждом столбце по одной сетевой карте и нажмите **Сопоставить**:

![](../.gitbook/assets/cluster3.png)

5\. После применения настроек резервная нода перезагрузится, и в веб-интерфейсе активной ноды отобразится информация о том, что связь с сервером установлена.

![](../.gitbook/assets/cluster-done.png)

## Возможности резервной ноды

Перейдя в локальное меню резервной ноды вы увидите, что в списке управления сервером доступны только следующие пункты:

* Разрушение кластера;
* Перезагрузка сервера;
* Отключение сервера;
* Выход.

Активная нода при этом имеет полностью работоспособный интерфейс и, доступен весь функционал.

## Разрушение кластера

Вывести ноду из кластера можно из локального меню или веб-интерфейса. При этом та нода, с которой выполняется выход, остаётся работать. А вторая нода сбрасывает настройки до состояния только что установленного Ideco UTM.

### Разрушение кластера из локального меню

Выберите пункт локального меню **Разрушение кластера**.

Появится предупреждающая надпись:

![](../.gitbook/assets/cluster-warning-local.png)

Введите **y** и нажмите **Enter**.

### Разрушение кластера из веб-интерфейса

Перейдите в раздел **Управление сервером -> Кластеризация** и нажмите кнопку **Разрушить кластер**.

Появится окно с предупреждением:

![](../.gitbook/assets/cluster-warning.png)

Нажмите **Да**.

![](../.gitbook/assets/cluster-kill.png)

## Процедура обновления нод

Для того чтобы обновить UTM до последней версии в режиме кластера необходимо выполнить следующие действия:

1.  Запустите обновление активной ноды. В процессе обновления произойдёт её перезагрузка. После перезагрузки резервная нода станет активной, переведя текущие задачи обработки трафика на себя.

    При этом кластер не будет работоспособен, так как оба устройства должны иметь одну версию системы, идентичную вплоть до номера сборки.
2. Дождитесь, когда активная нода скачает обновление и запустите его. После завершения обновления кластер вновь будет работоспособен.
