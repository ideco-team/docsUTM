---
description: >-
  В разделе описывается настройка кластера, состоящего из двух устройств Ideco
  UTM.
---

# Кластеризация

Каждое из двух устройств Ideco UTM называется нодой.\
Кластер работает в режиме active-passive. Активной является нода, обрабатывающая трафик в данный момент времени. В свою очередь резервная нода осуществляет непрерывный мониторинг состояния активной ноды и переводит текущие задачи обработки трафика на себя при отсутствии связи с активной нодой. **В любой момент времени заниматься обработкой трафика может только одна из нод.**\
Сетевое взаимодействие между нодами осуществляется по отдельному физическому каналу, под который на каждой из нод резервируется по одной физической сетевой карте. Данный канал связи называется «кластерной сетью». Для поддержания связи между нодами используется механизм keep-alive.\
Переключение нод происходит в случае отказа (полного зависания или перезагрузки) активной ноды, а также при потере связи между нодами по кластерной сети.\
Кластер имеет один общий IP на внутреннем интерфейсе и другой общий IP на внешнем интерфейсе. Так как MAC-адреса у обеих нод разные, используется механизм Gratuitous ARP.

{% hint style="info" %}
Для корректной работы кластера необходимо постоянное наличие связи между нодами. 
{% endhint %}

{% hint style="warning" %}
**Особенности работы кластера: **

* **Почта будет доступна для работы только в режиме почтового релея. Хранение почтовых ящиков отключено.**
* **Данные отчетности, логов и мониторинга не синхронизируются между нодами. У каждой ноды хранятся свои данные.**
* **Невозможно восстановление из бэкапов.**
* **ЗАПРЕЩЕНО менять название серверов.**
* **ЗАПРЕЩЕНО удалять и добавлять сетевые интерфейсы, но РАЗРЕШЕНО отключать и редактировать.**
* **Если у провайдера имеется привязка по MAC-адресу, то при переключении нод будет отсутствовать доступ в Интернет.**
* **Для настройки кластеризации нужна только одна лицензия на Ideco UTM.** 
{% endhint %}

## Требования

Для создания кластера необходимо выполнение следующих требований:

* В кластере может быть только 2 устройства Ideco UTM.
* Оба устройства должны иметь одну версию системы идентичную вплоть до номера сборки.
* Интерфейсы на каждом устройстве Ideco UTM должны быть подключены к одному коммутатору или сегменту локальной сети.
* Количество используемых физических сетевых карт на обоих устройствах должно совпадать. В случае нарушения этого условия создать кластер нельзя.
* Наличие доступа к веб-интерфейсу одного из устройств Ideco UTM.

## Настройка кластера

### Конфигурация резервной ноды

1\. Если вы только установили сервер Ideco UTM, то увидите следующее сообщение:

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-passive.png)

Введите **y** и нажмите Enter.

2\. Если вы имеете установленный сервер Ideco UTM с лицензией и доступом в интернет, то в локальном меню выполните следующие действия:\
2.1. Выберите пункт **Создание кластера**.\
2.2. Выберите свободную физическую сетевую карту для создания кластерной сети и подтвердите выбор.\
2.3. Если вы ответите положительно на вопрос **"Изменить название сервера?"**, то появится надпись с предложением ввести новое название сервера.\
**Минимальное количество символов в названии - 2.**\
**Максимальное количество символов в названии - 42.**\
После ввода нового названия, нажмите **Enter** для продолжения диалога.

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-server-change-name.jpg)

2.4. Далее появится сообщение о том, что процесс создания кластера запущен. Необходимо зайти в веб-интерфейс активной ноды и выполнить настройки (см. пункт [Конфигурация активной ноды](cluster.md#konfiguraciya-aktivnoi-nody)). Для этого выделяется 3600 секунд.

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-create-pocess.png)

**Пример настройки резервной ноды в локальном интерфейсе представлен на скриншоте ниже:**

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-local-menu-v2.jpg)

### Конфигурация активной ноды

Для конфигурации активной ноды в веб-интерфейсе Ideco UTM выполните следующие действия:

1\. Перейдите в раздел **Управление сервером -> Кластеризация** и нажмите кнопку **Настроить кластер отказоустойчивости**.

2\. Подтвердите, что топология вашей сети соответствует схеме на рисунке ниже:

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-topology.png)

3\. После применения настроек резервная нода перезагрузится, и в веб-интерфейсе активной ноды отобразится информация о том, что связь с сервером установлена.

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-done.png)

## Проверка работоспособности кластера:

Перейдя в локальное меню резервной ноды вы увидите, что в списке управления сервером доступны только следующие пункты:

* Разрушение кластера;
* Перезагрузка сервера;
* Отключение сервера;
* Выход.

Активная нода при этом имеет полностью работоспособный интерфейс и, доступен весь функционал.

## Разрушение кластера

Вывести ноду из кластера можно из локального меню или веб-интерфейса. При этом та нода, с которой выполняется выход, остаётся работать.

## Разрушение кластера из локального меню

Выберите пункт локального меню **Разрушение кластера**.

Появится предупреждающая надпись:

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-warning-local.png)

Введите **y** и нажмите **Enter**.

#### Разрушение кластера из веб-интерфейса

Перейдите в раздел **Управление сервером -> Кластеризация** и нажмите кнопку **Разрушить кластер**.

Появится окно с предупреждением:

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-warning.png)

Нажмите **Да**.

![](https://github.com/ideco-team/docsUTM/raw/v11beta/.gitbook/assets/cluster-kill.png)
