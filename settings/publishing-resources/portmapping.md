# Портмаппинг (проброс портов, DNAT)

Сервер предоставляет доступ к опубликованному в интернете веб-ресурсу (сервису, сетевой службе) на устройстве в локальной сети с серым IP-адресом. Ресурс публикуется путем трансляции (проброса) любого неиспользуемого сетевого порта на публичном IP-адресе сервера Ideco NGFW на порт ресурса, работающего на устройстве в локальной сети. При этом все обращения из внешних сетей на публичный адрес сервера Ideco по транслируемому порту перенаправляются на публикуемый порт данного ресурса. Эта технология называется DNAT, portmapper или port forwarding.

Для настройки портмаппинга в Ideco NGFW добавьте правило в разделе **Правила трафика -> Файрвол -> DNAT (перенаправление портов)**. При создании правила укажите адреса сервера, публикуемой машины и сетевого порта, с которого и на который осуществляется трансляция сетевых запросов извне.

Проверьте, что в таблице FORWARD нет запрещающего прохождение трафика правила. При наличии запрещающего правила создайте разрешающее FORWARD-правило и поместите его выше запрещающего. Укажите при создании правила назначение (адрес устройства в локальной сети) и порт назначения.

{% hint style="info" %}
**Не рекомендуется использовать проброс портов для публикации веб- и почтовых серверов (80, 443 порты).** Для их публикации воспользуйтесь [обратным прокси-сервером](/settings/services/reverse-proxy.md).
{% endhint %}

<details>

<summary>Создание правил DNAT и FORWARD в Файрволе Ideco NGFW</summary>

**Пример:**

* Публичный адрес сервера Ideco - 1.2.3.4;
* Публикуемая служба - SSH, работающая на 22 TCP-порте;
* Адрес компьютера в локальной сети, где запущена служба, к которой нужен доступ извне - 10.0.0.2.

Для настройки трансляции запросов к службе извне через сервер Ideco NGFW на устройство в локальной сети перейдите в раздел **Правила трафика -> Файрвол -> DNAT (перенаправление портов)** и нажмите **Добавить**. 

Заполните поля в соответствии с характеристиками, указанными в примере:

![](/.gitbook/assets/portmapping.png)

После сохранения созданное правило будет выглядеть следующим образом:

![](/.gitbook/assets/portmapping1.png)

Проверьте наличие запрещающих правил в таблице FORWARD. При необходимости создайте правило, разрешающее трафик: 

![](/.gitbook/assets/portmapping2.png)

Поместите созданное правило выше запрещающего:

![](/.gitbook/assets/portmapping3.png)

Настройки **Файрвола** применяются сразу при создании правил.

</details>

<details>

<summary>Частые ошибки</summary>

* Если включен режим **Разрешить интернет всем**, правила **Файрвола**, включая таблицу DNAT, не работают;
* Если в одной локальной сети находятся пользователи и сервер с опубликованным при помощи DNAT-правила ресурсом, вероятна асимметричная маршрутизация. Информация о способах устранения асимметричной маршрутизации трафика представлена в [статье](/recipes/popular-recipes/access-to-remote-networks.md).

</details>

<details>

<summary>Рекомендации</summary>

* Проверять работу правила DNAT следует из внешней сети. Если необходим доступ из локальной сети, используйте обратный прокси-сервер для публикации веб-ресурсов;
* Порт на внешнем интерфейсе сервера, с которого транслируются запросы, не всегда совпадает с публикуемым портом самой службы. Например, для предотвращения автоматических попыток подключения вредоносного ПО на популярный сервис внешние запросы транслируются на порт 4489, а в локальную сеть - на порт 3389;
* Для защиты от нежелательных подключений к публикуемой службе при создании правила укажите в поле **Источник** IP-адрес или подсеть, с которой разрешено подключаться к этой службе;
* Если трансляция осуществляется на один и тот же номер порта локального сервера, заполнять поле **Сменить порт назначения** не обязательно. Система автоматически переадресует запрос на соответствующий порт устройства в локальной сети.

</details>

<details>

<summary>Устранение неполадок</summary>

* Убедитесь, что клиент, на которого осуществляется проброс портов, отвечает на эхо-запросы ping к внешним ресурсам. Основным шлюзом на данном устройстве следует указать локальный IP-адрес Ideco NGFW, либо прописать маршрут;
* При правильной настройке публикуемая служба отвечает клиенту во внешней сети через тот же внешний интерфейс сервера, с которого изначально пришел запрос. Настройте правильный адрес SNAT для опубликованного сервиса с помощью создания правил в таблице SNAT, если в созданном правиле в поле **Назначение** указан публичный IP-адрес сервера для приема подключений извне, а также в случае переопределения автоматических правил NAT;
* Правило трансляции запросов на сервере не работает, если брандмауэр Windows или другие программы защиты блокируют соединения с внешних адресов в интернете. Для диагностики убедитесь, что настройки встроенного брандмауэра Windows или сторонних файрволов и антивирусов разрешают целевое соединение. Например, для проверки настроек брандмауэра на устройстве Windows перейдите в **Панель управления -> Брандмауэр Защитника Windows -> Дополнительные параметры -> Правила для входящих подключений / Правила для исходящих подключений**;
* Правило портмаппинга пробрасывает трафик из внешней сети на хост в локальной сети. Трафик запроса ресурса из этой же локальной сети при обращении на внешний адрес не будет проброшен правильно. Во избежание асимметричной маршрутизации при диагностике сетевыми утилитами подключайтесь из внешних для NGFW сетей, а внутри локальной сети обращайтесь к сервису по его IP-адресу в локальной сети. Альтернативный вариант - вынесите ресурс в отдельную локальную сеть, DMZ и обращайтесь к ресурсу из локальной сети клиентов по внешнему IP-адресу;
* Трафик проброшенных портов проверяется модулем [Предотвращение вторжений](/settings/access-rules/ips/README.md). Проверьте логи системы в случае неработоспособности правила и при необходимости добавьте сработавшее правило в исключения.

</details>
