---
description: >-
  Настройка профилей контроля приложений для подготовки к обновлению на NGFW
  версии 18.Х.
---

# Профили контроля приложений
{% hint style="danger" %}
В 18 версии все правила из раздела **Правила трафика -> Контроль приложений** будут удалены!

Чтобы подготовиться к изменениям, обновите версию до 17.5 (если у вас 17.4 и ниже), создайте профили в разделе **Профили безопасности -> Профили контроля приложений** и выберите их в правилах **Файрвола**.
{% endhint %}

{% hint style="success" %}
**Созданные профили не будут влиять на работу правил [Файрвола](/settings/access-rules/firewall.md) в 17 версии**, но начнут работать после обновления на 18 версию, если применены в правилах **Файрвола**.
{% endhint %}

{% hint style="danger" %}
Будьте внимательны! Несмотря на то, что в 17 версии профили **Контроля приложений** не применяются, выбранное в **Файрволе** действие работает (Разрешить/Запретить). В связи с этим до обновления на 18 версию рекомендуем временно отключить правила, созданные с применением профилей контроля приложений.
{% endhint %}

## Что изменится с появлением профилей контроля приложений

В версиях ⩽ 17 весь FORWARD трафик сначала проходит модуль **Контроль приложений**, а затем **Файрвол**.

В 18 версии в модуль **Контроль приложений** отправится только тот трафик, который попадает под разрешающее правило **Файрвола** с включенной проверкой через профиль контроля приложений согласно настройкам. Очередность обработки трафика в версиях ⩽ 17 и в ⩾ 18 версии:

{% tabs %}
{% tab title="Порядок обработки трафика в 17.Х" %}
1\. DNS;

2\. Захват трафика для DPI:

* Контроль приложений;
* Ограничение скорости;
* Система предотвращения вторжений.

3\. Захват трафика для фильтрации (прокси-сервер):

* Контент-фильтр;
* Антивирус веб-трафика.

4\. Файрвол.
{% endtab %}

{% tab title="Порядок обработки трафика в 18.Х" %}
1\. Ограничение скорости;

2\. DNS;

3\. Захват трафика для фильтрации (прокси-сервер):

* Контент-фильтр;
* Антивирус веб-трафика.

4\. Файрвол;

5\. Контроль приложений;

6\. Система предотвращения вторжений.
{% endtab %}
{% endtabs %}

### Почему мы отказались от автоматической миграции

От автоматической миграции решили отказаться из-за вероятности появления дубликатов правил **FORWARD** и усложнения администрирования таблицы: 
* **Контроль приложений** мог бы некорректно определить условия фильтрации, заданные администратором в 17 версии, и для одного правила в таблице **FORWARD** создать несколько профилей; 
* Все автоматически созданные профили безопасности были бы применены к существующим правилам **FORWARD**. А так как одному правилу **Файрвола** может соответствовать только один профиль безопасности, появились бы дубликаты.

## Создание профиля и добавление в правила Файрвола

{% hint style="danger" %}
Модуль **Контроль приложений** НЕ БУДЕТ обрабатывать трафик в версии 18.Х, если в модуле **Файрвол** для этого трафика нет разрешающего правила (действие **Разрешить**) с указанным профилем контроля приложений. \
Проверьте, что для соответствующего трафика добавлен профиль безопасности.
{% endhint %}

{% hint style="info" %}
Рекомендуем объединить пользователей в несколько групп/подгрупп (например, в соответствии с организационной структурой компании) и настроить профиль контроля приложений отдельно для каждой группы.
{% endhint %}

**Пример**. Необходимо ограничить доступ к социальным сетям пользователям группы "Бухгалтерия".

### Создание профиля контроля приложений

1\. Перейдите в раздел **Профили безопасности -> Профили контроля приложений** и нажмите **Добавить**.

2\. На вкладке **Описание** заполните **Название** и **Комментарий** (необязательно):

![](/.gitbook/assets/application-control6.png)

3\. После добавления профиля нажмите в столбце **Управление** на ![](/.gitbook/assets/icon-edit.png), а затем **Доступ к приложениям**. Выберите **Социальные сети** и примените действие **Запретить** к группе приложений, нажав на соответствующую кнопку в правом верхнем углу:

![](/.gitbook/assets/application-control7.png)

{% hint style="info" %}
К неизвестным источникам по умолчанию применяется действие **Разрешить** (доступно для редактирования).
{% endhint %}

4\. Нажмите **Сохранить**.

### Добавление профиля в правила Файрвола

1\. Перейдите в раздел **Правила трафика -> Файрвол -> FORWARD** и нажмите **Добавить**.

2\. Заполните поля:

![](/.gitbook/assets/application-control8.png)

* **Протокол** - выберите протокол, соответствующий трафику, который требуется фильтровать с помощью профиля контроля приложений;
* **Источник** - выберите **Адрес**, **Зону** и **HIP-профиль** источника трафика;
* **Назначение** - выберите **Адрес** и **Зону** назначения трафика;
* **Действие** - выберите **Разрешить**;

3\. Включите опцию **Контроль приложений** и в разделе **Профили для фильтрации** из раскрывающегося списка выберите профиль, запрещающий социальные сети сотрудникам бухгалтерии.

4\. Включите правило или оставьте его выключенным.

5\. Нажмите **Сохранить**.

{% hint style="info" %}
С 18 версии NGFW правила Файрвола, которые блокировали трафик за счет перехвата DNS в предыдущих версиях, не смогут его блокировать. Чтобы это исправить, создайте правила с профилями IPS и DPI в разделе **Правила трафика -> Файрвол -> INPUT**.
{% endhint %}

{% hint style="warning" %}
**ВАЖНО**:\
Чтобы через модуль **Контроль приложений** проходил трафик, для которого нет разрешающего правила в таблице FORWARD, рекомендуем создать в **Файрволе** правило с источником **Локальные интерфейсы** и назначением **Любой**, разместив его в конец таблицы.
{% endhint %}

<details>

<summary> Пример создания нескольких профилей контроля приложений</summary> 

**Пример**. Необходимо настроить профили контроля приложений в соответствии с требованиями:
* Всем пользователям запрещены компьютерные игры, контент для взрослых, майнинг и криптовалюты;
* Доступ к социальным сетям разрешен только Отделу продвижения;
* Доступ к стриминговым сервисам разрешен только Отделу маркетинга;
* Доступ к музыкальным приложениям разрешен только Федору Федорову из Отдела маркетинга.

В описанном примере Федор Федоров - сотрудник Отдела маркетинга, а Отдел маркетинга - структурное поздразделение Отдела продвижения:

![](/.gitbook/assets/application-control10.png)

1\. Создайте профиль, запрещающий доступ к социальным сетям, стриминговым сервисам, музыкальным приложениям, компьютерным играм, контенту для взрослых, майнингу и криптовалютам. Для этого перейдите в раздел **Профили безопасности -> Профили контроля приложений**, нажмите **Добавить** и введите название профиля:

![](/.gitbook/assets/application-control11.png)

2\. После добавления профиля нажмите в столбце **Управление** на ![](/.gitbook/assets/icon-edit.png), а затем **Доступ к приложениям**. Выберите группы приложений, которые необходимо запретить (перечислены в пункте 1), установите настройку **Запретить** и нажмите **Применить** в правом верхнем углу. После применения действия нажмите **Сохранить** в левом нижнем углу:

![](/.gitbook/assets/application-control12.png)

3\. Создайте профиль для Отдела продвижения, разрешающий доступ к социальным сетям. Для этого клонируйте созданный профиль, нажав на ![](/.gitbook/assets/icon-copy.png) в столбце **Управление**.

4\. Отредактируйте клонированный профиль: поменяйте название (например, на **Для Отдела продвижения**) и настройки доступа к приложениям (разрешите доступ к социальным сетям).

5\. Аналогично создайте профиль для Отдела маркетинга, разрешающий доступ к стриминговым сервисам. Для этого клонируйте профиль **Для Отдела продвижения**, введите название (например, **Для Отдела маркетинга**) и разрешите в нем доступ к стриминговым сервисам.

6\. Создайте профиль для Федора Федорова, разрешающий доступ к музыкальным сервисам. Для этого клонируйте профиль **Для Отдела маркетинга** и установите необходимые настройки.

В итоге должен получиться набор профилей, учитывающий настройки, описанные в примере:

![](/.gitbook/assets/application-control14.png)

Теперь необходимо создать правила в **Файрволе**, чтобы применить настройки для конкретных групп пользователей и установить приоритет прохождения трафика.

7\. Перейдите в раздел **Правила трафика -> Файрвол -> FORWARD** и нажмите **Добавить**.

8\. Заполните поля:

![](/.gitbook/assets/application-control15.png)

* В поле **Адрес** раздела **Источник** выберите группу **Все**.
* Выберите действие **Разрешить**.
* В профилях фильтрации трафика включите опцию **Контроль приложений** и выберите профиль **Запрет приложений**.
* Включите правило.

9\. Нажмите **Сохранить**.

10\. Аналогично создайте правила для каждого профиля. При создании правила **Файрвола** укажите соответствующий профилю адрес источника. Например, при создании правила с профилем фильтрации **Для Отдела маркетинга** выберите в поле **Адрес** раздела **Источник** группу **Отдел маркетинга**:

![](/.gitbook/assets/application-control16.png)

11\. Чтобы трафик проходил в соответствии с условиями примера, установите в **Файрволе** следующую последовательность правил:

![](/.gitbook/assets/application-control18.png)

Чем выше в таблице стоит правило, тем выше его приоритет. Разрешающее правило для сотрудника не сработает, если выше в таблице **Файрвола** находится правило, запрещающее трафик для отдела, в котором работает этот сотрудник.

</details>

<details>
<summary>Фильтрация с помощью профиля контроля приложений трафика, для которого в таблице FORWARD нет правил</summary>

Сначала создайте профиль контроля приложений, соответствующий нужным правилам. Для этого:

1\. Перейдите в раздел **Профили безопасности -> Профили контроля приложений** и нажмите **Добавить**.

2\. На вкладке **Описание** введите **Название** профиля и **Комментарий**.

3\. На вкладке **Доступ к приложениям** выберите протоколы или группы протоколов и действия (**Запретить** или **Разрешить**), которые будут к ним применяться.

4\. Нажмите **Добавить профиль**.

Теперь необходимо создать правило **Файрвола** с созданным профилем контроля приложений. Для этого:

1\. Перейдите в раздел **Правила трафика -> Файрвол -> FORWARD** и нажмите **Добавить**.

2\. Заполните поля:

![](/.gitbook/assets/firewall14.png)

* **Протокол** - выберите протокол, соответствующий трафику, который требуется фильтровать с помощью профиля контроля приложений**;
* **Источник** - выберите **Адрес**, **Зону** и **HIP-профиль** источника трафика;
* **Назначение** - выберите **Адрес** и **Зону** назначения трафика;
* **Действие** - выберите **Разрешить**;

3\. Включите опцию **Контроль приложений** и из раскрывающегося списка выберите созданный ранее профиль.

4\. Включите правило или оставьте его выключенным.

5\. Нажмите **Добавить**.

</details>

{% hint style="info" %}
С 18 версии NGFW правила Файрвола, которые блокировали трафик за счет перехвата DNS в предыдущих версиях, не смогут его блокировать. Чтобы это исправить, создайте правила с профилями IPS и DPI в разделе **Правила трафика -> Файрвол -> INPUT**.
{% endhint %}