# Настройка домена у регистратора/держателя зоны

Для создания почтового сервера потребуется доменное имя. Зарегистрируйте его у интернет-провайдера или напрямую у регистратора, например, в [RUcenter](https://www.nic.ru/).

После того как было зарегистрировано доменное имя, потребуется внести изменения в описание зоны на DNS-сервере (у держателя доменной зоны, которой зачастую является регистратор).

1\. Создайте ресурсную запись типа А с именем для почтового сервера в домене, указывающую на внешний IP-адрес Ideco NGFW. **Убедитесь, что на внешнем интерфейсе NGFW назначен публичный адрес, доступный из сети интернет.**

2\. Добавьте ресурсную запись типа MX, указывающую на A-запись, которая была создана на предыдущем шаге. Запись типа MX указывает на сетевой узел, который занимается обработкой почтовых сообщений для домена. Она должна ссылаться на доменное имя почтового сервера, а не на IP-адрес.

Рекомендуем:

3\. Добавить обратную ресурсную запись типа PTR. Эта запись должна быть прописана в файле обратной зоны. Эти изменения должны быть сделаны на стороне интернет-провайдера. Обратитесь к нему с просьбой прописать обратную ресурсную запись для IP-адреса, которая должна ссылаться на запись типа MX.

4\. Настроить SPF-запись для почтового сервера.

5\. После настройки почтового сервера настроить также DKIM-подпись почтовых сообщений. Для этого перейдите в раздел **Почтовый релей -> Расширенные настройки -> DKIM-подпись** и активируйте пункт **Подписывать исходящую почту с помощью DKIM**.

![](/.gitbook/assets/dikm-sign.png)

Также создайте TXT-запись для домена у держателя зоны с именем из строки _Имя записи_ и с содержимым, которое было сформировано Ideco NGFW в **Значение записи**:

![](/.gitbook/assets/dikm-sign2.png)

**Рассмотрим набор необходимых записей на примере вымышленного домена `example.net`:**

* А-запись вида: **`mail.example.net. IN A 23.45.67.89`**, где 23.45.67.89 - это внешний IP-адрес Ideco NGFW;
* MX-запись вида: **`example.net. MX 10 mx.example.net`**;
* Обратитесь на свой хостинг для регистрации PTR-записи для нужного IP-адреса вида: **`89.67.45.23.in-addr.arpa IN PTR mail.example.net`**;
* SPF-запись, объявляющая другим почтовым серверам в интернет, что отправка писем с домена разрешена только с хоста почтового сервера, указанного в MX-записи: **`example.net. IN TXT "v=spf1 a mx -all"`**.

{% hint style="success" %}
Синтаксис SPF:

* "v=spf1" — версия SPF, обязательный параметр, всегда spf1, никакие другие версии не работают;
* "+" — принимать письма (по умолчанию);
* "-" — отклонить;
* "\~" — "мягкое" отклонение (письмо будет принято, но будет помечено как спам);
* "?" — нейтральное отношение;
* "mx" — включает в себя все адреса серверов, указанные в MX-записях домена;
{% endhint %}

При использовании почтового сервера на NGFW в качестве почтового релея ресурсные записи будут выглядеть так же, так как в интернете почтовый сервер в локальной сети будет представлен SMTP-релеем на NGFW.
