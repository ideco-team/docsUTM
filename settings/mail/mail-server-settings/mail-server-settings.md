---
description: 
  Основные настройки почтового сервера.
---

# Настройка почтового сервера

{% hint style="success" %}
Видеоинструкцию смотрите по ссылкам:
* [Rutube](https://rutube.ru/video/155705320603fc286232c72ceae98403/?r=wd);
* [Youtube](https://youtu.be/N8R973DaBkw?si=KlauHOOcmeW_1-lF).
{% endhint %}

1\. Перейдите в раздел **Почтовый релей -> Основные настройки**, заполните поля **Основной почтовый домен** и **Имя хоста почтового сервера**.

* **Основной почтовый домен** указывает серверу на его почтовый домен, для которого он должен принимать и обрабатывать письма. Все ящики пользователей будут принадлежать этому домену. От имени этого домена будет вестись переписка с корреспондентами.
* **Имя хоста почтового сервера** должно разрешаться из сети интернет во внешний IP-адрес NGFW. Почтовый сервер использует это имя как уникальный идентификатор при транспорте почты между другими почтовыми серверами. Необходимо для корректной работы почтового сервера в интернете.

{% hint style="info" %}
Имя хоста почтового сервера, как правило, совпадает с MX-записью для вашего домена.
{% endhint %}

2\. Заполните дополнительные почтовые домены, которые почтовый сервер будет считать своими. Корреспонденция, отправляемая с ящиков в этих почтовых доменах, будет обрабатываться сервером при условии правильной установки MX-записей.

3\. Включите опции IMAP(S) и POP(S).

4\. Подключите дополнительный жесткий диск к серверу, если Ideco NGFW планируется использовать, как полноценный сервер с хранением почты. Перед подключением диска включите почту:

![](/.gitbook/assets/mail-settings1.png)

{% hint style="warning" %}
Хранение почты на дополнительном HDD/SSD-диске обязательно, начиная с версии Ideco UTM 7.9.0. Рекомендуем использовать SSD-диск. Поддерживаются SATA/SAS- и NVMe-накопители. Дополнительное устройство используется только для работы почтового сервера, другие данные на нем храниться не будут.
{% endhint %}

Если диск после подключения не отображается:

* Проверьте, стерты ли с диска все данные, в том числе таблица разделов;
* Обратитесь в [техническую поддержку](/general/technical-support.md), если проблему не удалось решить самостоятельно.

<details>

<summary>Создание копии диска с почтой</summary>

1\. Подключите второй физический диск, на который будет произведено клонирование почты.

2\. В терминале выполните команду `lsdlk` и посмотрите название дисков:

```
NAME                   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sr0                    11:0     1   1,8G  0 rom  
nvme01                 259:0    0   150G  0 disk 
├─nvme01p1             259:1    0   512M  0 part 
├─nvme01p2             259:2    0     2M  0 part 
└─nvme01p3             259:3    0 149,5G  0 part 
  ├─utm_72874-root_one 253:0    0     4G  0 lvm  /run/ideco-erofs
  ├─utm_72874-data     253:1    0  63,7G  0 lvm  /run/ideco-overlay-dir
  ├─utm_72874-logs     253:2    0     2G  0 lvm  /var/log/journal
  ├─utm_72874-root_two 253:3    0     4G  0 lvm  
  └─utm_72874-swap     253:4    0  15,3G  0 lvm  [SWAP]
nvme02                 259:4    0    50G  0 disk /var/spool/mail
nvme03                 259:5    0    55G  0 disk 
```

В примеме используются диски:

* `nvme01` - для работы NGFW;
* `nvme02` - для хранения почты;
* `nvme03` - новый диск.

3\. Выполните поблочное копирование с помощью утилиты dd, введя следующую команду `dd if=/dev/nvme02 of=/dev/nvme03 bs=4M status=progress`.

* `if=/dev/nvme02` - источник данных для копирования;
* `of=/dev/nvme03` - место назначения для скопированных данных.

**Обратите внимание**: после выполнения команды все данные на диске `nvme03` будут перезаписаны новыми. Если размер диска `nvme02` превышает размер диска `nvme03`, то копирование завершится неудачно.

</details>

## SSL-сертификат для почтового домена

После сохранения настроек основного почтового домена и имени хоста почтового сервера Ideco NGFW создает локальный сертификат, подписанный корневым (самоподписанным) сертификатом. Параллельно с созданием локального сертификата отправляется запрос на выпуск сертификата Let’s Encrypt.

* Если сертификат Let’s Encrypt успешно выпущен, то он заменит собой локальный сертификат.
* Если выпуск сертификата Let’s Encrypt завершился неудачей, то будет использоваться локальный сертификат.

{% hint style="info" %}
Для замены автоматически выпущенного сертификата перейдите в раздел **Сервисы -> Сертификаты -> Загруженные сертификаты** и загрузите собственную цепочку сертификатов. **CN (Общее имя)** последнего сертификата в цепочке должно соответствовать домену, для которого сертификат загружается. Подробнее в [инструкции](/settings/services/certificates/upload-ssl-certificate-to-server.md).
{% endhint %}

## Проверка настроек почтового сервера

Рекомендуется проверить корректность всех настроек DNS и почтового сервера с помощью сервиса [mail-tester.com](https://www.mail-tester.com/).

При правильной настройке почтовый сервер на Ideco NGFW должен получить 10 баллов из 10.
