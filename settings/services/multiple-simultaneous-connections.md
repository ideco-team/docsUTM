---
description: Настройка резервирования каналов, статической и динамической балансировки.
---

# Балансировка и резервирование

{% hint style="success" %}
Название службы раздела **Балансировка и резервирование**: `ideco-routing-backend`. \
Список служб для других разделов доступен по [ссылке](/settings/server-management/terminal/README.md).
{% endhint %}

При наличии нескольких подключений к интернет-провайдерам балансировку и резервирование можно осуществлять следующими способами:
 
* Резервирование одного из подключений, при отключении которого трафик пойдет через другие доступные подключения;
* Статическая балансировка трафика между несколькими подключениями. При этом часть пользователей локальной сети будет выходить в интернет через одного провайдера, часть - через другого;
* Динамическая балансировка трафика между несколькими подключениями. При этом подключения будут поочередно переключаться в зависимости от нагрузки, а сессии от всех пользователей будут равномерно распределяться между ними.

Перед настройкой убедитесь, что на сервере уже созданы минимум два подключения к сети интернет. Если нет, то создайте дополнительное подключение. Подробнее о создании подключения в статье [Настройка Внешнего Ethernet](/settings/services/connection-to-provider/ethernet-connection.md) 

Для работы с трафиком в Ideco NGFW важно учитывать 2 момента: маршрутизация и NAT. Это касается как балансировки, так и резервирования.

**Видеоинструкция по Балансировке и резервированию**:

{% embed url="https://rutube.ru/video/9ec4c6c54ffd178e98d97253828ce9e1/" %}
<!-- [Ссылка на видеоинструкцию по балансировке и резервированию](https://rutube.ru/video/9ec4c6c54ffd178e98d97253828ce9e1/) -->

## Основное

На вкладке доступен выбор одного из двух режимов - **Балансировка** или **Резервирование**.

При **Резервировании** Ideco NGFW использует каналы в соответствии с их приоритетом. Приоритет задается порядком подключений в таблице, сверху вниз. Если интернет стал недоступен через используемое подключение, то NGFW будет перебирать подключения сверху вниз (до первого рабочего подключения).

При **Балансировке** сервер балансирует трафик в зависимости от загрузки подключений.

### Резервирование каналов

Перейдите в раздел **Сервисы -> Балансировка и резервирование** и выберите режим **Резервирование**.

![](/.gitbook/assets/balancer.png)

Подключение, которое используется в данный момент, отмечено тегом **Используется**. Для смены приоритета используйте соответствующие элементы управления (![up-down.png](/.gitbook/assets/icon-up-down.png)).

### Динамическая балансировка. Распределение нагрузки по нескольким подключениям 

Действия для настройки:

1\. Перейдите в раздел **Сервисы -> Балансировка и резервирование**.

2\. Выберите режим работы **Балансировка**.

![](/.gitbook/assets/balancer1.png)

Для равномерного распределения сессий между подключениями необходимо указать значение **Пропускной способности** - максимальной скорости интернета по тарифам провайдеров. Ideco NGFW будет автоматически балансировать трафик в зависимости от загрузки подключений.

{% hint style="info" %}
Создавать маршруты или выполнять еще какие-либо настройки для динамической балансировки трафика не требуется. Трафик прокси-сервера также будет балансироваться автоматически.
{% endhint %}

{% hint style="info" %}
Для проверки скорости подключения перейдите в раздел **Управление сервером -> Терминал** и введите `speedtest-cli`. 

Пример вывода команды:

![](/.gitbook/assets/web-terminal4.png)
{% endhint %}

### Статическая балансировка. Доступ к сети интернет через определенное подключение к провайдеру 

Способы применения:

* Направление части трафика через интернет-провайдера, чья тарификация для этого трафика дешевле.
* Предоставление доступа к внутренним сетям одного из провайдеров для определенных пользователей/групп пользователей.

Действия для настройки:

1\. Перейдите в раздел меню **Сервисы -> Маршрутизация -> Внешних сетей**.

2\. Добавьте правила маршрутизации для определенного списка ресурсов, трафик к которым необходимо направить через нужное подключение к провайдеру, нажав кнопку **Добавить**.

Пример направления трафика к ресурсу **vk.com** от пользователя **Иван Петров** через подключение к провайдеру **Подключение к провайдеру №1**:

![](/.gitbook/assets/routing4.png)

## Адреса для проверки связи

На вкладке задаются IP-адреса, которые Ideco NGFW будет использовать для проверки связи с интернетом. По умолчанию заданы три IP-адреса - DNS-серверы Cloudflare, Google и Яндекс:

![](/.gitbook/assets/balancer2.png)

Сервер посылает на эти адреса ping-запросы. Cоединение с Инернетом считается установленным, если проходит пинг хотя бы до одного адреса из списка. Если этого не происходит, NGFW считает, что соединение с интернетом у интерфейса отсутствует - статус интерфейса меняется с ![](/.gitbook/assets/icon-internet-on.png) на ![](/.gitbook/assets/icon-internet-off.png).

{% hint style="info" %}
Если список адресов будет пустым, то связь с интернетом проверяться не будет. Будет считаться, что соединение с интернетом установлено всегда.
{% endhint %}
