# Инструкция по созданию подключения в Windows 10

1\. Кликните на иконке сетевого подключения в системном трее, и в появившемся окне выберите **Параметры сети и Интернет**:

![](../../../../.gitbook/assets/vpn-windows.png)

2\. Перейдите в раздел **VPN** и нажмите **Добавить VPN-подключение**:

![](../../../../.gitbook/assets/vpn-windows1.png)

3\. Заполните соответствующие поля и нажмите **Сохранить**:

* Имя подключения - название создаваемого подключения;
* Имя или адрес сервера - адрес VPN-сервера;
* Тип VPN - Протокол PPTP;
* Тип данных для входа - Имя пользователя и пароль;
* Имя пользователя - имя пользователя, которому разрешено подключение по VPN;
* Пароль - пароль пользователя.

**Для PPTP:**

![](../../../../.gitbook/assets/vpn-windows2.png)

**Для L2TP/IPSec с общим ключом:**

* Общий ключ - значение строки **PSK** в разделе **Пользователи -&gt; Авторизация -&gt; VPN-подключение -&gt; Подключение по L2TP/IPSec**.

![](../../../../.gitbook/assets/vpn-windows3.png)

{% hint style="info" %}
Если не удалось подключиться, рекомендуем выполнить следующие действия:

1. Откройте **Редактор реестра**.
2. Перейдите в `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgent` и создайте DWORD-параметр с именем AssumeUDPEncapsulationContextOnSendRule и значением `2`.
3. Перезагрузите Windows.
{% endhint %}

Возможные неполадки

1. Неправильно указан логин или пароль пользователя. Часто при повторном соединении предлагается указать домен. Старайтесь создавать цифро-буквенные пароли, желательно на латинице для ваших учетных записей. Если есть сомнения в этом пункте, то временно установите логин и пароль пользователю «user» и «123456».
2. Для того, чтобы пакеты пошли через VPN-туннель, надо убедиться, что в настройках этого подключения стоит чекбокс **Использовать основной шлюз в удалённой сети** в разделе **Настройка параметров адаптера -> Правой кнопкой мыши по подключению -> Свойства -> Сеть -> Свойства опции «Протокол Интернета версии 4 (TCP/IPv4)» -> Дополнительно**. Если же маршрутизировать все пакеты в этот интерфейс не обязательно, то маршрут надо писать вручную.
3. Подключение происходит через DNAT, т.е. внешний интерфейс Ideco UTM не имеет «белого» IP-адреса, а необходимые для работы порты (500 и 4500) «проброшены» на внешний интерфейс устройства, расположенного перед Ideco UTM и имеющего «белый» IP-адрес. В данном случае VPN-подключение либо вообще не будет устанавливаться, либо будут периодические обрывы. Решение - исключить устройство перед Ideco UTM и указать на внешнем интерфейсе Ideco UTM «белый» IP-адрес, к которому в итоге и будут осуществляться L2TP/IPsec-подключения. Либо используйте протокол SSTP, потому что его проще опубликовать с помощью проброса портов.
4. Если в OC Windows 10 повторно подключиться по L2TP, но при этом использовать **невалидный** ключ PSK (введя его в дополнительных параметрах (скриншот ниже)), подключение все равно будет установлено успешно. Это связано с особенностями работы ОС.

{% hint style="warning" %}
Убедитесь, что локальная сеть (или адрес на сетевой карте) на удалённой машине не пересекается с локальной сетью вашей организации, а если пересекается, то доступа к сети вашей организации не будет (трафик по таблице маршрутизации пойдёт в физический интерфейс, а не в VPN). Адресацию необходимо менять.
{% endhint %}

**Для SSTP:**

* Имя или адрес сервера - адрес VPN-сервера в формате *адрес_VPN_сервера:порт*.

![](../../../../.gitbook/assets/vpn-windows4.png)

**Для IKEv2:**

![](../../../../.gitbook/assets/vpn-windows5.png)

4\. Активируйте подключение, нажав правой кнопкой мыши по созданному подключению и выбрав **Подключиться**:

![](../../../../.gitbook/assets/vpn-windows6.png)

5\. Для разрыва подключения нажмите **Отключиться**. Если нужно внести изменение в созданное подключение, нажмите **Дополнительные параметры -&gt; Изменить**

![](../../../../.gitbook/assets/vpn-windows7.png)

---

**Внимание**

VPN-подключение по протоколам IPSeс в Windows автоматически разрывается через 7 часов 45 минут. Для восстановления связи подойдут следующие действия:

1\. Переподключите соединение. В данном случае соединение восстановится, но через 7 часов 45 минут вновь будет автоматически разорвано. Если вы хотите, чтобы подключение не разрывалось автоматически, то выполните действия из следующего пункта.

2\. Внесите изменения в реестр:

* Откройте **Редактор реестра**.
* Перейдите по пути `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RasMan\Parameters`.
* Нажмите правой кнопкой мыши по параметру именем **NegotiateDH2048_AES256** и нажмите **Изменить**.
* В строке **Значение** укажите значение `1`:
  
![](../../../../.gitbook/assets/windows-vpn.png)

* Нажмите **OK**.
* Перезагрузите Windows.
  
  Если параметра именем **NegotiateDH2048_AES256** нет, то создайте его. Для этого:
* Нажмите правой кнопкой мыши по свободному месту реестра в **Parameters** и выберите **Создать -> DWORD**:
  
![](../../../../.gitbook/assets/windows-vpn2.png) 

* Задайте имя **NegotiateDH2048_AES256**. 
* Нажмите правой кнопкой мыши по созданному файлу и выберите **Изменить**:

![](../../../../.gitbook/assets/windows-vpn3.png)

* В строке **Значение** укажите значение `1`:

![](../../../../.gitbook/assets/windows-vpn4.png)

* Нажмите **OK**.

3\. Перезагрузите Windows.