---
description: >-
  Настройка OSPF для обмена информацией о состоянии каналов.
---

# OSPF

{% hint style="success" %}
Название службы раздела **OSPF**: `frr`; `ideco-routing-backend`. \
Список служб для других разделов доступен по [ссылке](/settings/server-management/terminal/README.md).
{% endhint %}

Ideco NGFW поддерживает OSPF (Open Shortest Path First) - протокол динамической маршрутизации, который определяет оптимальные пути передачи данных на основе состояния каналов (интерфейсов маршрутизаторов или сетевых сегментов).

Рекомендуем использовать модуль в сетях, где применяется балансировка нагрузки на сеть и резервирование каналов.

Пример топологии с использованием OSPF представлен на схеме ниже:

![](/.gitbook/assets/ospf6.png)

<details>

<summary>Принцип работы маршрутизации по состоянию канала</summary>

**1\. Установление отношений смежности с соседними устройствами**

Маршрутизатор, использующий OSPF, отправляет hello-пакеты на мультикастовый адрес 224.0.0.5 со всех интерфейсов, где запущен OSPF. При наличии соседнего устройства маршрутизатор пытается установить с ним отношения смежности.

![](/.gitbook/assets/ospf1.png)

**2\. Обмен объявлениями о состоянии каналов**

После установления смежности устройства выполняют обмен LSA. Пакеты LSA содержат информацию о состоянии и стоимости каждого канала с прямым подключением.

![](/.gitbook/assets/ospf2.png)

**3\. Создание базы данных состояния связи**

На основе объявления LSA маршрутизаторы собирают базу данных, в которой содержатся данные о топологии сети в области.

![](/.gitbook/assets/ospf3.png)

**4\. Исполнение алгоритма SPF**

На устройствах выполняется алгоритм SPF, результатом которого является создание дерева кратчайших путей.

![](/.gitbook/assets/ospf4.png)

**5\. Выбор лучшего маршрута**

На основании данных дерева SPF обновляются данные в таблице IP-маршрутизации. 
Маршрут добавляется в таблицу маршрутизации, если отсутствует источник маршрута к той же сети с меньшим административным расстоянием, например, статический маршрут. \
Решения по маршрутизации пакетов принимаются на основе записей в таблице маршрутизации.

![](/.gitbook/assets/ospf5.png)

</details>

## Настройка OSPF

Для настройки OSPF в Ideco NGFW перейдите в раздел **Сервисы –> OSPF** и выполните действия на вкладках:

{% tabs %}

{% tab title="Основные" %}

Ideco NGFW автоматически заполняет поле **Router ID** значением наибольшего IP-адреса локальной сети, указанного в разделе [Сетевые интерфейсы](connection-to-provider/README.md).

**Аутентификация соседей** применяется для всех настроенных OSPF-интерфейсов. Важна для защиты маршрутной информации от несанкционированного вмешательства:

* Предотвращение подмены соседей (Spoofing) - злоумышленник не сможет подключиться к OSPF-домену, представившись легальным маршрутизатором, и передавать фальшивые LSA (Link-State Advertisements).
* Перехват и изменение OSPF-пакетов (например, подмена метрик или топологии).
  
Если пакет изменен, то хеш не будет совпадать и пакет будет отброшен. Хеш вычисляется на основе:
  * Содержимого пакета (заголовок и данные).
  * Секретного ключа, известного только доверенным маршрутизаторам.

<details>

<summary>Принцип работы MD5-аутентификации</summary>

На всех маршрутизаторах в одной зоне OSPF задается:
* Идентификатор ключа (Key ID).
* Секретный ключ (пароль).

При отправке OSPF-пакета маршрутизатор добавляет к нему:
* Key ID.
* MD5-хеш, вычисленный по формуле: `MD5(OSPF_пакет + Секретный_ключ + Key_ID)`.

Принимающая сторона (получатель):

  1\. Берет Key ID из пакета.

  2\. Находит у себя секретный ключ, соответствующий переданному Key ID.
  
  3\. Вычисляет MD5-хеш по той же формуле и сравнивает с полученным:
  * Если хеши совпали, пакет принимается.
  * Если хеши не совпали, пакет отбрасывается с ошибкой.

{% hint style="success" %}
Все маршрутизаторы в зоне OSPF должны использовать MD5-аутентификацию, а также одинаковые Key ID и секретный ключ.
{% endhint %}

</details>

Настройте аутентификацию:

![](/.gitbook/assets/ospf16.png)

* **Без пароля** - вариант, если не нужно использовать аутентификацию. Выбран по умолчанию после миграции с Ideco NGFW 19 версии.
* **MD5**:
  * **Key ID** - идентификатор ключа. Число в диапазоне от 1 до 255.
  * **Пароль** - секретный ключ.

<details>
<summary>Требования к паролю</summary>

* **Максимальная длина пароля** - 16 символов.
* **Символы** - любые ASCII-символы, за исключением пробелов.

</details>

Настройте **OSPF**:

1\. Нажмите кнопку **Добавить** и заполните поля:

![](/.gitbook/assets/ospf7.png)

* **Интерфейс** - локальный или [Loopback-интерфейс](/settings/services/connection-to-provider/all-ethernet.md#loopback) Ideco NGFW, IP-адрес которого будет использован для обмена маршрутами.

* **Название зоны** - номер зоны (значение `area`, для небольших сетей введите `0`). Можно ввести в виде числа или IP-адреса, нажав ![](/.gitbook/assets/icon-ospf.png).
* **Вес** - стоимость маршрута.

2\. Нажмите **Добавить**.

{% hint style="warning" %}
Добавьте в таблицу OSPF **Loopback-интерфейс**, если на вкладке **Дополнительно** отключена опция **Redistribute connected** (по умолчанию включена), чтобы сети **Loopback-интерфейсов** анонсировались.
{% endhint %}

Пример готовой таблицы:

![](/.gitbook/assets/ospf8.png)

При наличии большого количества настроек OSPF в таблице воспользуйтесь кнопкой **Фильтры**.

{% endtab %}

{% tab title="Дополнительные" %}

Включите настройки (по умолчанию включены). Будут анонсироваться:

* **Redistribute default** - маршруты по умолчанию. Устройство, принявшее эту информацию, будет отправлять на NGFW весь трафик.
* **Redistribute static** - статические маршруты, указанные на вкладке на вкладке **Локальных сетей** в разделе **Сервисы -> Маршрутизация**.
* **Redistribute connected** - маршруты подсетей, подключенных напрямую, в том числе и [Loopback-интерфейсов](/settings/services/connection-to-provider/all-ethernet.md).

{% hint style="warning" %}  
Если **Redistribute connected** отключить, сети Loopback-интерфейсов будут анонсироваться при добавлении в таблицу OSPF **Loopback-интерфейса**.
{% endhint %}

Подробнее о значении поля **Метрика** - в [статье](https://docs.frrouting.org/en/latest/ospfd.html#ospf-redistribute).

{% hint style="info" %}
Для передачи маршрутов до VPN-сети через OSPF необходимо в разделе **OSPF -> Дополнительные** включить чек-бокс **Redistribute static (передача статических маршрутов)**.
{% endhint %}

{% endtab %}

{% endtabs %}

<details>

<summary>Настройка MikroTik</summary>

1\. Авторизуйтесь на MikroTik и выполните команду:

{% code overflow="wrap" %}
```
routing ospf area add area-id=х.х.х.х default-cost=1 disabled=no inject-summary-lsa=no name=area1 type=default
```
{% endcode %}

* `х.х.х.х` - **название зоны, которое указали при настройке Ideco NGFW**. ID должен быть уникален для каждого роутера.

2\. Для передачи любых других сетей соседним устройствам по динамической маршрутизации введите команду:

{% code overflow="wrap" %}
```
routing ospf network add network=(другая подсеть)/24 area=area1
```
{% endcode %}

3\. Повторите команду из п. 1 для добавления каждой подсети.

4\. Для вывода таблицы маршрутизации введите команду: `ip route print`.

</details>

<details>

<summary>Настройка Cisco</summary>

1\. Запустите на Cisco процесс OSPF:

```
enable
conf t
router ospf 1
```

2\. По умолчанию отключите отправку hello-пакетов на всех интерфейсах и включите на нужных интерфейсах:

```
passive-interface default
no passive-interface GigabitEthernet0/0
```

* `GigabitEthernet0/0` - название интерфейса.

3\. Укажите сети, маршруты до которых хотите анонсировать:

{% code overflow="wrap" %}
```
network <IP-адрес подсети> <wildcart-маска подсети> area <номер зоны, указанный при настройке Ideco NGFW>
```
{% endcode %}

Пример команды:

```
network 192.168.100.0 0.0.255.255 area 0
```

4\. Если Cisco получил уведомление вида `*Dec 18 10:02:03.628: %OSPF-5-ADJCHG: Process 1, Nbr 192.168.122.73 on GigabitEthernet0/0 from LOADING to FULL, Loading Done`, соседские отношения установлены.

5\. Для просмотра списка соседей воспользуйтесь командой `show ip ospf neighbor`:

![](/.gitbook/assets/ospf12.png)

6\. Для вывода таблицы маршрутизации введите команду `show ip route` (в таблице должны появиться маршруты до сетей NGFW):

![](/.gitbook/assets/ospf13.png)

</details>

## Особенности работы OSPF в Ideco NGFW

* Ideco NGFW всегда будет являться шлюзом по умолчанию для других устройств. Считать другие устройства шлюзом по умолчанию NGFW не сможет.
* OSPF работает только на локальных интерфейсах: [Локальные Ethernet-интерфейсы](/settings/services/connection-to-provider/all-ethernet.md), [Туннельные интерфейсы GRE](/settings/services/connection-to-provider/gre-connection.md), [GRE over IPsec](/settings/services/ipsec/site-to-site/ipsec-utm-to-utm-transport.md) и [ГОСТ VPN](/settings/services/gost-vpn.md).
* Значение *Типа сети* (*Network Type*) в Ideco NGFW устанавливается автоматически в зависимости от типа интерфейса, используемого для OSPF:
  * GRE-интерфейсы - значение `p2p`.
  * Ethernet-интерфейсы - значение `broadcast`.

## Примеры использования

<details>

<summary>Объединение филиальной сети с резервированием и/или балансировкой</summary>

![](/.gitbook/assets/ospf14.png)

* Между **NGFW-1** в Филиале 1 и **NGFW-2** в Филиале 2 настраивается GRE-over-IPsec и OSPF.
* Каждый NGFW подключен к двум провайдерам (**Провайдер-1** и **Провайдер-2**).

Преимущества настройки:

* Трафик будет автоматически балансироваться между **Провайдером-1** и **Провайдером-2**.
* При неисправности одного из провайдеров трафик автоматически смаршрутизируется через другое соединение.
* Отсутствует необходимость вручную настраивать маршруты до локальных сетей филиалов.

</details>

<details>

<summary>Схема с балансировкой доступа из локальной сети в интернет или другую сеть</summary>

![](/.gitbook/assets/ospf15.png)

* И **NGFW-1**, и **NGFW-2** используются в качестве шлюза по умолчанию.
* Между балансировщиком и каждым из NGFW настроена OSPF.

Преимущества настройки:

* Трафик балансируется между **NGFW-1** и **NGFW-2**: часть пользователей из Локальной сети выходят в интернет через **NGFW-1**, часть - через **NGFW-2**.
* При неисправности одного из NGFW трафик автоматически смаршрутизируется через другое соединение.
* Отсутствует необходимость вручную настраивать маршруты для хостов в Локальной сети.

</details>

## Полезные ссылки

* [Сетевые интерфейсы](connection-to-provider/README.md)
* [Внешние и локальные интерфейсы](/settings/services/connection-to-provider/all-ethernet.md)
* [Подключение между двумя Ideco NGFW в транспортном режиме работы](/settings/services/ipsec/site-to-site/ipsec-utm-to-utm-transport.md)