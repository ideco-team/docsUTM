# OSPF 

{% hint style="success" %}
Название службы раздела **OSPF**: `frr; ideco-routing-backend`. \
Список служб для других разделов доступен по [ссылке](/settings/server-management/terminal/README.md).
{% endhint %}

В Ideco NGFW реализована поддержка OSPF (Open Shortest Path First) - протокола маршрутизации по состоянию каналов. Канал - это интерфейс маршрутизатора или сегмент сети, который соединяет два маршрутизатора. 

Использовать модуль лучше всего в сетях, где применяется балансировка нагрузки на сеть и резервирование каналов.

Пример топологии с использованием OSPF представлен на схеме ниже:

![](/.gitbook/assets/ospf6.png)

<details>

<summary>Принцип работы маршрутизации по состоянию канала</summary>

**1. Установление отношений смежности с соседними устройствами**

Маршрутизатор, использующий OSPF, отправляет Hello-пакеты на мультикастовый адрес 224.0.0.5 со всех интерфейсов, где запущен OSPF. При наличии соседнего устройства маршрутизатор пытается установить с ним отношения смежности.

<img src="/.gitbook/assets/ospf1.png" alt="" data-size="original">

**2. Обмен объявлениями о состоянии каналов**

После установления смежности устройства выполняют обмен LSA. LSA содержат информацию о состоянии и стоимости каждого канала с прямым подключением.

<img src="/.gitbook/assets/ospf2.png" alt="" data-size="original">

**3. Создание базы данных состояния связи**

На основе объявления LSA маршрутизаторы собирают базу данных, в которой содержатся данные о топологии сети в области.

<img src="/.gitbook/assets/ospf3.png" alt="" data-size="original">

**4. Исполнение алгоритма SPF**

На устройствах выполняется алгоритм SPF, результатом которого является создание дерева кратчайших путей.

<img src="/.gitbook/assets/ospf4.png" alt="" data-size="original">

**5. Выбор лучшего маршрута**

На основании данных дерева SPF обновляются данные в таблице IP-маршрутизации. 
Маршрут добавляется в таблицу маршрутизации, если отсутствует источник маршрута к той же сети с меньшим административным расстоянием, например, статический маршрут. \
Решения по маршрутизации пакетов принимаются на основе записей в таблице маршрутизации.

<img src="/.gitbook/assets/ospf5.png" alt="" data-size="original">

</details>

## Основное

<details>

<summary>Настройка Ideco NGFW</summary>

**Router ID** - IP-адрес маршрутизатора. Присваивается автоматически в виде самого большого IP-адреса локальной сети, заданной в разделе [Сетевые интерфейсы](connection-to-provider/README.md).

Для того чтобы настроить OSPF на NGFW, выполните следующие действия:

1\. В веб-интерфейсе NGFW перейдите в раздел **Сервисы –> OSPF –> Основные** и нажмите кнопку **Добавить**.

2\. Заполните поля:

<img src="/.gitbook/assets/ospf7.png" alt="" data-size="original">

* **Интерфейс** - выберите локальный или [Loopback-интерфейс](/settings/services/connection-to-provider/loopback.md) Ideco NGFW, IP-адрес которого будет использован для обмена маршрутами;
* **Название зоны** - введите номер зоны (для небольших сетей введите зону 0). Можно ввести в виде числа или IP-адреса, нажав иконку ![](/.gitbook/assets/icon-ospf.png);
* **Вес** - введите стоимость маршрута.
  
3\. Нажмите **Добавить.**

Пример готовой таблицы:

<img src="/.gitbook/assets/ospf8.png" alt="" data-size="original">

</details>

<details>

<summary>Настройка MikroTik</summary>

1\. Установите и запустите RouterOS:

* Поставьте крестик на модуле **Routing**;
* Укажите необходимые интерфейсы, но БЕЗ статических маршрутов:

![](/.gitbook/assets/ospf9.png)

* Для начала установки введите **i** и нажмите **Enter**;
* Появится сообщение "All data on the disk will be erased. Continue?", ведите **y** и нажмите **Enter**:
    
![](/.gitbook/assets/ospf10.png)

2\. После установки RouterOS требуется его перезагрузить, нажав **Enter**:

![](/.gitbook/assets/ospf11.png)

3\. По умолчанию *логин* - `admin`, а *пароль* - пустое значение;

4\. Установите логин/пароль администратора;

5\.  Выполните следующую команду:

`routing ospf area add area-id=х.х.х.х default-cost=1 disabled=no inject-summary-lsa=no name=area1 type=default`,\
где `х.х.х.х` - **название зоны, которое указали при настройке Ideco NGFW**. ID должен быть уникален для каждого роутера;

6\. Для передачи любых других сетей соседним устройствам по динамической маршрутизации введите следующую команду:

`routing ospf network add network=(другая подсеть)/24 area=area1`

7\. Повторите команду из п. 6 для добавления каждой подсети;

8\.  Для вывода таблицы маршрутизации введите команду:

`ip route print`

</details>

## Дополнительное

На вкладке **Дополнительное** доступны к установке следующие флаги:

* **Redistribute default** - будут анонсироваться маршруты по умолчанию. Устройство, принявшее эту информацию, будет отправлять на NGFW весь трафик;
* **Redistribute static** - будут анонсироваться статические маршруты, указанные на вкладке **Сервисы -> Маршрутизация -> Локальных сетей**;
* **Redistribute connected** - будут анонсироваться маршруты напрямую подключенных подсетей, в том числе и Loopback-интерфейсов. При отключении настройки сети Loopback-интерфейсов будут анонсироваться, если при добавлении в конфигурацию OSPF Loopback-интерфейса.

Подробнее о значении поля **Метрика** - в [статье](https://docs.frrouting.org/en/latest/ospfd.html#ospf-redistribute).

{% hint style="info" %}
Для передачи маршрутов до VPN-сети через OSPF необходимо в разделе **OSPF -> Дополнительные** включить чек-бокс **Redistribute Static (передача статических маршрутов)**.
{% endhint %}