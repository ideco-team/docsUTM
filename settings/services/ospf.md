# OSPF

В Ideco UTM 12 реализована поддержка OSPF (Open Shortest Path First) - протокола маршрутизации по состоянию каналов. Канал — это интерфейс маршрутизатора. Канал также представляет собой сегмент сети, который соединяет два маршрутизатора. Данные о состоянии этих каналов также называются состоянием канала. Вся информация о состоянии канала включает префикс сети, длину префикса и стоимость.

В данном разделе описывается принцип работы OSPF, а так же его настройка в веб-интерфейсе UTM.

Использование данного модуля лучше всего подойдет для сетей, имеющих балансировку нагрузки на сеть и резервирование каналов.&#x20;

Пример топологии с использованием OSPF представлен на схеме ниже:

![](../../.gitbook/assets/ospf-6.png)

## Принцип работы маршрутизации по состоянию канала

#### **1. Установление отношений смежности с соседними устройствами**

Маршрутизатор, использующий OSPF, отправляет пакеты приветствия для определения всех соседних устройств в пределах этих каналов. При наличии соседнего устройства маршрутизатор пытается установить с ним отношения смежности.

![](../../.gitbook/assets/ospf-1.png)

#### **2. Обмен объявлениями о состоянии каналов**

После установления смежности устройства выполняют обмен объявлениями о состоянии канала (LSA). LSA содержат информацию о состоянии и стоимости каждого канала с прямым подключением.

![](../../.gitbook/assets/ospf-2.png)

#### **3. Создание базы данных состояния связи**

На основе объявления LSA маршрутизаторы собирают базу данных, в которой содержатся данные о топологии сети в области.

![](../../.gitbook/assets/ospf-3.jpg)

#### **4. Исполнение алгоритма SPF**

Затем на устройствах выполняется алгоритм SPF, результатом которого является создание дерева кратчайших путей.

![](../../.gitbook/assets/ospf-4.jpg)

#### **5. Выбор лучшего маршрута**

На основании данных дерева SPF предлагаются наилучшие пути для таблицы IP-маршрутизации. Маршрут добавляется в таблицу маршрутизации, если отсутствует источник маршрута к той же сети с меньшим административным расстоянием, например статический маршрут. Решения по маршрутизации принимаются на основе записей в таблице маршрутизации.

![](../../.gitbook/assets/ospf-5.jpg)

## Настройка Ideco UTM

Для того чтобы настроить OSPF  на UTM, выполните следующие действия:

1. В веб-интерфейсе UTM перейдите в раздел **Маршрутизация - OSPF** и нажмите кнопку **Добавить.**
2.  Заполните следующие поля:

    В поле **Интерфейс** выберите локальный интерфейс, подключенный к роутеру.

    В поле **Наименование зоны** введите номер зоны (для небольших сетей введите зону 0).

    В поле **Вес** введите стоимость маршрута.
3. Нажмите **Сохранить.**

Пример настройки:

![](../../.gitbook/assets/4365.png)

Пример готовой таблицы:

![](../../.gitbook/assets/image.png)

## Настройка MikroTik

1. При установке RouterOS включите динамическую маршрутизацию, поставить крестик на модуле Routing.
2.  Укажите необходимые интерфейсы, но без статичных маршрутов:

    `interface bridge add name=loopback ip address add interface=loopback address=1.1.1.1/32`&#x20;
3.  Выполните следующую команду, если:&#x20;

    3.1. устройство является [пограничным](https://ru.wikipedia.org/wiki/OSPF#%D0%A2%D0%B8%D0%BF%D1%8B\_%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2) и должно сообщать другим, что оно является шлюзом по умолчанию для выхода в Интернет:

    `routing ospf instance set numbers=0 router-id=1.1.1.1 redistribute-default=always-as-type-1`&#x20;

    3.2. устройство не имеет прямого выхода в Интернет:

    `routing ospf instance set numbers=0 router-id=1.1.1.1` (такой же IP-адрес, который установили на loopback)
4.  Добавьте этот адрес в динамическую сеть, он будет всегда доступен, и требуется для идентификации роутеров:

    `routing ospf network add network=1.1.1.1/32 area=backbone`
5.  Для передачи любых других сетей соседним устройствам по динамической маршрутизации, введите следующую команду

    `routing ospf network add network=(другие подсети)/24 area=backbone`&#x20;
6. Повторите команду из п. 5 для добавления каждой сети.
7.  Для вывода таблицы маршрутизации введите команду:

    `ip route print`&#x20;
