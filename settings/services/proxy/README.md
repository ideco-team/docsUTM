---
description: >-
  Используется для прозрачного проксирования веб-трафика потребителям в
  локальной сети.
---

# Прокси

{% hint style="success" %}
Название службы раздела **Прокси**: `ideco-proxy-backend`; `squid`. \
Список служб для других разделов доступен по [ссылке](../../server-management/terminal.md).
{% endhint %}

Прокси-сервер, помимо проксирования веб-трафика, используется для передачи трафика следующим сервисам:

* Антивирус для веб-трафика (Антивирус Касперского или ClamAV);
* Сервис отчетности по веб-трафику пользователей;
* Контент-фильтр. 

Порядок обработки веб-трафика подробнее описан в [статье](../../../recipes/popular-recipes/processing-order.md).

{% hint style="info" %}
На хостах локальной сети не нужно явно указывать настройки прокси. Достаточно указания UTM в качестве шлюза по умолчанию для устройств в сети.

Для настройки фильтрации HTTPS-трафика нужно добавить корневой сертификат UTM на компьютеры пользователей. Подробнее в статье [Настройка фильтрации HTTPS](../../access-rules/content-filter/filtering-https-traffic.md).
{% endhint %}

## Основное

На вкладке **Основное** предоставлена возможность:
* **Включить кэширование трафика на диск**. По умолчанию кэширование трафика на диск отключено, но оно осуществляется в оперативной памяти сервера. **Не рекомендуем включать эту опцию по причине излишней нагрузки на дисковую подсистему**. 
* **Разрешить прямые подключения к прокси**. Данный режим применяется в случае, когда Ideco UTM не является шлюзом по умолчанию для клиентов сети. \
  Порт, указанный на стороне UTM, следует указать на сетевых устройствах локальной сети, веб-трафик которых нужно пропускать через прокси.
  
  ![](../../../.gitbook/assets/proxy-server4.png)

* **Включить журналирование**. Включает запись логов Контент-фильтра и Антивирусов веб-трафика.

![](../../../.gitbook/assets/proxy-server.png)

О настройке прямого подключения к прокси и прокси с одним интерфейсом читайте в [статье](proxy-server.md).

## ICAP

Протокол ICAP используется для отправки HTTP(S)-трафика в расшифрованном виде сторонним серверам. ICAP-сервисы будут обрабатывать трафик после антивирусов и контент-фильтра.

При добавлении ICAP-сервиса доступны следующие настройки:
* **Игнорировать ошибки** - если включена эта опция, то сервис будет считаться необязательным. При недоступности или неправильной работе сервиса он не будет задействован.
* **Задать количество подключений к сервису вручную** - если значение не задано, максимальное количество подключений берется из ответа сервиса на запрос OPTIONS. Если максимальное количество подключений не указано и в ответе на запрос OPTIONS - тогда без ограничений.

![](../../../.gitbook/assets/proxy-server5.png)

## WCCP

Протокол WCCP используется на маршрутизаторах и кэширующих серверах для перенаправления трафика в сети. 

DNS запросы принимаются и отправляются роутером минуя Ideco UTM. Веб-запросы обрабатываются роутером в соответствии с уровнем WCCP.

Для активации WCCP переведите опцию **Включить перенаправление трафика c WCCP серверов на Ideco UTM** в положение **Включен**. Ideco UTM запустит процесс согласования параметров с WCCP сервером.

Если на WCCP-сервере задан пароль, то сохраните его в соответствующем поле и нажмите **Сохранить**:

![](../../../.gitbook/assets/proxy-server8.png)

Укажите значение от 1 до 10000 в поле **Вес** для приоритизации Ideco UTM в выборе перенаправления трафика WCCP-сервером.

Для добавления WCCP-сервера нажмите **Добавить** в левом верхнем углу и укажите IP-адрес сервера:

![](../../../.gitbook/assets/proxy-server7.png)

### Уровень L2:

![](../../../.gitbook/assets/proxy-server6.png)

Последовательность обработки веб-запросов на уровне L2:
* Пользователь отправляет веб-запрос;
* Запрос перенаправляется роутером на Ideco UTM;
* Ideco UTM обрабатывает запрос. \
  Если запрос заблокирован, то информация о блокировке отправляется обратно пользователю. \
  Если запрос не заблокирован, то Ideco UTM проверяет включено ли кэширование трафика на диск (опция включается на вкладке **Основное**) и сохранена ли страница в кэше: 
  * Кэширование включено и страница в кэше есть, то Ideco UTM отправляет страницу пользователю; 
  * Кэширование выключено или страницы в кэше нет: Ideco UTM подменяет IP-адрес источника и направляет запрос на внешний сервер. 

Ответ возвращается обратно по тому же пути, по которому уходил на внешний сервер.

### Уровень GRE: 

![](../../../.gitbook/assets/proxy-server9.png)

Последовательность обработки веб-запросов на уровне GRE:
* Пользователь отправляет веб-запрос;
* Запрос перенаправляется по GRE-туннелю на Ideco UTM;
* Ideco UTM обрабатывает запрос. \
  Если запрос заблокирован, то информация о блокировке отправляется обратно пользователю. \
  Если запрос не заблокирован, то Ideco UTM проверяет включено ли кэширование трафика на диск (опция включается на вкладке **Основное**) и сохранена ли страница в кэше:
  * Кэширование включено и страница в кэше есть, то Ideco UTM отправляет страницу пользователю; 
  * Кэширование выключено или страницы в кэше нет: Ideco UTM подменяет IP-адрес источника и направляет запрос на внешний сервер. 

Ответ возвращается через WCCP роутер, минуя Ideco UTM и GRE-туннель.

## Исключения

Исключения ресурсов из обработки прокси-сервером работают только для прозрачного режима прокси. При прямых подключениях к прокси-серверу исключить что-либо из обработки прокси нельзя.

Подробнее о типах исключений в статье:

{% content-ref url="exclusions.md" %}
[exclusions.md](exclusions.md)
{% endcontent-ref %}
