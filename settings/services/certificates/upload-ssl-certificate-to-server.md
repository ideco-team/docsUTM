# Загрузка своего SSL-сертификата на сервер

После покупки доверенного SSL сертификата у Certificate Authority или Центра сертификации (CA) нужно создать текстовый файл вида:

```
-----BEGIN PRIVATE KEY-----
.....
.....
-----END PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
.....
.....
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
.....
.....
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
.....
.....
-----END CERTIFICATE-----
```

Этот файл состоит из двух логических блоков:

* блок с приватным ключом и блок сертификатов, состоящий из корневого сертификата, сертификата на домен и vendor-сертификатов;
* блок с сертификатами, которые пришлет CA, следует после блока с приватным ключом.

Будьте внимательны: помимо корневого и сертификата на домен, CA, скорее всего, вышлет и дополнительные vendor-сертификаты, состоящие из нескольких дополнительных сертификатов в одном файле (bundle). Эту связку сертификатов нужно обязательно добавить после основного сертификата, выданного на домен. Порядок блоков в файле можно представить так:

```
Приватный ключ
Сертификат на домен
Сертификат из состава бандла vendor-сертификатов
Сертификат из состава бандла vendor-сертификатов
...
Основной (корневой) сертификат
```

После этого можно загрузить полученный файл с приватным ключом и сертификатом на UTM через веб-интерфейс. Для этого перейдите в разделе **Сервисы -> Сертификаты**.

{% hint style="info" %}
С общепринятым стандартом создания файла-цепочки сертификатов можно также ознакомиться здесь: [https://www.digicert.com/ssl-support/pem-ssl-creation.htm](https://www.digicert.com/ssl-support/pem-ssl-creation.htm).
{% endhint %}

### Зашифрованный приватный ключ

Поддерживается только стандартный формат приватного ключа: незашифрованный (decrypted) PEM. Такой ключ начинается со строки:

`-----BEGIN PRIVATE KEY-----`

Бывает, что CA выдает зашифрованный (encrypted) с помощью passphrase (фразы-пароля) приватный ключ. В таком случае нужно расшифровать (конвертировать) зашифрованный ключ в обычный, используя утилиту `openssl` или, если CA предоставляет другие инструменты для этого, воспользоваться ими. Список параметров вызова `openssl` для конвертации ключа в незашифрованный вид зависит от технологии шифрования ключа у CA и должен быть описан в инструкции по установке сертификата от CA. **Загрузить и использовать на сервере Ideco UTM зашифрованный приватный ключ нельзя.**

## Создание сертификата на OC Windows вручную

1\. Запустите PowerShell от имени администратора;

2\. Сгенерируйте сертификат, выполнив команду:

{% code overflow="wrap" %}
```
New-SelfSignedCertificate -DnsName test.ideco.com -TextExtension @("2.5.29.19={text}CA=true") -CertStoreLocation cert:\LocalMachine\My
```
{% endcode %}

* `test.ideco.com` - домен.

![](../../../.gitbook/assets/upload-ssl-certificate-to-server.png)

Для просмотра сгенерированного сертификата выполните команду `certlm.msc`.

3\. Сформируйте пароль для сертификата:

```
$CertPassword = ConvertTo-SecureString -String “12345” -Force –AsPlainText
```

* `12345` - пароль.

4\. Экспортируйте сертификат выполнив команду:

{% code overflow="wrap" %}
```
Export-PfxCertificate -Cert cert:\LocalMachine\My\2284919151C5C624341D7B75FE034B00DF6A44FA -FilePath C:\Users\pende\ssl\test.ideco.pfx -Password $CertPassword
```
{% endcode %}

* `2284919151C5C624341D7B75FE034B00DF6A44FA` - идентификатор сертификата полученный на шаге 2.

5\. Конвертируйте сертификат в расширение .pem ([пример конвертора](https://www.leaderssl.ru/tools/ssl_converter));

6\. Загрузите сертификат в UTM (Сервисы -> Сертификаты -> Загрузить корневой сертификат).

## Создание сертификата на OC Windows с помощью программы openssl

Для того чтобы создать сертификат, выполните следующие действия:

1\. Скачайте программу openssl. Ссылка на программу: [http://slproweb.com/products/Win32OpenSSL.html](http://slproweb.com/products/Win32OpenSSL.html).

2\. Установите openssl. Инструкция по установке: [http://iljin-oleg.blogspot.com/2012/12/openssl-openssl-ssl-secure-socket-layer.html](http://iljin-oleg.blogspot.com/2012/12/openssl-openssl-ssl-secure-socket-layer.html).

3\. Если файл сертификата в формате **pkcs12**: \(если в формате pem, то можно сразу переходить к подпункту Д\):  

**А**. Поместите этот файл в директорию `C:\OpenSSL-Win64\bin` \(в папку с установленной программой openssl\); \
**Б**. Откройте командную строку; \
**В**. В командной строке перейдите в директорию с установленной программой openssl; \
**Г**. Введите команду `openssl pkcs12 -in certificate.pkcs12 -out certificate.pem` \(с помощью этой команды сконвертируете сертификат в нужный формат\). **certificate.pkcs12** - исходный сертификат который вы получили у центра сертификации \(далее CA\); **certificate.pem** - результат конвертации; \
**Д**. Откройте полученный файл в текстовом редакторе \(например в блокноте\); \
**Е**. Файл имеет следующую структуру:

    ```
     -----BEGIN CERTIFICATE-----
     ..............
     ..............
     -----END CERTIFICATE-----
     -----BEGIN ENCRYPTED PRIVATE KEY-----
     ..............
     ..............
     -----END ENCRYPTED PRIVATE KEY-----
    ```

    или такую структуру:

   ```
    -----BEGIN CERTIFICATE-----
    ..............
    ..............
    -----END CERTIFICATE-----
    -----BEGIN PRIVATE KEY-----
    ..............
    ..............
    -----END PRIVATE KEY-----
   ```

   Если в сертификате написано `--BEGIN ENCRYPTED PRIVATE KEY--`, то нужно его расшифровать с помощью утилиты openssl. **Команда для расшифровки:** `openssl rsa -in certificate.pem -out certificate_decoded.pem`. **certificate.pem** - файл который получили после конвертации на шаге *Г*; **certificate\_decode.pem** - результат расшифровки. Если в сертификате написано **--BEGIN PRIVATE KEY--**, то файл сертификата уже расшифрован. Можно приступать к следующему шагу.

4\. Создайте пустой файл с расширением `pem` \(**my\_certificate.pem**\).

5\. Откройте его с помощью текстового редактора.

6\. Откройте файл, который получился на шаге 3 \(**certificate\_decode.pem**\). Из этого файла нужно скопировать текст вида \(приватный ключ\):

   ```
   -----BEGIN PRIVATE KEY-----
   ..............
   ..............
   -----END PRIVATE KEY-----
   ```

7\. Вставьте скопированный текст в файл, созданный на шаге 4 \(**my\_certificate.pem**\).

8\. Перейдите в файл, созданный на шаге 3 \(**certificate\_decode.pem**\). Из этого файла нужно скопировать текст вида \(сертификат домена\):

   ```
   -----BEGIN CERTIFICATE-----
   ..............
   ..............
   -----END CERTIFICATE-----
   ```

9\.  Вставьте скопированный текст в файл, созданный на шаге 4 \(**my\_certificate.pem**\).

10\.  CA должен был выслать bundle сертификат \(их может быть несколько\) и корневой сертификат. Если этих сертификатов нет, то их можно скачать в Интернете или запросить у CA.

11\.  Из bundle сертификатов и корневого сертификата скопируйте текст вида:

    ```
    -----BEGIN CERTIFICATE-----
    ..............
    ..............
    -----END CERTIFICATE-----
    ```

12\.  Вставьте скопированный текст в файл, созданный на шаге 4 \(**my\_certificate.pem**\). В начале нужно будет вставить текст из bundle сертификатов, а в самом конце текст корневого сертификата.

13\. В итоге получится файл из блоков:

    ```
    Приватный ключ
    Сертификат на домен
    Сертификат из состава бандла vendor-сертификатов
    Сертификат из состава бандла vendor-сертификатов
    .........
    Корневой сертификат
    ```

14\.  Получившийся файл загрузите в UTM. Для этого перейдите в раздел **Сервисы -> Сертификаты**.
