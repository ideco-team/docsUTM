---
description: >-
  В разделе описывается настройка кластера, состоящего из двух серверов Ideco
  UTM.
---

# Кластеризация

{% hint style="success" %}
Название службы раздела **Кластеризация**: `ideco-cluster-backend`; `ideco-cluster-backup-pusher`. \
Список служб для других разделов доступен по [ссылке](/settings/server-management/terminal.md).
{% endhint %}

Каждое из двух устройств Ideco UTM называется нодой.

Кластер работает в режиме active-passive. Активной является нода, обрабатывающая трафик в данный момент времени. В свою очередь резервная нода осуществляет непрерывный мониторинг состояния активной ноды и переводит текущие задачи обработки трафика на себя при отсутствии связи с активной нодой. **В любой момент времени заниматься обработкой трафика может только одна из нод.**

Сетевое взаимодействие между нодами осуществляется по отдельному физическому каналу, под который на каждой из нод резервируется по одной физической сетевой карте. Данный канал связи называется _Кластерной сетью_. Для поддержания связи между нодами используется механизм keep-alive.

Переключение нод происходит в случае отказа (полного зависания или перезагрузки) активной ноды, а также при потере связи между нодами по кластерной сети.\
Кластер имеет один общий IP на внутреннем интерфейсе и другой общий IP на внешнем интерфейсе. Так как MAC-адреса у обеих нод разные, используется механизм Gratuitous ARP.

{% hint style="info" %}
Для корректной работы кластера необходимо постоянное наличие связи между нодами.
{% endhint %}

{% hint style="warning" %}
**Особенности работы кластера:**

* **Почта будет доступна для работы только в режиме почтового релея. Хранение почтовых ящиков отключено**;
* **Данные отчетности, логов и мониторинга не синхронизируются между нодами. У каждой ноды хранятся свои данные**;
* **Невозможно восстановление из бэкапов**;
* **Невозможно восстановиться на предыдущую версию**;
* **Запрещено добавлять сетевые интерфейсы, но РАЗРЕШЕНО отключать и редактировать. Удаление сетевого интерфейса кластера, использующегося для связи между нодами, сделает его недееспособным**;
* **Если у провайдера имеется привязка по MAC-адресу, то при переключении нод будет отсутствовать доступ в интернет**;
* **Для настройки кластеризации нужна только одна лицензия на Ideco NGFW**.
{% endhint %}

## Требования

Для создания кластера необходимо выполнение следующих требований:

* В кластере может быть только 2 ноды Ideco UTM;
* Обе ноды должны иметь одну версию системы идентичную вплоть до номера сборки;
* Интерфейсы на каждом сервере Ideco UTM должны быть подключены к одному коммутатору или сегменту локальной сети (подробнее в шаг 2 пункт 2);
* Количество используемых физических сетевых карт на обоих серверах должно совпадать. В случае нарушения этого условия создать кластер нельзя.

{% hint style="warning" %}
Не используйте в качестве кластерной сети общедоступную сеть, используемую для передачи стороннего трафика. Обмен данными между нодами не защищен от подмены и прослушивания.
{% endhint %}

## Настройка кластера

Если на момент создания кластера у вас уже есть настроенный Ideco UTM, то рекомендуем выбрать его в качестве активной ноды. Все настройки резервной ноды будут удалены в процессе создания кластера.

### Шаг 1 - Конфигурация резервной ноды

<details>

<summary>Если только установили сервер Ideco UTM</summary>

1\. При входе в локальное меню резервной ноды увидите следующее сообщение:

<img src="/.gitbook/assets/cluster8.png" alt="" data-size="original">

2\. Введите *y* и нажмите Enter.

3\. Выберите сетевую карту:

<img src="/.gitbook/assets/cluster9.png" alt="" data-size="original">

4\. Подтвердите создание кластера введя **y** и нажав **Enter**:

<img src="/.gitbook/assets/cluster10.png" alt="" data-size="original">

5\. UTM предложит изменить название сервера. При положительном  ответите на вопрос _Изменить название сервера?_, появится надпись с предложением ввести новое название сервера.\
Минимальное количество символов в названии - 2.\
Максимальное количество символов в названии - 62.

<img src="/.gitbook/assets/cluster11.png" alt="" data-size="original">

После ввода нового названия, нажмите **Enter** для продолжения диалога.

6\. Появится сообщение, что процесс создания кластера запущен:

<img src="/.gitbook/assets/cluster12.png" alt="" data-size="original">

Необходимо зайти в веб-интерфейс активной ноды и выполнить настройки (см. пункт _Конфигурация активной ноды_). Для этого выделяется 3600 секунд.

</details>

<details>

<summary>Если создаете резервную ноду из уже установленного сервера Ideco UTM с лицензией и доступом в интернет:</summary>

1\. Перейдите в локальное меню.

2\. Выберите пункт **Создание кластера**:

<img src="/.gitbook/assets/cluster4.png" alt="" data-size="original">

Пункты *Восстановиться на предыдущую версию* и *Создание кластера* будут отсутствовать, если кластер на ноде уже настроен

3\. Выберите свободную физическую сетевую карту для создания кластерной сети и подтвердите выбор:

<img src="/.gitbook/assets/cluster5.png" alt="" data-size="original">

4\. Подтвердите создание кластера введя **y** и нажав **Enter**:

<img src="/.gitbook/assets/cluster6.png" alt="" data-size="original">

5\. UTM предложит изменить название сервера. При положительном ответите на вопрос _"Изменить название сервера?"_ появится надпись с предложением ввести новое название сервера.\
Минимальное количество символов в названии - 2.\
Максимальное количество символов в названии - 42.

<img src="/.gitbook/assets/cluster7.png" alt="" data-size="original">

После ввода нового названия, нажмите **Enter** для продолжения диалога.

6\. Появится сообщение, что процесс создания кластера запущен.

<img src="/.gitbook/assets/cluster12.png" alt="" data-size="original">

Необходимо зайти в веб-интерфейс активной ноды и выполнить настройки (см. пункт _Конфигурация активной ноды_). Для этого выделяется 3600 секунд.

</details>

### Шаг 2 -Конфигурация активной ноды

Для конфигурации активной ноды в веб-интерфейсе Ideco UTM выполните следующие действия:

1\. Перейдите в раздел **Управление сервером -> Кластеризация** и нажмите кнопку **Настроить кластер отказоустойчивости**.

2\. Подтвердите, что топология сети соответствует схеме на рисунке ниже:

![](/.gitbook/assets/cluster-topology.png)

3\. Выберите сетевую карту для соединения между нодами:

![](/.gitbook/assets/cluster1.png)

4\. Сопоставьте сетевые карты. Для этого выберите в каждом столбце по одной сетевой карте и нажмите **Сопоставить**:

![](/.gitbook/assets/cluster3.png)

5\. После применения настроек резервная нода перезагрузится, и в веб-интерфейсе активной ноды отобразится информация о том, что связь с сервером установлена.

![](/.gitbook/assets/cluster-done.png)

## Возможности резервной ноды:

В локальном меню резервной ноды доступны только следующие пункты:

* Разрушение кластера;
* Перезагрузка сервера;
* Отключение сервера;
* Выход.

Активная нода при этом имеет полностью работоспособный интерфейс и доступен весь функционал.

## Разрушение кластера

Вывести ноду из кластера можно из локального меню или веб-интерфейса. При этом та нода, с которой выполняется выход, остаётся работать. А вторая нода сбрасывает настройки до состояния только что установленного Ideco UTM.

<details>

<summary>Разрушение кластера из локального меню</summary>

1\. Выберите пункт локального меню **Разрушение кластера**.

2\. Появится предупреждающая надпись:

<img src="/.gitbook/assets/cluster-warning-local.png" alt="" data-size="original">

3\. Введите **y** и нажмите **Enter**.

</details>

<details>

<summary>Разрушение кластера из веб-интерфейса</summary>

1\. Перейдите в раздел **Управление сервером -> Кластеризация** и нажмите кнопку **Разрушить кластер**.

2\. Появится окно с предупреждением:

<img src="/.gitbook/assets/cluster-warning.png" alt="" data-size="original">

3\. Нажмите **ОК**.

<img src="/.gitbook/assets/cluster-kill.png" alt="" data-size="original">

</details>

## Процедура обновления нод

Для того чтобы обновить UTM до последней версии в режиме кластера необходимо выполнить следующие действия:

1.  Запустите обновление активной ноды. В процессе обновления произойдёт её перезагрузка. После перезагрузки резервная нода станет активной, переведя текущие задачи обработки трафика на себя.

    При этом кластер не будет работоспособен, так как оба устройства должны иметь одну версию системы, идентичную вплоть до номера сборки.
2. Дождитесь, когда активная нода скачает обновление и запустите его. После завершения обновления кластер вновь будет работоспособен.
