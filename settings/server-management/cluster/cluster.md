---
description: >-
  В разделе описывается настройка кластера, состоящего из двух серверов Ideco
  NGFW.
---

# Кластеризация

{% hint style="success" %}
Название службы раздела **Кластеризация**: `ideco-cluster-backend`; `ideco-cluster-backup-pusher`. \
Список служб для других разделов доступен по [ссылке](/settings/server-management/terminal/README.md).
{% endhint %}

Каждое из двух устройств Ideco NGFW, объединенных в кластер, называется нодой.

Кластер работает в режиме active-passive: 

* **Активной** является нода, обрабатывающая трафик в данный момент. 
* **Резервная** нода находится в предзагруженном состоянии и непрерывно мониторит состояние активной ноды, а при отсутствии связи с ней переводит текущие задачи обработки трафика на себя. 

{% hint style="warning" %}
В любой момент обрабатывать трафик может только одна из нод. 

**Административно переключить ноды нельзя.**
{% endhint %}

Сетевое взаимодействие между нодами осуществляется по *Кластерной сети*. Это физический канал, под который на каждой из нод резервируется по одному физическому порту. Веб-сервер активной ноды управляет кластером, а резервная нода постоянно готова принимать данные. При переключении нод пассивная нода полностью прогружается и становится активной.

Если IP-адреса кластера настроены вручную, то он имеет один общий IP на внутреннем интерфейсе и другой общий IP на внешнем интерфейсе. В случае автоматической конфигурации по DHCP адреса будут отличаться в зависимости от ноды.

## Процесс синхронизации нод в кластере

* При синхронизации двух NGFW данные активной ноды копируются в резервную ноду. Вся информация на резервной ноде перезаписывается;
* Синхронизация данных происходит автоматически в фоновом режиме;
* Автоматические бэкапы отключены на резервной ноде. Все бэкапы с активной ноды передаются на резервную в момент обмена данными и заменяют те бэкапы, которые там присутствовали ранее.

{% hint style="danger" %}
Для корректной работы кластера необходимо постоянное наличие связи между нодами. Для моментального переключения ноды следует соединять прямым линком, не используя мост или коммутатор.

Обмен данными между нодами кластера происходит раз в три минуты. Все несинхронизированные пользовательские изменения настроек и бэкапы **могут быть потеряны, если с момента внесения изменений на активной ноде до переключения нод не было обмена данными**.
{% endhint %}

## Диагностика нод кластера

<details>
<summary>Проверить статус текущей ноды</summary>

Имя сервера активной ноды отображается в левом верхнем углу веб-интерфейса, под именем кластера.

Для проверки статуса текущей ноды:

1\. Перейдите в раздел **Управление сервером -> Терминал** веб-интерфейса NGFW или в консоль в локальном меню.

2\. Введите команду:

```
etcdctl_rt get /cluster/status/v1/record
```

Вывод команды:

* `{"state": "ACTIVE"}` - текущая нода - активная;
* `{"state": "RESERVE"}` - текущая нода - резервная;
* `{"state": "NOT_CONFIGURED"}` - кластер не настроен.

</details>

<details>
<summary>Проверить состояние резервной ноды</summary>

Резервная нода доступна, если в разделе **Управление сервером -> Кластеризация** присутствует сообщение о том, что связь с сервером установлена.

Проверить статусы интерфейсов и модулей резервной ноды можно, подключившись к ней по ssh (это возможно только в кластере **С синхронизацией сессий**). Для этого:

1\. На активной ноде перейдите в раздел **Управление сервером -> Терминал**.

2\. Введите команду `ideco-ssh-another-node` для подключения по ssh к резервной ноде.

3\. Воспользуйтесь командами:

* `ip a` - для проверки статуса сетевых интерфесов резервной ноды;
* `systemctl status <название службы Ideco NGFW>` - для проверки статуса служб Ideco NGFW.

</details>

## Особенности работы кластера

<details>
<summary>Особенности работы кластера с синхронизацией сессий</summary>

* При переключении на резервную ноду изменения с активной ноды применяются к etcd, бэкапам, ClickHouse на резервной ноде. Изменения не применяются к логам journald и мониторинга, а также аппаратным данным;

* Время переключения нод - 15 сек. В 18 версии при пропадании линка между нодами переключение происходит моментально;

* При переключении происходит синхронизация данных приложений с активной ноды на резервную;

* Нода, на которой есть внесенные администратором изменения, будет оставаться активной до синхронизации данных с резервной нодой;

* При отключении линка локальной/внешней сети активная нода становится резервной, резервная становится активной.

* При отключении линка локальной/внешней сети активной становится нода, у которой больше активных линков. Резервной - нода, у которой меньше активных линков.

* При одинаковом количестве отключенных линков на обеих нодах активной становится нода, у которой было меньше всего деградации сети (разрывов). Резервной - нода, у которой было больше всего разрывов.

* При одинаковом количестве отключенных/включенных линков на обеих нодах и одинаковом количестве разрывов сети активной становится нода, у которой больше uptime (запущена раньше). Резервной - нода, у которой uptime меньше (запущена позднее).

</details>

<details>
<summary>Особенности работы кластера без синхронизации сессий</summary>

* При переключении на резервную ноду синхронизируются все данные с диска активной ноды (синхронизация осуществляется за счет копирования файлов в файловой системе);

* Время переключения нод - 15 сек + загрузка резервной ноды;

* При переключении нод не синхронизируются логи мониторинга и journald, а также аппаратные данные.

</details>

<details>
<summary>Особенности работы с бэкапами при кластеризации</summary>

* Невозможно полное восстановление из бэкапов. При этом можно создать резервную копию и после разрушения кластера восстановить копию на ноде, которая была активной;

* На активной ноде доступно **Мгновенное восстановление из бэкапа**. Восстанавливаются все настройки, кроме использованного трафика по квотам, изменений в списке пользователей и отчетах. Данные на второй ноде также придут в соответствие с восстановленными настройками после синхронизации нод.

</details>

## Возможные проблемы при работе двух Ideco NGFW в кластере

* Почта будет доступна для работы только в режиме почтового релея. Хранение почтовых ящиков отключено;

* Два NGFW с разными версиями не синхронизируются;

* При обновлении Ideco NGFW в кластере сначала обновится активная нода, затем резервная нода с младшей версией принудительно станет активной для обновления до версии активной ноды.

* При различных размерах жестких дисков могут возникнуть проблемы синхронизации из-за нехватки места;

* Если у провайдера имеется привязка по MAC-адресу, то при переключении нод будет отсутствовать доступ в интернет;

* Если с момента создания бэкапа на активной ноде до переключения нод не было синхронизации данных между нодами, после переключения этот бэкап будет потерян;

* Если с момента мгновенного восстановления из бэкапа на активной ноде до переключения нод не было синхронизации данных между нодами, после переключения вторая нода окажется в состоянии до восстановления. 

{% hint style="danger" %}
**Не рекомендуем создавать VCE на нодах кластера.** Если в кластере на одной из нод был создан [VCE](/settings/server-management/vce.md), со второй нодой будут синхронизироваться только данные таблицы раздела **Управление сервером -> VCE**. После переключения на пассивной ноде будет создан VCE с тем же именем и комментарием, но внутренние настройки созданных на первой ноде VCE (администраторы, сетевые интерфейсы, политики безопасности и т. д.) не перенесутся.
{% endhint %}




