# Порядок обработки веб-трафика в Ideco NGFW

Порядок обработки веб-трафика:

1\. DNS.

2\. Захват трафика для DPI:

* Контроль приложений;
* Ограничение скорости;
* Система предотвращения вторжений.

3\. Захват трафика для фильтрации (прокси-сервер):

* Контент-фильтр;
* Антивирус веб-трафика.

4\. Файрвол.

{% hint style="info" %}
INPUT-правила Файрвола обрабатывают трафик раньше прокси-сервера.
{% endhint %}

## Как проверить, что заблокирует трафик первым: Контроль приложений или система Предотвращения вторжений?

Для примера заблокируем **WeChat** для **User1**.

1\. Перейдите в раздел **Контроль приложений** и создайте правило, блокирующее протокол **WeChat** для **User1**:

![](/.gitbook/assets/processing-order3.png)

2\. Убедитесь, что в разделе **Предотвращение вторжений** активно правило блокировки GeoIP cтран Юго-Восточной Азии:

![](/.gitbook/assets/processing-order4.png)

3\. Авторизуйте **User1** с устройства на Windows и попробуйте зайти на сайт `https://www.wechatapp.com/`.

4\. Перейдите в **Управление сервером -> Терминал** для просмотра логов **Контроля приложений**/системы **Предотвращение вторжений** и выполните команду:

```
journalctl -u ideco-app-control@Leth<номер локального интерфейса>.service -S today
```

_Номер локального интерфейса можно узнать в Терминале, выполнив команду `ip a` ._

В логах **Контроля приложений** появятся записи о блокировке протокола **WeChat**:

```
мар 11 13:06:31 localhost app-control[2547]: (flow_info_rules_was_checked) 192.168.0.10:1453 -> 43.159.18.10:443 [WeChat] = 'DROP'.
мар 11 13:06:55 localhost app-control[2547]: (flow_info_rules_was_checked) 192.168.0.10:1456 -> 43.159.18.10:443 [WeChat] = 'DROP'.
мар 11 13:06:55 localhost app-control[2547]: (flow_info_rules_was_checked) 192.168.0.10:1457 -> 43.159.18.10:443 [WeChat] = 'DROP'.
```

В **Правила трафика -> Предотвращение вторжений -> Журнал** записей о срабатывании правила **GeoIP cтран Юго-Восточной Азии** нет. Значит, **Контроль приложений** обрабатывает трафик приоритетнее, чем система **Предотвращения вторжений**.

{% hint style="info" %}
Подробнее о расшифровке передаваемых логов системы **Предотвращения вторжений** и **Контроля приложений** в статье [Syslog](/settings/reports/syslog.md).
{% endhint %}

## Как проверить, что система Предотвращения вторжений обрабатывает трафик приоритетнее, чем Файрвол?

Для примера создайте GeoIP-правила для системы **Предотвращения вторжений** и **Файрвола**, блокирующие запросы к сайтам Бразилии.

1\. В разделе **Правила трафика -> Файрвол** создайте правило, блокирующее запросы к сайтам Бразилии:

![](/.gitbook/assets/processing-order5.png)

2\. Переведите ползунок **Счетчик срабатываний** в **Отображении данных** в положение **включен**, чтобы отследить, было ли срабатывание правила.

3\. Перейдите во вкладку **Логирование**, создайте правило логирования:

![](/.gitbook/assets/processing-order6.png)

4\. Проверьте, что в разделе **Предотвращения вторжений** включен блок правил блокировки стран Южной Америки по GeoIP:

![](/.gitbook/assets/processing-order7.png)

5\. Авторизуйте пользователя и зайдите на любой сайт, находящийся в Бразилии, например, `www.gov.br`. Сайт не должен открыться.

6\. В разделе **Правила трафика -> Предотвращение вторжений -> Журнал** появится запись о блокировке GeoIP Бразилии:

![](/.gitbook/assets/processing-order8.png)

7\. Перейдите в раздел **Файрвол** для просмотра счетчика срабатываний. Он должен быть равен нулю.

Если отключить систему **Предотвращения вторжений** и снова перейти на сайт `www.gov.br`, то в логах срабатывания **Файрвола** начнут появляться записи о блокировке:

```
янв 19 17:44:13 localhost ideco-nflog[770]: TCP      src 192.168.105.3    sport 43431 dst 200.9.249.66     dport 443   table FWD  rule  4    action drop
янв 19 17:44:13 localhost ideco-nflog[770]: TCP      src 192.168.105.3    sport 35191 dst 200.9.249.66     dport 443   table FWD  rule  4    action drop
```

Счетчик срабатываний запрещающего правила начал расти, так как трафик, будучи не заблокированным выключенной системой **Предотвращения вторжений**, пошел далее по приоритету и начал блокироваться **Файрволом**:

![](/.gitbook/assets/processing-order9.png)

Система **Предотвращения вторжений** обрабатывает трафик приоритетнее, чем **Файрвол**.

## Как проверить, что Контент-фильтр обрабатывает трафик приоритетнее, чем Антивирус веб-трафика?

Для примера использовался тестовый файл с Eicar, доступный для скачивания по [ссылке](https://secure.eicar.org/eicar.com.txt) и создан *User1*.

1\. Перейдите в раздел **Правила трафика -> Контент фильтр -> Пользовательские категории**.

2\. Нажмите **Добавить** для создания пользовательской категории. Введите ссылку на ресурс и нажмите ![](/.gitbook/assets/icon-add.png):

![](/.gitbook/assets/processing-order.png)

3\. Перейдите во вкладку **Правила** и создайте два правила для **User1**:

* Правило расшифровки всех HTTPS-запросов, чтобы антивирус мог работать с HTTPS-трафиком;
* Правило блокировки созданной пользовательской категории:

![](/.gitbook/assets/processing-order1.png)

4\. Убедитесь, что раздел **Антивирусы веб-трафика** переведен в положение **Включен**:

![](/.gitbook/assets/processing-order.gif)

5\. Авторизуйте пользователя и перейдите по ссылке на скачивание Eicar.\
Откроется страница блокировки контент-фильтра:

![](/.gitbook/assets/processing-order2.png)

Контент-фильтр обрабатывает трафик приоритетнее, чем антивирусы. Просмотреть информацию о срабатывании правил **Контент-фильтра** можно в **Отчеты -> Трафик -> Топ сайтов**.
