# Порядок обработки веб-трафика в Ideco UTM

Порядок обработки веб-трафика:

1\. DNS \
2\. Захват трафика для DPI: 
* Контроль приложений;
* Ограничение скорости;
* Система предотвращения вторжений.
  
3\. Файрвол \
4\. Захват трафика для фильтрации (прокси-сервер)
* Контент-фильтр;
* Антивирус веб-трафика.


## Как проверить, что заблокирует трафик первым: Контроль приложений или система Предотвращения вторжений?

Для примера заблокируем обновления **Windows** для **Пользователя 1**.

1\. Переходим в раздел Контроль-приложений и создаем правило, блокирующее протокол **Windowsupdate** для **Пользователя 1**:

![](/.gitbook/assets/processing-order3.png)

2\. Убедимся, что в разделе **Предотвращение вторжений** активно правило блокировки обновлений Windows:

![](/.gitbook/assets/processing-order4.png)

3\. Авторизуем **Пользователя 1** с устройства на Windows и проверим обновление системы;

4\. Переходим в **Управление сервером -> Терминал** для просмотра логов **Контроля приложений**/системы **Предотвращение вторжений** и выполняем команду:

```
journalctl -u ideco-app-control@Leth<номер локального интерфейса>.service -S today
```

*Номер локального интерфейса можно узнать в Терминале, выполнив команду `ip a `.*

В логах **Контроля приложений** видим записи о блокировке протокола **Windowsupdate**:

```
янв 19 17:27:30 localhost app-control[2025]: (flow_info_rules_was_checked) 192.168.105.3:58099 -> 192.168.105.2:53 [WindowsUpdate] = 'DROP'.
янв 19 17:27:34 localhost app-control[2025]: (flow_info_rules_was_checked) 192.168.105.3:58130 -> 192.168.105.2:53 [WindowsUpdate] = 'DROP'.
янв 19 17:27:47 localhost app-control[2025]: (flow_info_rules_was_checked) 192.168.105.3:60780 -> 192.168.105.2:53 [WindowsUpdate] = 'DROP'.
```

В **Правила трафика -> Предотвращение вторжений -> Журнал** записей о срабатывании правила **Обновление Windows** нет. Значит **Контроль приложений** обрабатывает трафик приоритетнее, чем система **Предотвращения вторжений**.

{% hint style="info" %}
Подробнее о расшифровке передаваемых логов системы **Предотвращения вторжений** и **Контроля приложений** в статье [Syslog](../../settings/reports/syslog.md). 
{% endhint %}

## Как проверить, что система Предотвращения вторжений обрабатывает трафик приоритетнее, чем Файрвол?

Для примера создадим GeoIP-правила для системы **Предотвращения вторжений** и **Файрвола**, блокирующие запросы к сайтам Бразилии.

1\. В разделе **Правила трафика -> Файрвол** создаем правило, блокирующее запросы к сайтам Бразилии:

![](/.gitbook/assets/processing-order5.png)

2\. Переводим ползунок **Счетчик срабатываний** над таблицей в положение **включен**, чтобы отследить, было ли срабатывание правила;

3\. Переходим во вкладку **Логирование**, создаем правило логирования:

![](/.gitbook/assets/processing-order6.png)

4\. Проверяем, что в разделе **Предотвращения вторжений** включён блок правил блокировки стран Южной Америки по GeoIP:

![](/.gitbook/assets/processing-order7.png)

5\. Авторизуем пользователя и заходим на любой сайт, находящийся в Бразилии, например, cbf.com.br. Сайт не должен открыться;

6\. В разделе **Правила трафика -> Предотвращение вторжений -> Журнал** появится запись о блокировке GeoIP Бразилии:

![](/.gitbook/assets/processing-order8.png)

7\. Переходим в раздел **Файрвол** для просмотра счетчика срабатываний. Он должен быть равен нулю. 

Если отключить систему **Предотвращения вторжений** и снова перейти на сайт cbf.com.br, то в логах срабатывания **Файрвола** начали появляться записи о блокировке:

```
янв 19 17:44:13 localhost ideco-nflog[770]: TCP      src 192.168.105.3    sport 43431 dst 200.9.249.66     dport 443   table FWD  rule  4    action drop
янв 19 17:44:13 localhost ideco-nflog[770]: TCP      src 192.168.105.3    sport 35191 dst 200.9.249.66     dport 443   table FWD  rule  4    action drop
```
Счётчик срабатываний запрещающего правила начал расти, так как трафик, будучи не заблокированным выключенной системой **Предотвращения вторжений**, пошёл далее по приоритету и начал блокироваться **Файрволом**:

![](/.gitbook/assets/processing-order9.png)

Система **Предотвращения вторжений** обрабатывает трафик приоритетнее, чем **Файрвол**.

## Как проверить, что контент-фильтр обрабатывает трафик приоритетнее, чем антивирус веб-трафика? 

Для примера использовался тестовый файл с Eicar, доступный для скачивания по [ссылке](https://secure.eicar.org/eicar.com.txt) и создан *Пользователь 1*.

1\. Переходим **Правила трафика -> Контент фильтр -> Пользовательские категории**;

2\. Нажимаем **Добавить** для создания пользовательской категории и заполняем, как на изображении:

![](/.gitbook/assets/processing-order.png)

3\. Переходим во вкладку **Правила** и создаем два правила для **Пользователя 1**:

* Правило расшифровки всех HTTPS-запросов, чтобы антивирус мог работать с HTTPS-трафиком;
* Правило блокировки созданной пользовательской категории.

![](/.gitbook/assets/processing-order1.png)

4\. Убедимся, что раздел **Антивирусы веб-трафика** переведен в положение **Включен**:

![](/.gitbook/assets/processing-order.gif)

5\. Авторизуем пользователя и переходим по ссылке на скачивание Eicar. \
Откроется страница блокировки контент-фильтра:

![](/.gitbook/assets/processing-order2.png)

Контент-фильтр обрабатывает трафик приоритетнее, чем антивирусы. Просмотреть информацию о срабатывании правил **Контент-фильтра** можно в **Отчеты -> Трафик -> Топ сайтов**.
