# Порядок обработки веб-трафика в Ideco NGFW

Порядок обработки веб-трафика:

1\. Ограничение скорости;

2\. DNS;

3\. Захват трафика для фильтрации (прокси-сервер):

* Контент-фильтр;
* Антивирус веб-трафика.

4\. Файрвол;

5\. Контроль приложений;

6\. Система предотвращения вторжений.

{% hint style="info" %}
INPUT-правила Файрвола обрабатывают трафик раньше прокси-сервера.
{% endhint %}

## Как проверить, что заблокирует трафик первым: Контроль приложений или система Предотвращения вторжений?

Для примера заблокируем **TunnelBear** для **User1**.

1\. Перейдите в раздел **Профили безопасности ->** [**Контроль приложений**](settings/security-profiles/application-control.md) и создайте профиль, запрещающий **TunnelBear**:

![](/.gitbook/assets/application-control9.png)

2\. В разделе **Правила трафика -> Файрвол** добавьте и включите правило, запрещающее **TunnelBear** для **User1**.

3\. Убедитесь, что в разделе **Профили безопасности -> Предотвращение вторжений** активно правило блокировки **Анонимайзеры**:

![](/.gitbook/assets/ips2.png)

4\. Авторизуйте **User1** с устройства на Windows и попробуйте зайти на сайт `https://www.tunnelbear.com/`.

5\. Перейдите в **Управление сервером -> Терминал** для просмотра логов **Контроля приложений**/системы **Предотвращение вторжений** и выполните команду:

```
journalctl -u ideco-app-control@Leth<номер локального интерфейса>.service -S today
```

_Номер локального интерфейса можно узнать в Терминале, выполнив команду `ip a` ._

В логах **Контроля приложений** появятся записи о блокировке протокола **TunnelBear**:

```
июн 26 16:11:45 localhost app-control[29554]: (flow_info_rules_was_checked) 192.168.100.150:52168 -> 104.17.154.236:443 [TunnelBear] = 'DROP'.
июн 26 16:12:04 localhost app-control[29554]: (flow_info_rules_was_checked) 192.168.100.150:52169 -> 104.17.155.236:443 [TunnelBear] = 'DROP'.
июн 26 16:12:23 localhost app-control[29554]: (flow_info_rules_was_checked) 192.168.100.150:52170 -> 104.17.154.236:443 [TunnelBear] = 'DROP'.
```

В **Правила трафика -> Предотвращение вторжений -> Журнал** записей о срабатывании правила **Анонимайзеры** нет. Значит, **Контроль приложений** обрабатывает трафик приоритетнее, чем система **Предотвращения вторжений**.

{% hint style="info" %}
Подробнее о расшифровке передаваемых логов системы **Предотвращения вторжений** и **Контроля приложений** в статье [Syslog](/settings/reports/syslog.md).
{% endhint %}

## Как проверить, что система Предотвращения вторжений обрабатывает трафик приоритетнее, чем Файрвол?

Для примера создайте GeoIP-правила для системы **Предотвращения вторжений** и **Файрвола**, блокирующие запросы к сайтам Польши.

1\. В разделе **Правила трафика -> Файрвол** создайте правило, блокирующее запросы к сайтам Польши:

![](/.gitbook/assets/firewall16.png)

2\. Переведите ползунок **Счетчик срабатываний** в **Отображении данных** в положение **Включен**, чтобы отследить, было ли срабатывание правила.

3\. Перейдите на вкладку **Логирование**, создайте правило логирования:

![](/.gitbook/assets/firewall17.png)

4\. Проверьте, что в разделе **Профили безопасности -> Предотвращения вторжений** включен блок правил блокировки стран Восточной Европы по GeoIP:

![](/.gitbook/assets/ips6.png)

5\. Авторизуйте пользователя и зайдите на любой польский сайт, например, `www.gov.pl`. Сайт не должен открыться.

6\. В разделе **Отчеты и журналы -> События безопасности -> Журнал IPS** появится запись о блокировке GeoIP Польши:

![](/.gitbook/assets/security-events.png)

7\. Перейдите в раздел **Правила трафика -> Файрвол** для просмотра счетчика срабатываний. Он должен быть равен нулю.

Если отключить систему **Предотвращения вторжений** и снова перейти на сайт `www.gov.pl`, то в логах срабатывания **Файрвола** начнут появляться записи о блокировке:

```
янв 19 17:44:13 localhost ideco-nflog[770]: TCP      src 192.168.105.3    sport 43431 dst 200.9.249.66     dport 443   table FWD  rule  4    action drop
янв 19 17:44:13 localhost ideco-nflog[770]: TCP      src 192.168.105.3    sport 35191 dst 200.9.249.66     dport 443   table FWD  rule  4    action drop
```

Информацию о том, как просмотреть логи срабатывания **Файрвола**, можно найти по [ссылке](/settings/server-management/terminal.md).

Счетчик срабатываний запрещающего правила начал расти, так как трафик, будучи не заблокированным выключенной системой **Предотвращения вторжений**, пошел далее по приоритету и начал блокироваться **Файрволом**:

![](/.gitbook/assets/firewall18.png)

Система **Предотвращения вторжений** обрабатывает трафик приоритетнее, чем **Файрвол**.

## Как проверить, что Контент-фильтр обрабатывает трафик приоритетнее, чем Антивирус веб-трафика?

Для примера использовался тестовый файл с Eicar, доступный для скачивания по [ссылке](https://secure.eicar.org/eicar.com.txt).

1\. Перейдите в раздел **Правила трафика -> Контент-фильтр -> Пользовательские категории**. Нажмите **Добавить**.

2\. Введите ссылку на ресурс и нажмите ![](/.gitbook/assets/icon-add.png):

![](/.gitbook/assets/content-filter14.png)

3\. Перейдите на вкладку **Правила** и создайте два правила для **User1**:

* Правило расшифровки всех HTTPS-запросов, чтобы антивирус мог работать с HTTPS-трафиком;
* Правило блокировки созданной пользовательской категории:

![](/.gitbook/assets/content-filter15.png)

4\. Убедитесь, что опция **Антивирусы веб-трафика** переведена в положение **Включен**:

![](/.gitbook/assets/antivirus.gif)

5\. Авторизуйте пользователя и перейдите по ссылке на скачивание Eicar.\
Откроется страница блокировки **Контент-фильтра**:

![](/.gitbook/assets/processing-order.png)

**Контент-фильтр** обрабатывает трафик приоритетнее, чем антивирусы. Просмотреть информацию о срабатывании правил **Контент-фильтра** можно в **Отчеты -> Трафик -> Топ сайтов**.
