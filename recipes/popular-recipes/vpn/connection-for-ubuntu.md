# Инструкция по созданию VPN-подключения в Ubuntu

{% hint style="info" %}
Перед настройкой VPN-подключения, в дереве пользователей в карточке нужных пользователей и установите флаг **Разрешить удаленный доступ через VPN**. Для этого перейдите в раздел **Пользователи -&gt; Учетные записи**:

![](../../../../.gitbook/assets/ubuntu15.png)
{% endhint %}

<details>

<summary>Протокол PPTP</summary>

Перед созданием подключения в Ubuntu перейдите в Ideco UTM, в раздел **Пользователи -&gt; Авторизация -&gt; VPN-подключение** и установите флаг **Подключение по PPTP**:

![](../../../../.gitbook/assets/pptp.png)

**Создание подключения в Ubuntu**

1\. Перейдите **Настройки -> Сети** и в строке **VPN** нажмите ![ok\_with\_icon.png](../../../../.gitbook/assets/ubuntu3.png):

![](../../../../.gitbook/assets/ubuntu2.png)

2\. В окне создания подключений выберите пункт **Туннельный протокол типа точка-точка (PPTP)**:

![](../../../../.gitbook/assets/ubuntu4.1.png)

3\. В разделе **Идентификация** и заполните следующие поля:

* **Название** - имя подключения;
* **Шлюз** - доменное имя или IP-адрес интерфейса UTM;
* **Имя пользователя** - имя пользователя, которому разрешено подключение по VPN;
* **Пароль** - пароль пользователя. В правой части поля необходимо выбрать вариант хранения для пароля от VPN-соединения;
* **NT-домен** - оставьте поле пустым.

![](../../../../.gitbook/assets/ubuntu6.1.png)

Рекомендуем нажать **Дополнительно** и установить флаги на пунктах:

* **Разрешить следующие методы аутентификации** - установите флаг на пункте *MSCHAPv2*
* **Использовать шифрование MPPE** - в строке *Шифрование* выберите 128-бит (наиболее защищенное)
* **Использовать для данных сжатие BSD** - использование алгоритма BSD-compress
* **Использовать для данных сжатие Deflate** - использование алгоритма Deflate
* **Использовать сжатие заголовков TCP** - использование метода сжатия заголовков TCP/IP Вана Якобсона

![](../../../../.gitbook/assets/ubuntu8.1.png)

4\. Нажмите **ОК** и **Добавить**.

5\. Поставить переключатель созданного VPN-подключения в положение включен:

![](../../../../.gitbook/assets/ubuntu9.1.png)

</details>

<details>

<summary>Протокол IKEv2/IPSec</summary>

Перед созданием подключения в Ubuntu, настройте Ideco UTM:

1\. Перейдите в раздел **Пользователи -&gt; Авторизация -&gt; VPN-подключение**.

2\. Установите флаг **Подключение по IKEv2/IPSec** и заполните поле **Домен**:

![](../../../../.gitbook/assets/ipsec-ikev2-9-11.png)

3\. Скачайте корневой сертификат одним из способов:

* В личном кабинете, введя логин/пароль пользователя:
  
    ![](../../../../.gitbook/assets/ubuntu16.png)

* В разделе **Сервисы -&gt; Сертификаты**:
    
    ![](../../../../.gitbook/assets/certificates2.png)

Корневой сертификат потребуется для настройки подключения рабочей станции пользователя, если не был получен корневой сертификат через Lets Encrypt. При необходимости перенесите файл сертификата на рабочую станцию.

{% hint style="info" %}
Если для VPN-подключения используется сертификат выданный Let`s Encrypt, то установка корневого сертификата на устройство не требуется.
{% endhint %}

**Создание подключения в Ubuntu**

1\. Откройте терминал сочетанием клавиш Ctrl+Alt+F1 и выполните команду:

    sudo apt install -y network-manager-strongswan libcharon-extra-plugins libstrongswan-extra-plugins

2\. После окончания установки перезагрузите компьютер:

    sudo reboot

3\. Перейдите в **Настройки -> Сети** и в строке **VPN** нажмите ![ok\_with\_icon.png](../../../../.gitbook/assets/ubuntu3.png):

![](../../../../.gitbook/assets/ubuntu2.png)

4\. В появившемся окне выберите **IPSec\IKEv2 (strongswan)**:

![](../../../../.gitbook/assets/ubuntu13.png)

5\. В разделе **Идентификация** и заполните следующие поля:

* **Название** - имя подключения
* **Address** - введите домен, который указан в настройках **Пользователи -&gt; Авторизация -&gt; VPN-подключение -&gt; Подключение по IKEv2/IPSec**
* **Certificate** - выберите ранее сохраненный корневой сертификат (если он не был выдан Let`s Encrypt)
* **Authentication** - рекомендуем выбрать EAP
* **Username** - имя пользователя, которому разрешено подключение по VPN
* **Password** - пароль пользователя. В правой части поля необходимо выбрать вариант хранения для пароля от VPN-соединения

Установите флаг **Request an inner IP address** и нажмите **Добавить:**

![](../../../../.gitbook/assets/ubuntu14.png)

6\. Поставьте переключатель созданного VPN-подключения в положение включен.

</details>

<details>

<summary>Протокол SSTP</summary>

Перед созданием подключения в Ubuntu, настройте Ideco UTM:

1\. Перейдите в раздел **Пользователи -&gt; Авторизация -&gt; VPN-подключение**.

2\. Установите флаг **Подключение по SSTP** и заполните поля **Домен** и **Порт**:

![](../../../../.gitbook/assets/sstp-on.png)



**Создание подключения в Ubuntu**

1\. Откройте терминал сочетанием клавиш Ctrl+Alt+F1 и выполните две команды:

    sudo apt-add-repository ppa:eivnaes/network-manager-sstp
    sudo apt install -y network-manager-sstp sstp-client 

2\. После окончания установки перезагрузите компьютер:

    sudo reboot
    
3\. После окончания установки пакетов, перейдите в **Настройки -> Сети** и в строке **VPN** нажмите ![ok\_with\_icon.png](../../../../.gitbook/assets/ubuntu3.png):

![](../../../../.gitbook/assets/ubuntu2.png)

4\. В появившемся окне выберите **Туннельный протокол типа точка-точка (SSTP)**:

![](../../../../.gitbook/assets/ubuntu10.png)

5\. В разделе **Идентификация** и заполните следующие поля:

* **Название** - имя подключения
* **Шлюз** - укажите в формате *домен:[порт, выбранный на UTM]*
* **Имя пользователя** - имя пользователя, которому разрешено подключение по VPN
* **Пароль** - пароль пользователя. В правой части поля необходимо выбрать вариант хранения для пароля от VPN-соединения
* **NT-домен** - оставьте поле пустым

![](../../../../.gitbook/assets/ubuntu11.png)

Рекомендуем нажать **Advanced** и установить флаги на пунктах:

* **Разрешить следующие методы аутентификации** - установите флаг на пункте *MSCHAPv2*
* **Использовать шифрование MPPE** - в строке *Шифрование* выберите 128-бит (наиболее защищенное)
* **Использовать для данных сжатие BSD** - использование алгоритма BSD-compress
* **Использовать для данных сжатие Deflate** - использование алгоритма Deflate
* **Использовать сжатие заголовков TCP** - использование метода сжатия заголовков TCP/IP Вана Якобсона

6\. Нажмите **Добавить** и поставьте переключатель созданного VPN-подключения в положение включен:

![](../../../../.gitbook/assets/ubuntu12.png)

</details>

<details>

<summary>Протокол L2TP/IPSec</summary>

**Важно:** L2TP IPsec клиенты, находящиеся за одним NAT'ом, могут испытывать проблемы подключения если их более одного. Рекомендуем вместо L2TP IPsec использовать IKEv2 IPSec.

Перед созданием подключения, настройте Ideco UTM:

1\. Перейдите в раздел **Пользователи -&gt; Авторизация -&gt; VPN-подключение**.

2\. Установите флаг **Подключение по L2TP/IPSec** и скопируйте **PSK**-ключ:

![](../../../../.gitbook/assets/l2tp-on.png)

**Создание подключения в Ubuntu** 

1\. Подключите репозиторий, в котором находятся необходимые пакеты для создания L2TP VPN-соединения, а затем обновите информацию о репозиториях. Для этого выполните следующие команды:

    sudo add-apt-repository ppa:nm-l2tp/network-manager-l2tp
    sudo apt update

2\. Установите дополнение к стандартному NetworkManager с помощью двух пакетов:

    sudo apt install -y network-manager-l2tp network-manager-l2tp-gnome

3\. После окончания установки перезагрузите компьютер:

    sudo reboot

4\. После окончания установки пакетов, перейдите в **Настройки -> Сети** и в строке **VPN** нажмите ![ok\_with\_icon.png](../../../../.gitbook/assets/ubuntu3.png):

![](../../../../.gitbook/assets/ubuntu2.png)

5\. В окне создания подключений по VPN выберите пункт **Layer 2 Tunneling Protocol (L2TP)**:

![](../../../../.gitbook/assets/ubuntu5.png)

6\. Во вкладке **Идентификация** и заполните следующие поля:

* **Название** - имя подключения
* **Шлюз** - доменное имя или IP-адрес интерфейса UTM
* **Тип** - Password-аутентификация по пользователю и паролю
* **Имя пользователя** - имя пользователя, которому разрешено подключение по VPN
* **Пароль** - пароль пользователя. В правой части поля необходимо выбрать вариант хранения для пароля от VPN-соединения
* **NT-домен** - оставьте поле пустым

![](../../../../.gitbook/assets/ubuntu6.png)

7\. Перейдите в **Настройки IPSec** и включите опцию **Enable IPsec tunnel to L2TP host**, чтобы активировалась возможность настраивать остальные параметры:

* **Type: Pre-shared key (PSK)** – аутентификация по общему ключу
* **Pre-shared key** - ключ, который необходимо скопировать по пути **Пользователи -> Авторизация -> VPN-подключение** из поля **PSK**

Раздел **Advanced** необязательный для заполнения. 

![](../../../../.gitbook/assets/ubuntu7.png)

После окончания настройки **L2TP IPsec Options** нажмите **ОК**.

8\. При необходимости перейдите в **Настройки РРР** и настройте раздел **Аутентификация**, **Шифрование и сжатие** и **Прочие**:

![](../../../../.gitbook/assets/ubuntu8.png)

После настройки **Параметры РРР** нажмите **ОК** и **Применить**.

9\. Поставить переключатель созданного VPN-подключения в положение включен:

![](../../../../.gitbook/assets/ubuntu9.png)

</details>