# Настройка почтового сервера

Для настройки почтового сервера в web-интерфейсе необходимо перейти в меню **Сервисы -> Почтовый сервер**. В этом разделе находятся все ключевые параметры, влияющие на работу почтовой службы.\
Все настраиваемые параметры разделены по нескольким категориям, которые описаны ниже.

Наименования разделов в расположенной ниже таблице кликабельны и являются быстрыми ссылками на документацию по соответствующему разделу.

| Категория                                                     | Описание                                                                                                                                                   |
| ------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [Общие](mail-server-settings.md)                              | Основные параметры                                                                                                                                         |
| [Доставка](mail-server-settings.md#dostavka)                  | Параметры, отвечающие за доступ пользователей к почтовому серверу и задающие лимиты почтовых ящиков. Также в разделе настраивается логика сортировки спама |
| [Безопасность](mail-server-settings.md#bezopasnost)           | Параметры, отвечающие за обеспечение безопасности почтового сервера                                                                                        |
| [Расширенные](mail-server-settings.md#rasshirennye-nastroiki) | Расширенные параметры, такие, как копирование всей входящей/исходящей корреспонденции на ящик, загрузка почты с удаленных серверов и общие IMAP-папки      |
| [Антиспам](mail-server-settings.md#antispam)                  | Антиспам на основе технологий Лаборатории Касперского с функцией машинного обучения и искусственного интеллекта                                            |
| [Антивирусы](mail-server-settings.md#antivirusy)              | Антивирус на основе технологий Лаборатории Касперского, а также свободный антивирус ClamAV с открытым исходным кодом                                       |
| [Правила](mail-server-settings.md#pravila)                    | Белый и черный списки доверенных адресов и доменов, правила анализа писем на основе регулярных выражений, а также почтовые алиасы                          |

### Общие настройки

Раздел общих настроек включает в себя множество базовых параметров, необходимых для работы почтового сервера в сети Интернет. Параметры представлены в перечне ниже.

| Параметр                            | Описание                                                                                                                                                                                                                                                                                                                   |
| ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Основной почтовый домен             | Указывает серверу на его почтовый домен, для которого он должен принимать и обрабатывать письма. Все ящики пользователей будут принадлежать этому домену. От имени этого домена вы будете вести переписку с корреспондентами                                                                                               |
| Имя хоста почтового сервера         | Как правило, совпадает с MX-записью для вашего домена. Это имя должно разрешаться из сети Интернет во внешний IP-адрес UTMИспользуется почтовым сервером в диалоге при транспорте почты между другими почтовыми серверами как уникальный идентификатор. Необходимо для корректной работы почтового сервера в сети Интернет |
| Дополнительные почтовые домены      | Дополнительные домены, которые почтовый сервер будет считать своими. Корреспонденция, отправляемая с ящиков в этих почтовых доменах также будет обрабатываться сервером при условии правильной установки MX-записей                                                                                                        |
| Relay-домены                        | Почтовые домены в локальной сети, для которых будут пересылаться письма извне                                                                                                                                                                                                                                              |
| SSL-сертификат для SMTP, IMAP, POP3 | Загрузка бандла SSL-сертификатов, использующихся на почтовом сервере. При первом запуске службы автоматически генерируется и подписываются корневым сертификатом Ideco ICS. Есть возможность установки доверенного сертификата, заверенного удостоверяющим центром, см. инструкцию                                         |

Форма общих настроек показана на фрагменте ниже.

![](../../.gitbook/assets/6586694.png)

### Доставка

В этом разделе перечислены параметры доступа к почтовому серверу и доставки отправлений адресатам.

| Параметр                                                       | Описание                                                                                                                                                                                                                                                                  |
| -------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p>Доступ по IMAP<br>(143, STARTTLS)</p>                       | Задействование возможности работы с почтовыми ящиками сервера по протоколу IMAP (с шифрованием STARTTLS) из локальной сети и Интернет                                                                                                                                     |
| <p>Доступ по POP3(S)<br>(110 STARTTLS, 995)</p>                | Задействование возможности работы с почтовыми ящиками сервера по протоколу POP3 (с шифрованием STARTTLS) из локальной сети и Интернет                                                                                                                                     |
| <p>Использовать<br>web-почту</p>                               | Включение веб-интерфейса почтового клиента для доступа к почте на сервере. Задействует возможность подключения на локальный адрес сервера для клиентов, находящихся в локальной сети                                                                                      |
| <p>Максимальный размер<br>ящика, (МБ)</p>                      | Ограничение на максимальный размер почтового ящика в мегабайтах                                                                                                                                                                                                           |
| <p>Максимальный размер<br>письма, (МБ)</p>                     | Ограничение на максимальный размер формируемого сервером письма в мегабайтах                                                                                                                                                                                              |
| <p>Удалять из корзины письма<br>старее, (дней)</p>             | Указание интервала очистки папки Trash (корзина) с удаленной корреспонденцией                                                                                                                                                                                             |
| Сортировка спама                                               | <p></p><p>Задание логики сортирования нежелательной корреспонденции (спама).<br>На выбор предоставляются следующие опции:</p><ul><li>отключение сортировки,</li><li>перемещение нежелательных отправлений в папку Spam,</li><li>удаление таких писем с сервера.</li></ul> |
| <p>Ящики, исключенные из<br>сортировки и удаления<br>спама</p> | Позволяет задать почтовые ящики, при отправлении на которые корреспонденция не будет проверяться на спам                                                                                                                                                                  |

Форма настроек доставки корреспонденции и доступа к почтовому серверу показана на фрагменте ниже:

![](../../.gitbook/assets/2\_delivery\(7-9\).png)

### Безопасность

Настройки безопасности не только определяют защиту самого почтового сервера, но и позволяют выполнять некоторые требования внутренней политики безопасности предприятия.\
Настройки безопасности приведены в перечне ниже.

| Параметр                                                                     | Описание                                                                                                                                                                                                                                                                                       |
| ---------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p>Принимать почту от других SMTP-серверов<br>по шифрованному соединению</p> | <p>Рекомендуется выбрать параметр "По возможности". При этом письма, передаваемые между<br>почтовыми серверами, поддерживающими шифрование, будут зашифрованы</p>                                                                                                                              |
| Включить поддержку SASL для аутентификации SMTP-клиентов                     | Подключившись к почтовому ящику из интернета, отправить письмо, используя SMTP сервер Ideco,можно будет только пройдя авторизацию по логину и паролю, заданному для этой учетной записи пользователя на сервере. Не включайте данный параметр, если используете ICS в качестве почтового релея |
| Разрешить аутентификацию только через TLS                                    | Запрещает незащищенную передачу учетных данных клиента при аутентификации на SMTP сервере                                                                                                                                                                                                      |
| Фильтрация по серым спискам                                                  | <p>Включает фильтрацию по серым спискам (greylisting) для входящей почты. При этом почта от неизвестных доменов<br>отправителей может приходить с небольшой задержкой</p>                                                                                                                      |
| Фильтрация по DNSBL                                                          | Включает фильтрацию по DNSBL для входящей почты                                                                                                                                                                                                                                                |
| Доверенные сети                                                              | Авторизация на сервере для доступа к почтовому ящику не требуется при попытке доступа из этих сетей. Указываются IP-сети и хосты в нотации CIDR или с префиксом сети, например: 10.0.0.5/255.255.255.255 или 192.168.0.0/16                                                                    |

![](../../.gitbook/assets/3\_security\_sub1\(7-9\).png)

### DKIM-подпись

Настраивается в разделе **Сервисы -> Почтовый сервер -> Безопасность -> DKIM-подпись**. Подписывает исходящую с сервера корреспонденцию уникальной для вашего почтового домена подписью так, что другие почтовые серверы в Интернет могут убедиться, что ваша почта легитимна и заслуживает доверия.

Для функционирования технологии вам потребуется создать TXT запись для вашего домена у держателя зоны со значением, которое сформирует для вашего почтового домена наш сервер. TXT записи будут сформированы для основного почтового домена, настроенного на ICS, и дополнительных почтовых доменов (если указаны). Сервер также проверит, правильно ли была указана запись для вашей зоны и резолвится ли она в Интернет.

![](../../.gitbook/assets/3\_security\_sub2\_dkim.png)

### Почтовая очередь

Эта вкладка раздела **Безопасность** позволяет управлять очередью почтовых отправлений, которые по каким-либо причинам не могут быть прямо сейчас отправлены или получены. Модуль позволяет управлять как входящей, так и исходящей отложенной корреспонденцией. Для анализа возможных причин задержки корреспонденции в очереди вы можете использовать информацию из соответствующегостолбца таблицы для каждого письма. Предусмотрены как выборочные, так и групповые действия с отправлениями в очереди (очистка очереди, повторая отправка отдельного письма, удаление отдельных писем из очереди, повторная отправка всей корреспонденции из очереди).

Форма управления очередью почтового сервера предоставлена на фрагменте ниже.

![](../../.gitbook/assets/security\_sub3\_queue\(7-9\).png)

### Расширенные настройки

Электронная почта является важнейшей составляющей деловых процессов предприятия. Часто случается так, что базовых настроек оказывается недостаточно, и требуется более тонкая настройка, описанная в таблице ниже. В этом разделе описываются дополнительные параметры, которые вы можете определить в Ideco UTM.

| Параметр                                        | Описание                                                                                                                                                                                                                 |
| ----------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Почтовый ящик для спама                         | Весь входящий спам будет пересылаться на этот ящик (не используйте ящик spam)                                                                                                                                            |
| Сортировать спам в IMAP папку Spam              | Письма, определенные как спам, перемещаются в отдельную IMAP папку Spam                                                                                                                                                  |
| Ящики исключения из сортировки и удаления       | Спам, приходящий указанным адресатам, не будет подвергнут сортировке или удалению                                                                                                                                        |
| Внешний SMTP-релей                              | Вся исходящая почта будет отправляться на указанный адрес. Используется, например, в случае, если почта должна проходить через вышестоящий сервер провайдера перед отправкой в интернет                                  |
| Удалять из корзины письма старее                | Удаляются письма старше указанного количества дней из IMAP папок **Удаленные **и **Спам**                                                                                                                                |
| Копировать всю исходящую с домена почту         | Вся исходящая почта будет дублироваться на указанный почтовый ящик. Рекомендуется включать только при крайней необходимости                                                                                              |
| Копировать всю входящую на домен почту          | Вся входящая почта будет дублироваться на указанный почтовый ящик. Рекомендуется включать только при крайней необходимости                                                                                               |
| Копировать всю почту                            | Вся почта будет дублироваться на указанный почтовый ящик. Рекомендуется включать только при крайней необходимости                                                                                                        |
| Дополнительные почтовые домены                  | Список дополнительных доменов, почта которых будет обрабатываться почтовым сервером Ideco UTM                                                                                                                            |
| Загрузка почты с удаленных серверов (fetchmail) | <p>Правила сбора почты с внешних ящиков и ее перенаправления на ящики пользователей сервера.<br>Записываются в соответствии с синтаксисом fetchmail, например: pop3.mymail.ru:pop3 user pass localuser@smtp.ideco.ru</p> |
| Интервал между проверкой почты (fetchmail)      | Интервал в минутах между проверкой доступности новых сообщений на внешних ящиках пользователей для сбора почты с них по правилам fetchmail, указанным выше                                                               |
| Общие IMAP папки                                | Указанные папки будут созданы на сервере и доступны всем пользователям                                                                                                                                                   |

Форма расширенных настроек показана ниже.

![](../../.gitbook/assets/4\_extended\_settings\(7-9\).png)

### Антиспам

Позволяет управлять работой службы антиспама на основе технологий Лаборатории Касперского с функцией машинного обучения и искусственного интеллекта. Также на этой вкладке предоставлена возможность добавления лицензионного ключа антиспама. Ключ поставляется в файле, имеющем расширение .key. Если вы приобретали лицензию на антиспам, но не имеете в своём распоряжении лицензионного ключа, проверьте переписку с отделом продаж нашей компании (sales@ideco.ru) на наличие вложений. В случае, если вы не нашли таких вложений, запросите ключ заново, выслав письмо на **sales@ideco.ru** с указанием наименования вашей организации или номером вашей лицензии.

Форма настройки модуля антиспама Касперского и добавления лицензионного ключа предоставлена ниже.

![](../../.gitbook/assets/5\_klms\_antispam\(7-9\).png)

### Антивирусы

Позволяет управлять состоянием антивирусов, проверяющих вложения сообщений, обрабатываемых почтовым сервером.Также на вкладке отображается дата последнего обновления сигнатур антивирусных баз.

Рекомендуется использование только одного антивируса единовременно.Включение обоих антивирусов возможно, однако не имеет практического смысла. Кроме того, в этом случае потребление аппаратных ресурсов обоими антивирусами может быть неоправданно большим.

Форма настройки состояния антивирусов почтового сервера предоставлена ниже.

![](../../.gitbook/assets/6\_av4mail\(7-9\).png)

### &#x20;Правила&#x20;

#### Переадресация&#x20;

Позволяет настроить переадресацию почты на сервере с помощью почтовых алиасов. Алиасы отличаются от почтовых ящиков тем, что не требуют логинов и паролей, они закрепляются за ящиком и служат его копией с другим именем, или, в случае назначения алиаса нескольким почтовым ящикам, может служить группой рассылки. Поступающая на алиас почта автоматически пересылается на все реальные почтовые ящики, связанные с этим алиасом. Если перенаправление делается на какой-либо ящик в другом домене в интернете, то ящик, прописываемый в графе **Получатель**, должен реально существовать.&#x20;

Подробнее с документацией по настройке почтовых алиасов на Ideco UTM вы можете ознакомиться по этой [ссылке](mail-forwarding.md).&#x20;

Ниже предоставлен пример формы настройки алиасов на сервере.&#x20;

![](../../.gitbook/assets/7\_rules\(7-9\).png)

#### Белый список&#x20;

Позволяет указывать почтовые домены, IP-адреса почтовых серверов и почтовые ящики, отправления с которых не будут проверяться на спам. Если ящик одновременно указан и в чёрном, и в белом списке, последний имеет наивысший приоритет.

Форма настройки белого списка почтового сервера предоставлена ниже.&#x20;

![](../../.gitbook/assets/7\_rules\_whitelist\(7-9\).png)

#### Черный список

&#x20;Позволяет указывать почтовые домены и ящики, отправления с которых не будут приниматься сервером вовсе.Если ящик одновременно указан и в чёрном, и в белом списке, наивысший приоритет имеет белый список.

Форма настройки чёрного списка почтового сервера предоставлена ниже.&#x20;

![](../../.gitbook/assets/7\_rules\_blacklist\(7-9\).png)

#### Правила, заданные вручную&#x20;

Предоставляет интерфейс для указания правил почтового сервера в формате регулярных выражений для Postfix.&#x20;

**Регуля́рные выраже́ния** (англ. _regular expressions, regexp_) — формальный язык поиска и осуществления манипуляций с подстроками в тексте, основанный на использовании метасимволов. Представляет собой строку-образец (англ. _pattern_, по-русски её часто называют «шаблоном», «маской»), состоящую из символов и метасимволов. Строка-образец задаёт правило поиска.

В нашем случае, при помощи регулярных выражений мы находим в письмах интересующие нас слова или символы, после чего разрешаем или запрещаем такую почту.&#x20;

{% hint style="warning" %}
В Ideco UTM мы предоставляем интерфейс для написания регулярных выражений с парой простейших примеров. Составление регулярных выражений - это обязанность администратора.&#x20;

**Техническая поддержка не консультирует пользователей по этим вопросам.**
{% endhint %}

С более подробной документацией по модулю указания правил, заданных вручную, вы можете ознакомиться по этой [ссылке](antispam.md).

Форма написания правил, заданных вручную для почтового сервера предоставлена ниже.

![](../../.gitbook/assets/6586766.png)

### Проверка настроек почтового сервера

Рекомендуется проверить корректность всех настроек DNS и почтового сервера с помощью сервиса: [mail-tester.com](https://mail-tester.com)

При правильной настройке почтовый сервер на Ideco UTM должен получить 10 баллов из 10.
