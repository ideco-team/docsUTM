# Подключение Kerio Control к Ideco UTM по IPSec

По шагам ниже можно объединить сети Kerio Control и Ideco UTM по IPsec с использованием PSK.

**Объединяемые локальные сети не должны пересекаться!**

## Настройка Ideco UTM

1. В веб-интерфейсе Ideco UTM откройте вкладку **Сервисы -&gt; IPSec -&gt; Устройства.**
2. Добавьте новое подключение:
   * Название – _любое;_
   * Тип – _входящее;_
   * Тип аутентификации – _PSK;_
   * PSK – _укажите PSK-ключ, который будет использоваться для подключения;_
   * Ключ идентификации – _любой;_
   * Домашние локальные сети – _выберите локальную сеть Ideco UTM, которая будет видна из подсети Kerio Control;_
   * Удалённые локальные сети – _укажите локальную сеть Kerio Control, которая будет видна из подсети Ideco UTM._
3. Сохраните созданное подключение, затем нажмите на кнопку **Включить**.
4. На Ideco UTM в папке **`/etc/strongswan/autogen/`** будут сгенерированы два конфигурационных файла. Необходимо перейти в консоль и открыть на редактирование файл вида **`device_<номер>.peer`**
5. Из этого файла необходимо скопировать значение строки **`rightid`** \(примерный вид – `@#746573745f70736b`\). В дальнейшем это значение потребуется прописать на Kerio Control.
6. Настройка завершена, теперь переходим к настройке Kerio Control.

## Настройка Kerio Control

1. По умолчанию, Kerio Control использует IKEv1 для создания подключений к сторонним устройствам. Включить IKEv2 можно через консоль. Для этого нужно:

* Подключиться к Kerio Control по SSH;
* Перейти в папку **`/var/winroute;`**
* Открыть на редактирование файл `winroute.cfg;`
* В нём найти раздел, начинающийся с **`<table name="Firewall">;`**
* В этом разделе найти строку `<variable name="IKEVersion">ikev1` и изменить в ней ikev1 на ikev2;
* После этого желательно перезагрузить сервер и убедиться, что изменения в настройках сохранились.

2. В разделе **Правила трафика** необходимо разрешить трафик VPN-служб.

3. Далее перейти в раздел **Интерфейсы** и нажать на **Добавить**. В раскрывшемся списке выбрать **VPN-туннель...**

4. Откроется окно создания подключения. В нём выбрать:

* Тип – IPsec;
* Имя – любое;
* Активировать **Включить данный туннель;**
* Выбрать тип **Активное** и в поле под ним прописать IP-адрес внешнего интерфейса Ideco UTM, который будет использоваться для подключения;
* Выбрать **Предопределённый ключ** и ввести PSK-ключ, который будет использоваться для подключения;
* Локальный и внешний ИД: в оба поля нужно вставить значение строки rightid, которое копировали в шаге 5 настройки Ideco UTM;
* Под заданием шифров нажать на **Изменить**. Задать шифры как на скриншоте:

![](../../../.gitbook/assets/17072231%20%281%29.png)

* Пример итоговых настроек на скриншоте ниже:

![](../../../.gitbook/assets/17072230%20%281%29.png)

* Перейти в раздел **Удалённые сети**, нажать на **Добавить** и ввести сведения о локальной сети Ideco UTM, которая будет видна из подсети Kerio Control;
* Затем в разделе **Локальные сети** либо нажать на **Использовать автоматически определённые локальные сети**, либо настроить сети, которые будут видны из подсети Ideco UTM вручную, как на предыдущем шаге.

5. Настройка завершена. После добавление нового интерфейса нужно нажать на **Применить**. После чего подключение должно успешно установиться, информация об этом отображается в таблице:

![](../../../.gitbook/assets/17072232.png)

{% hint style="info" %}
В случае возникновения проблем в первую очередь обратите внимание на настройки файрвола Kerio Control.
{% endhint %}

