# Подключение pfSense к Ideco UTM по IPsec

По шагам ниже можно объединить сети pfSense и Ideco UTM по IPsec с
использованием PSK.

<div>

<div>

Объединяемые локальные сети не должны пересекаться\!

</div>

</div>

## Настройка Ideco UTM

1.   В веб-интерфейсе Ideco UTM откройте вкладку **Сервисы – IPsec –
    Устройства**

2.  Добавьте новое подключение:
    
      - Название – *любое*
    
      - Тип – *входящее*
    
      - Тип аутентификации – *PSK*
    
      - PSK – *укажите PSK-ключ, который будет использоваться для
        подключения*
    
      - Ключ идентификации – *любой*
    
      - Домашние локальные сети – *выберите локальную сеть Ideco UTM,
        которая будет видна из подсети pfSense*
    
      - Удалённые локальные сети – *укажите локальную сеть pfSense,
        которая будет видна из подсети Ideco UTM*

3.  Сохраните созданное подключение, затем нажмите на кнопку "Включить"

4.  На Ideco UTM в папке **`/etc/strongswan/autogen/`** будут
    сгенерированы два конфигурационных файла. Необходимо
    перейти в консоль и открыть на редактирование файл вида
    **`device_<номер>.peer`**

5.  Из этого файла необходимо скопировать значение строки
    **`rightid`** (примерный вид – `@#746573745f70736b`). В дальнейшем
    это значение потребуется прописать на pfSense.

6.  Настройка завершена, теперь переходим к настройке pfSense.

## Настройка pfSense

1.  В веб-интерфейсе pfSense перейдите на вкладку **VPN – IPsec –
    Tunnels**

2.  Добавьте новое подключение:
    
      - Key Exchange version – *IKEv2*
    
      - Internet Protocol – *IPv4*
    
      - Interface – *выберите внешний интерфейс pfSense, который будет
        использоваться для подключения к Ideco UTM)*
    
      - Remote Gateway – *IP внешнего интерфейса Ideco UTM*
    
      - Description – *любое*
    
      - Authentication Method – *Mutual PSK*
    
      - My identifier и Peer identifier – *сюда вставьте значение строки
        rightid на Ideco UTM (см. шаг 5 в настройке Ideco UTM)*
    
      - Pre-Shared Key – *вставьте PSK-ключ, который ранее прописывали
        на Ideco UTM*
    
      - Encryption Algorithm – *представлены на скриншоте ниже:*
        
        ![](attachments/16842773/16842772.png)
    
      - Все остальные значения можно оставить по умолчанию

3.  Сохраните подключение

4.  Нажмите на кнопку Show Phase 2 Entries и добавьте новую Phase 2

5.  Здесь укажите:
    
      - Local Network – *локальную сеть pfSense, которая будет доступна
        из подсети Ideco UTM*
      - Remote Network – *локальную сеть Ideco UTM, которая будет
        доступна из подсети pfSense*
      - Все остальные значения можно оставить по умолчанию

6.  Сохраняем подключение

7.  Затем нужно разрешить хождение трафика между локальными сетями
    pfSense и Ideco UTM в файрволе pfSense (переходим на вкладку
    **Firewall – Rules – IPsec** и создаём два правила, разрешающее
    хождение трафика между локальными сетями Ideco UTM и pfSense)

8.  Также обратите внимание на раздел фарйвола WAN – по умолчанию в нём
    запрещён входящий трафик из "серых" подсетей, поэтому необходимо
    снять это ограничение

9.  Теперь переходим на вкладку **Status – IPsec** (там должно появится
    созданное нами подключение), нажимаем на кнопку Connect VPN

10. Настройка завершена, соединение должно успешно установиться

Если соединение установить не удалось, а настройки файрвола pfSense
сделаны верно, следует пересоздать соединение на UTM, указав в поле
"Ключ идентификации" то значение, которое мы указали в My identifier и
Peer identifier у pfSense, и попробовать подключиться ещё раз. На
стороне pfSense никаких изменений вносить не требуется.

<div class="pageSectionHeader">

## Attachments:

</div>

<div class="greybox" data-align="left">

![](images/icons/bullet_blue.gif)
[encryption.png](attachments/16842773/16842772.png) (image/png)  

</div>
