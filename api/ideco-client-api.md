# Управление Ideco Client

## Настройка авторизации через Ideco Client

<details>
<summary>Получение настроек авторизации</summary>

```
GET /agent_backend/wireguard/state
```

**Ответ на успешный запрос:**

```json5
{
    "enabled": "boolean"
}
```

`enabled` - включена или выключена авторизация через Ideco Client.

</details>

<details>
<summary>Изменение настроек авторизации</summary>

```
PUT /agent_backend/wireguard/state
```

**Json-тело запроса:**

```json5
{
    "enabled": "boolean"
}
```

`enabled` - включена или выключена авторизация через Ideco Client.

**Ответ на успешный запрос:** 200 OK

</details>

## Настройки авторизации Ideco Client

<details>
<summary>Получение настроек авторизации Ideco Client</summary>

```
GET /agent_backend/wireguard/setting
```

**Ответ на успешный запрос:**

```json5
{
    "auth_domain": "string",
    "local_tunnel": "boolean"
}
```

* `auth_domain` - домен/IP-адрес, в котором будет происходить аутентификация;
* `local_tunnel` - включено или выключено построение туннеля WireGuard для подключений из локальных сетей.

</details>

<details>
<summary>Изменение настроек авторизации Ideco Client</summary>

```
PUT /agent_backend/wireguard/setting
```

**Json-тело запроса:**

```json5
{
    "auth_domain": "string",
    "local_tunnel": "boolean"
}
```

* `auth_domain` - домен/IP-адрес, в котором будет происходить аутентификация;
* `local_tunnel` - включено или выключено построение туннеля WireGuard для подключений из локальных сетей.

**Ответ на успешный запрос:** 200 OK

</details>

## Протокол подключения и авторизации Ideco Client

Сообщения WebSocket с типом TEXT от агента принимаются бэкендом и после обработки посылается ответное WS сообщение с типом TEXT, за исключение обмена информацией для ZTNA. Принимаемые и ответные сообщения содержат информацию в формате JSON.

Процесс подключения и авторизации должен проходить в несколько этапов обмена сообщениями:

### 1\. Подключение и запрос соответсвия версии Ideco Client

После установления соединения через WebSocket агент должен сделать запрос со своей версией и типом операционной системы, чтобы Ideco NGFW удостоверился в соответствии версии агента и при необходимости обновления передал агенту ссылку на скачивание новой версии.

Если версия агента не совпадает с той что требует NGFW, то агент должен скачать дистрибутив, разорвать соединение и установить новое уже с актуальной версии.

<details>
<summary>Json-тело запроса</summary>

```json5
{
    "type": "version",
    "major": "integer",
    "minor": "integer",
    "build": "integer",
    "os": "windows" | "macos" | "linux"
}
```

* `type` - команда;
* `major` - мажорная версия;
* `minor` - минорная версия;
* `build` - версия сборки;
* `os` - тип ОС агента.

</details>

<details>
<summary>Ответ на успешный запрос</summary>

```json5
{
    "type": "update",
    "need_update": "boolean",
    "download_url": "string"|null,
    "version": {
        "major": "integer",
        "minor": "integer",
        "build": "integer",
        "os": "windows" | "macos" | "linux"
    }
}
```

* `need_update` - требование обновления: `true` - необходимо, `false` - не требуется;
* `download_url` - путь для скачивания дистрибутива актуальной версии агента для требуемой ОС (пример: ":14765/IdecoAgent_x64.msi"). Если обновление не требуется, то значение поля будет `null`;
* `version` - версия дистрибутива Ideco Client на Ideco NGFW. Значения полей аналогичны описанным в запросе. Если обновление не требуется, поле будет отсутствовать.

</details>

### 2\. Авторизация

Если версия Ideco Client совпадает с требуемой Ideco NGFW, то агенту будет разрешено иницировать авторизацию на NGFW и при необходмости установить туннельное соединение WireGuard, если подключение идет с внешних сетей. Доступно два варианта авторизации: по логину и паролю или через SSO.

<details>
<summary>Авторизация по логину и паролю</summary>

**Json-тело запроса:**

```json5
{
    "type": "authorize",
    "login": "string",
    "password": "string"
}
```

* `login` - логин пользователя, может также содержать домен;
* `password` - пароль.

**Ответ на успешный запрос:**

```json5
{
    "type": "auth_state",
    "authorized": "boolean",
    "need_tunnel": "boolean",
    "timeout": "int",
    "message": "string"
}
```

* `authorized` - состояние авторизации: `true` - авторизован, `false` - не авторизован;
* `need_tunnel` - требуется ли установить туннель WireGuard;
* `timeout` - время до повторной попытки авторизации в секундах в случае возникновения ошибок в процессе авторизации. Если повторная попытка авторизации не требуется, то значение будет равно 0;
* `message` - сообщение о состоянии авторизации.

</details>

<details>
<summary>Авторизация с использованием SSO</summary>

**Авторизация SSO возможна только с локальных сетей Ideco NGFW. При попытке авторизации с внешних сетей сразу произойдет отказ.**

Авторизация проходит в несколько обменов пакетами:

1\. Запрос на доступность SSO:

**Json-тело запроса:**

```json5
{
    "type": "sso",
    "token": null,
    "session_token": null,
    "domain": "string"
}
```

* `token` - SSO токен Kerberos или NTLM, для данного запроса должен быть `null`;
* `session_token` - идентификатор сессии авторизации, для данного запроса должен быть `null`;
* `domain` - домен ActiveDirectory.

**Ответ на успешный запрос:**

```json5
{
    "type": "sso",
    "status": "not_authorized|challenge",
    "session_token": null,
    "access_token": null,
    "computer_name": "string",
    "error": "string"|null
}
```

* `status` - статус авторизации для домена: `not_authorized` - недоступна; `challenge` - доступна, необходимо передать токен для авторизации;
* `session_token` - токен сессии авторизации;
* `access_token` - ответный токен доступа SSO;
* `computer_name` - имя сервера контроллера домена. Если `status = "not_authorized"`, поле будет отсутствовать;
* `error` - сообщение об ошибке/причине недоступности SSO авторизации для домена: `null, status = "challenge"`.

2\. Запрос на авторизацию SSO:

**Json-тело запроса:**

```json5
{
    "type": "sso",
    "token": "string",
    "session_token": "string" | "null",
    "domain": "string"
}
```

* `token` - должнен содержать соответствующий токен;
* `session_token` -  идентификатор сессии, если это вторая или более итерация запроса на авторизацию;
* `domain` - домен ActiveDirectory.

Если авторизация SSO еще выполняется и нужно отправить еще один запрос на авторизацию SSO (повторить этот же этап обмена пакетами), ответ на успешный запрос:

```json5
{
    "type": "sso",
    "status": "in_progress",
    "session_token": "string",
    "access_token": "string",
    "error": null
}
```

Назначение полей аналогично первому ответу (см. выше), только session_token и access_token содержат соответствующие значения.

Если авторизациая завершилась, то в ответ NGFW отправит:

```json5
{
    "type": "auth_state",
    "authorized": "boolean",
    "need_tunnel": "boolean",
    "timeout": "int",
    "message": "string"
}
```

* `authorized` - состояние авторизации: `true` - авторизован, `false` - не авторизован;
* `need_tunnel` - требуется ли установить туннель WireGuard;
* `timeout` - время до повторной попытки авторизации в секундах в случае возникновения ошибок в процессе авторизации. Если повторная попытка авторизации не требуется, то значение будет равно 0;
* `message` - сообщение о состоянии авторизации.

</details>

## Протокол обмена информацией для ZTNA

<details>
<summary>Запрос Ideco NGFW на получение информации от Ideco Client</summary>

Ideco NGFW отправляет запрос на сбор информации при подключении Ideco Client. В этом запросе указаны списки параметров, которые необходимо собрать, а также интервал, с которым Client должен собирать данные.

**Json-тело запроса о сборе информации:**

```json5
{
    "type": "ztna",
    "period": "integer",
    "test_list": [
      "os_type|os_version|domain|kb_list|av_active|av_name|av_version|av_update|av_scan|fw_active|fw_name|fw_version|processes|services|registry",
    ],
    "kb_list": ["string"],
    "proc_list": ["string"],
    "service_list": ["string"],
    "reg_key_list": ["string"],
} 
```

* `type` - тип запроса ("ztna");
* `period` - интервал в минутах, через который Ideco Client должен собирать и передавать информацию. Если указан интервал, равный 0 - проверка и передача собранных параметров выполняется однократно;
* `test_list` - список ключевых слов, определяющий необходимость выполнения проверок заданного типа:
  * `os_type` - проверка типа операционной системы;
  * `os_version` - проверка версии операционной системы;
  * `domain` - проверка включенности в домен;
  * `kb_list` - проверка обновлений операционной системы (в объеме списка, указанного в параметре `kb_list`);
  * `av_active` - проверка, запущен ли антивирус;
  * `av_name` - проверка типа установленного антивируса;
  * `av_version` - проверка версии установленного антивируса;
  * `av_update` - проверка даты последнего обновления баз антивируса;
  * `av_scan` - проверка даты последнего антивирусного сканирования на наличие угроз;
  * `fw_active` - проверка, запущен ли межсетевой экран;
  * `fw_name` - проверка типа установленного межсетевого экрана;
  * `fw_version` - проверка версии установленного межсетевого экрана;
  * `processes` - проверка запущенных процессов (в объеме списка, указанного в параметре `proc_list`);
  * `services` - проверка списка запущенных служб (в объеме списка, указанного в параметре `service_list`);
  * `registry` - проверка наличия и значения ключей реестра Windows (в объеме списка, указанного в параметре `key_list`);
* `kb_list` - список обновлений для выполнения проверки (может быть пустым, если проверка не требуется);
* `proc_list` - список процессов для выполнения проверки (может быть пустым, если проверка не требуется);
* `service_list` - список служб для выполнения проверки (может быть пустым, если проверка не требуется);
* `reg_key_list`: - список ключей реестра для выполнения проверки: путь/имя (может быть пустым, если проверка не требуется).

</details>

<details>
<summary>Ответ Ideco Client с информацией о выполнении проверок</summary>

Ideco Client отправляет ответ с собранной информацией об устройстве в ответ на запрос проверок. Через определенный промежуток времени Ideco Client снова собирает информацию. Если с момента последней проверки ни один из параметров не изменился, то на NGFW ничего не отправляется.

Если хотя бы один из параметров изменился с момента последнего сбора информации, то Ideco Client отправляет обновленный ответ с собранной информацией об устройстве (полный набор запрошенных сведений) и повторяет проверку через указанный интервал времени.

**Формат ответа с собраной в результате проверок информацией:**

```json5
{
    "type": "ztna",
    "node_name": "string",
    "operation_system": {
      "type": "string",  // (может быть пустой строкой)
      "version": "string",  // (может быть пустой строкой)
      "domain": "string"  // (может быть пустой строкой)
    },  // (может отсутствовать)
    "kb_list": ["string"],  // (может отсутствовать)
    "antivirus": [
      {
        "active": "boolean",
        "name": "string",  // (может быть пустой строкой)
        "version": "string",  // (может быть пустой строкой)
        "last_update": "integer|null",
        "last_scan": "integer|null",
      },
    ],  // (может отсутствовать или быть пустым списком)
    "firewall": [
      {
        "active": "boolean",
        "name": "string",  // (может быть пустой строкой)
        "version": "string",  // (может быть пустой строкой)
      },
    ],  // (может отсутствовать или быть пустым списком)
    "proc_list": ["string"],  // (может отсутствовать или быть пустым списком)
    "service_list": ["string"],  // (может отсутствовать или быть пустым списком)
    "reg_key_list": [
      {
        "key": "string",
        "value": "string",
      }
    ],  // (может отсутствовать или быть пустым списком)
}
```

* `type` - тип сообщения ("ztna");
* `node_name` - имя узла (собирается для отчетности, но не проходит никаких проверок);
* `operation_system` - результаты проверки ОС. Может отсутствовать, если в списке запрошенных проверок (поле `test_list`) отсутствуют ключевые слова `os_type`, `os_version`, `domain`:
  * `type` - тип операционной системы: "Windows", "Linux", "MacOS" (пустая строка, если проверка не выполнялась);
  * `version` - редакция и версия операционной системы (пустая строка, если проверка не выполнялась);
  * `domain` - имя домена (если проверка не выполнялась и в случае отсутствия домена - пустая строка);
* `kb_list` - результаты проверки установленных обновлений KB для Windows. Может отсутствовать, если в списке запрошенных проверок (поле `test_list`) отсутствует ключевое слово `kb_list`;
* `antivirus` - результаты проверок Антивируса. Может отсутствовать, если в списке запрошенных проверок (поле `test_list`);
* `antivirus` - cписок результатов проверок Антивирусов (по числу установленных антивирусных пакетов). Может отсутствовать, если в списке запрошенных проверок (поле `test_list`) отсутствуют ключевые слова `av_active`, `av_name`, `av_version`, `av_update`, `av_scan`:
  * `active` - запущен или нет: `True`, `False`;
  * `name` - наименование продукта (пустая строка, если проверка не выполнялась);
  * `version` - версия продукта (пустая строка, если проверка не выполнялась);
  * `last_update_age` - количество полных дней, прошедших с последнего обновления баз (`null`, если проверка не выполнялась);
  * `last_scan_age` - количество полных дней, прошедших с последнего сканирования (`null`, если проверка не выполнялась или не проводилось сканирование);
* `firewall` - результаты проверок межсетевого экрана. Может отсутствовать, если в списке запрошенных проверок (поле `test_list`);
  * `last_update` - количество полных дней, прошедших с последнего обновления баз (`null`, если проверка не выполнялась);
  * `last_scan` - количество полных дней, прошедших с последнего сканирования (`null`, если проверка не выполнялась или не проводилось сканирование);
* `firewall` - cписок результатов проверок межсетевых экранов (по числу установленных продуктов). Может отсутствовать, если в списке запрошенных проверок (поле `test_list`) отсутствуют ключевые слова `fw_active`, `fw_name`, `fw_version`:
  * `active` - активен или нет: `True`, `False`;
  * `name` - наименование продукта (пустая строка, если проверка не выполнялась);
  * `version` - версия продукта (пустая строка, если проверка не выполнялась);
* `proc_list` - cписок найденных процессов. Может отсутствовать, если в списке запрошенных проверок (поле `test_list`) отсутствует ключевое слово `processes`;
* `service_list` - cписок найденных служб Windows. Может отсутствовать, если в списке запрошенных проверок (поле `test_list`) отсутствует ключевое слово `services`;
* `reg_key_list` - cписок найденных ключей реестра. Может отсутствовать, если в списке запрошенных проверок (поле `test_list`) отсутствует ключевое слово `registry`;
  * `key` - ключ реестра (путь/имя);
  * `value` - значение параметра.
  
</details>